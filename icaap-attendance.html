<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Icaap Attendance Tracking - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Plus+Jakarta+Sans:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --border-color: #e1dfdd;
            --section-sidebar-width: 60px;
        }
        body {
            background-color: #f3f2f1;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .notebook-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background: #fff;
        }
        /* Vertical Sidebar */
        .section-sidebar {
            width: var(--section-sidebar-width);
            background: #1e3a63;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: inset -1px 0 0 rgba(0,0,0,0.1);
        }
        .section-icon {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 10pt;
            transition: all 0.2s ease;
            text-decoration: none;
            opacity: 0.7;
        }
        .section-icon:hover {
            background: rgba(255,255,255,0.1);
            opacity: 1;
            transform: scale(1.05);
        }
        .section-icon.active {
            background: rgba(255,255,255,0.15);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 1;
        }
        .section-icon.logout-icon {
            margin-top: auto;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .section-icon.logout-icon:hover {
            opacity: 1;
            color: #ffcdd2;
        }

        .notebook-main {
            flex-grow: 1;
            background: #fff;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
        }
        .notebook-page {
            width: 100%;
            margin: 0 auto;
            padding: 10px 20px !important;
            background: #fff;
            box-sizing: border-box;
            min-height: 100%;
        }

        .page-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #e1dfdd;
            padding-bottom: 10px;
        }
        .page-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 10pt;
            color: var(--header-blue);
            margin: 0 0 15px 0;
            letter-spacing: 3px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .date-range-display {
            font-size: 10pt;
            color: #605e5c;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nav-btn {
            background: #fff;
            border: 1px solid #d2d0ce;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'Segoe UI', sans-serif;
            font-size: 10pt;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.2s;
            color: #323130;
        }
        .nav-btn:hover {
            background: #f3f2f1;
            border-color: #a19f9d;
        }

        .tracking-links-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .tracking-link-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #f3f2f1;
            color: #323130;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 10pt;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid #e1dfdd;
        }
        .tracking-link-pill:hover {
            background-color: #edebe9;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #e1dfdd;
            border-radius: 4px;
            margin-top: 20px;
        }
        .tracking-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 10pt;
        }
        .tracking-table th, .tracking-table td {
            border: 1px solid #eee;
            padding: 5px 8px;
            text-align: center;
        }
        .header-row th {
            background-color: #f8f9fa;
            color: #323130;
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10pt;
            border-bottom: 2px solid #e1dfdd;
        }
        .employee-col {
            font-weight: 600;
            text-align: left !important;
            min-width: 160px;
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 5;
            border-right: 2px solid #e1dfdd !important;
            font-family: 'Segoe UI', sans-serif;
        }
        .header-row .employee-col {
            background-color: #f8f9fa;
            z-index: 6;
        }
        .attendance-select {
            font-family: 'Coming Soon', cursive;
            font-size: 1.1rem;
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            cursor: pointer;
            text-align: center;
            padding: 4px;
            border-radius: 2px;
        }
        .attendance-select:hover {
            border-color: #e1dfdd;
            background: #fafafa;
        }
        .attendance-select:focus {
            outline: none;
            border-color: var(--header-blue);
            background: #fff;
            box-shadow: 0 0 0 1px var(--header-blue);
        }
        
        .save-status {
            font-size: 10pt;
            color: #a19f9d;
            margin-top: 10px;
            text-align: center;
            height: 15px;
        }
    </style>
</head>
<body>
    <div style="padding: 20px;">
        <div class="page-header">
            <h1 class="page-title">Icaap Attendance Tracking</h1>
            <div id="week-nav" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                <button class="nav-btn" onclick="changeWeek(-1)">‚Üê PREVIOUS WEEK</button>
                <div id="date-range-display" class="date-range-display">Loading...</div>
                <button class="nav-btn" onclick="changeWeek(1)">NEXT WEEK ‚Üí</button>
            </div>
            <div class="tracking-links-container">
                <a href="icaap.html" class="tracking-link-pill">
                    <span>üìù</span> Icaap Notes
                </a>
                <a href="icaap-tracking.html" class="tracking-link-pill">
                    <span>üìÖ</span> Icaap Tracking Log
                </a>
            </div>
            <div id="save-status" class="save-status">All changes saved</div>
        </div>
        
        <div class="table-container">
            <table class="tracking-table">
                <thead id="table-head">
                    <!-- Headings will be injected here -->
                </thead>
                <tbody id="tracking-body">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const employees = [
            "Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin",
            "Rene Gaudet", "Steve Maccarone", "Zina Dixon"
        ];
        const options = ["", "Cochren", "Beaudry", "Illness", "Kin Care", "Personal Necessity", "Vacation", "Bereavement"];
        
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        let currentStartDate = dateParam ? parseLocalDate(dateParam) : new Date(); // Default to today

        // Adjust to Monday of the week
        const day = currentStartDate.getDay();
        const diff = currentStartDate.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
        currentStartDate.setDate(diff);

        // Determine fiscal year start (July)
        function getPersistenceKey() {
            const sy = currentStartDate.getMonth() < 6 ? currentStartDate.getFullYear() - 1 : currentStartDate.getFullYear();
            return `icaap-attendance-data-${sy}`;
        }
        
        function getWeekdaysForCurrentWeek() {
            const days = [];
            const tempDate = new Date(currentStartDate);
            for (let i = 0; i < 5; i++) {
                days.push(new Date(tempDate));
                tempDate.setDate(tempDate.getDate() + 1);
            }
            return days;
        }

        function renderTable() {
            const weekdays = getWeekdaysForCurrentWeek();
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('tracking-body');
            const rangeDisplay = document.getElementById('date-range-display');

            const lastDay = new Date(weekdays[4]);
            const startStr = weekdays[0].toISOString().split('T')[0];
            const endStr = lastDay.toISOString().split('T')[0];
            rangeDisplay.innerText = `${formatDateMMM(startStr)} - ${formatDateMMM(endStr)}`;
            
            // Header
            let headHtml = `<tr class="header-row"><th class="employee-col">Employee Name</th>`;
            weekdays.forEach(d => {
                const dayStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                headHtml += `<th>${dayName}<br>${formatDateMMM(dayStr)}</th>`;
            });
            headHtml += `</tr>`;
            thead.innerHTML = headHtml;

            // Rows
            tbody.innerHTML = '';
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                let rowHtml = `<td class="employee-col">${emp}</td>`;
                weekdays.forEach(d => {
                    const dateKey = d.toISOString().split('T')[0];
                    const fieldId = `attn-${emp}-${dateKey}`;
                    rowHtml += `<td>
                        <select class="attendance-select" data-field="${fieldId}" onchange="handleSave(this)">
                            ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </td>`;
                });
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        async function loadData() {
            const data = await fetchPlannerData(getPersistenceKey(), 366); 
            data.forEach(item => {
                const el = document.querySelector(`[data-field="${item.field_id}"]`);
                if (el) el.value = item.content;
            });
        }

        async function handleSave(select) {
            const fieldId = select.dataset.field;
            const content = select.value;
            const status = document.getElementById('save-status');
            status.innerText = 'Saving...';
            
            const success = await savePlannerData(getPersistenceKey(), fieldId, content);
            status.innerText = success ? 'All changes saved' : 'Error saving';
            if (success) {
                setTimeout(() => { if(status.innerText === 'All changes saved') status.innerText = ''; }, 2000);
            }
        }

        async function changeWeek(delta) {
            const container = document.querySelector('.notebook-main');
            if (container) {
                container.classList.remove('flip-in');
                container.classList.add('flip-out');
                await new Promise(r => setTimeout(r, 600));
                
                currentStartDate.setDate(currentStartDate.getDate() + (delta * 7));
                const dateStr = currentStartDate.toISOString().split('T')[0];
                const newUrl = window.location.pathname + '?date=' + dateStr;
                window.history.pushState({ date: dateStr }, '', newUrl);
                updateNavigationLinks(currentStartDate);
                await renderTable();
                await loadData();
                
                container.classList.remove('flip-out');
                container.classList.add('flip-in');
            } else {
                currentStartDate.setDate(currentStartDate.getDate() + (delta * 7));
                updateNavigationLinks(currentStartDate);
                renderTable();
                loadData();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            updateNavigationLinks(currentStartDate);
            renderTable();
            await loadData();
        });
    </script>
</body>
</html>
