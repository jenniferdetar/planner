<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCAAP Tracking - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --table-green: #1b5e20;
            --border-color: #333;
        }
        body {
            font-family: 'Coming Soon', cursive;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        .global-header {
            background: #00326b;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
            align-items: center;
        }
        .nav-link {
            text-decoration: none;
            color: #ffca38;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            border: 2px solid #ffca38;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .container {
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }
        .notebook-page {
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-width: max-content;
        }
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .page-title {
            color: var(--header-blue);
            font-size: 1.5rem;
            margin: 0;
            letter-spacing: 2px;
            text-transform: capitalize;
            border-bottom: none;
            padding-bottom: 0;
        }
        .tracking-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 11px;
            border: 1px solid var(--border-color);
        }
        .tracking-table th, .tracking-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }
        .tracking-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .header-row {
            background-color: var(--table-green);
            color: white;
        }
        .month-header {
            min-width: 150px;
        }
        .employee-col {
            font-weight: bold;
            text-align: left;
            min-width: 150px;
            position: sticky;
            left: 0;
            border-right: 2px solid var(--border-color);
            z-index: 5;
            background-color: inherit;
        }
        .tracking-table tbody tr:nth-child(odd) .employee-col {
            background-color: #fff;
        }
        .tracking-table tbody tr:nth-child(even) .employee-col {
            background-color: #f9f9f9;
        }
        .header-row .employee-col {
            background-color: var(--table-green);
            z-index: 10;
        }
        .sub-header {
            font-size: 9px;
            background-color: #e8f5e9;
        }
        .editable-cell {
            outline: none;
            min-height: 20px;
            background-color: #fff;
        }
        .editable-cell:focus {
            background-color: #fffde7;
            box-shadow: inset 0 0 0 2px var(--header-blue);
        }
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: #666;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <header class="global-header">
        <a href="index.html" class="nav-link">Home</a>
        <a href="csea.html" class="nav-link">CSEA</a>
        <a href="financial.html" class="nav-link">Financial</a>
        <a href="hoa.html" class="nav-link">HOA</a>
        <a href="icaap.html" class="nav-link">iCAAP</a>
        <a href="planning.html" class="nav-link">Planning</a>
        <a href="mantra.html" class="nav-link">Mantra</a>
    </header>
    <div id="save-status" class="save-status">All changes saved</div>
    <div class="container">
        <div class="notebook-page">
            <div class="page-header">
                <h1 class="page-title">iCAAP Tracking Log</h1>
                <div style="margin-top: 10px;">
                    <a href="icaap.html" class="nav-link" style="color: var(--header-blue); border-color: var(--header-blue); display: inline-flex;">
                        <span>üìù</span> iCAAP Notes
                    </a>
                </div>
            </div>
            <table class="tracking-table">
                <thead>
                    <tr class="header-row">
                        <script>
                            const months = [
                                'July 2025', 'August 2025', 'September 2025', 'October 2025', 
                                'November 2025', 'December 2025', 'January 2026', 'February 2026', 
                                'March 2026', 'April 2026', 'May 2026', 'June 2026'
                            ];
                            document.write(`<th rowspan="2" class="employee-col">Employee Name</th>`);
                            months.forEach(month => {
                                document.write(`<th colspan="3" class="month-header">${month}</th>`);
                            });
                            document.write(`<th rowspan="2" style="background-color: #1b5e20; color: white;">Total Hours</th>`);
                        </script>
                    </tr>
                    <tr class="sub-header">
                        <script>
                            months.forEach(month => {
                                document.write(`<th>Paylog Sub.</th><th>Hours</th><th>Approval</th>`);
                            });
                        </script>
                    </tr>
                </thead>
                <tbody id="tracking-body">
                    <script>
                        const employees = [
                            "Adalid Sanchez Rodriguez", "Adan Saucedo", "Adrian Irvine", "Adriana Gomez",
                            "Adriana Ojeda", "Agnes Lewis", "Alberto Solorzano", "Alexander Aston",
                            "Alexis Contreras", "Alice Hilal", "Alicia Cerna", "Aline Millan",
                            "Alyson Han", "Amber Mastroianni", "Amber Trudgeon", "Amber Wilton",
                            "Ameel Noos", "Amparo Martin", "Ana Guevara", "Ancelmo Ramos",
                            "Andrea Chagoya", "Andrea Douglas", "Andreina Morales", "Angel Gamino",
                            "Angela Lopez", "Anna Quezada", "Anthony Bernard", "Anthony Morales",
                            "Anthony Zarate", "Antoinette Matiga", "Araksya Manukyan", "Avia Greene-Vanburen",
                            "Aya Shigenaga", "Baharak Saadat Beheshti", "Barbara Stoliker", "Barry Blisten",
                            "Beatris Segura", "Bennett Winter", "Bernice Grewell-Godinez", "Beverly Junio-Magee",
                            "Bienvenido Pineda", "Brigette Pena", "Carmen Fuentes", "Cassondra Holt Hightower",
                            "Cecille Basilio", "Charles Izuakor", "Cherie Lebron", "Chevon Booker",
                            "Chinedu Ezeh", "Christa Mcmullin", "Christina Clark", "Christina Silva",
                            "Christina Sithole", "Christine Choi", "Christopher Linares", "Claire Daigle",
                            "Claudia Franco", "Connie Gracia-Barraza", "Crystal Cohen", "Crystal Mendez",
                            "Crystal Rivera", "Cynthia Barrilleaux", "Cynthia Bitterman", "Cynthia Timm",
                            "D.M. Grant", "Dalese Hardin", "Dana Fikes", "Daniel Saldana",
                            "Danielle O'Connor", "David Hadjichristodoulou", "Dawn Sebastian", "Dawnise Francisco",
                            "Deanna Baldwin", "Debora Wechsler", "Deborah Francois", "Diana Olivas",
                            "Dominique Harris", "Dora Marquez", "Douglas Klaif", "Douglas Reisgen",
                            "Dulce Bacon", "Eberardo Rodriguez", "Edith Braswell-Grant", "Edith Janec",
                            "Efren Rodriguez", "Eileen Alcorn", "Eimi Miller", "Elisabeth Mullins Medina",
                            "Elizabeth Chavez", "Elizabeth Elizalde", "Elizabeth Romero", "Emilee Velazco Franco",
                            "Emily Wassler", "Emir Gonzalez", "Enas Makar", "Eric Hopson",
                            "Erica Pan", "Erica Sanchez", "Erika Paz", "Erin Mettlen",
                            "Ester Yang", "Evelyn Mcfarlane", "Farhad Mahmud", "Frances Morales",
                            "Freshta Sidiqi", "Gavriela Trujillo", "Gene Dean", "Genesis Aguirre",
                            "Gina Go", "Gladys Barbosa", "Glenda Tamay", "Guillermo Diaz",
                            "Gustavo Lopez", "Hamilton Gernon-Wyatt", "Hector Martinez", "Hina Ahmad",
                            "Ida Quijada", "Iliana Quintero", "Indira Ortiz", "Irma Griffiths",
                            "Irma Salas", "Irma Torres", "Isidro Castillo", "Ivy Grace Thorne",
                            "Jacqueline Cruz", "Jacqueline Palacios", "Jakeisha Sanders", "Jamall Farr",
                            "Janet Frnzyan", "Janet Ledesma", "Jasmin Segovia", "Javier Ponce Garcia",
                            "Jeanine Flier", "Jeanne Garcia-Armstrong", "Jeen Yu", "Jehisol Urbina",
                            "Jennifer Lopez", "Jennifer Washington", "Jenny Peterson", "Jereme Stark",
                            "Jhun De Guzman", "Jiabei Li", "Jittima Bouillot", "John Kuykendall",
                            "Jordan Baldry", "Jordan Gonzalez", "Jorge Torres", "Jose Alvarenga",
                            "Jose Hernandez", "Jose Romero", "Joseph Thomas", "Joseph Zeccola",
                            "Joshua Griffiths", "Joy Kasper", "Juan Catalan", "Juan Pina",
                            "Julia Calamandrei", "Julian Mendez", "Julianne Fassett", "Julie Ann Resurreccion",
                            "Julie Sornberger", "Karen Caruso", "Karen Siercke Noriega", "Karina Maravilla",
                            "Karsina Gaither", "Kelsie Hogen", "Kelvin Means", "Kerry Shimizu",
                            "Kevin Seegan", "Kimberly Rabas", "Kionna Hawkins", "Kristalyn Smith",
                            "Kristine Adams", "Kristy Beaudry", "La Tresha Glasco", "Ladan Dejam",
                            "Lailani Joy Gonzaga", "Lanette Black", "Laura Incelli", "Laveda Harris",
                            "Lawrence Ramos", "Leslie Anderson", "Leslie Black", "Leslie Perez",
                            "Leslie Zamora", "Leticia Gudino", "Leticia Martinez", "Liberty Amos",
                            "Lila Rosas Madrigal", "Liliana Amezcua", "Liliana Jauregui-George", "Liliana Martinez",
                            "Lilit Akilian", "Linda Hoang", "Linda Santana", "Linda Taylor",
                            "Lisa Darbidian", "Lisa Harvey", "Lisa Marks", "Louise Cummings",
                            "Luciano Latini", "Lucrecia Yescas Luna", "Ma Joanna Razon", "Ma Teresa Aki",
                            "Maeli Montecinos", "Maikai Finnell", "Malika Ferrell", "Malina Rios",
                            "Mandana Saidi", "Maria Aldave Cabrera", "Maria Hernandez", "Maria Pinto",
                            "Maria Zamora", "Marianne Valencia", "Marie Bennett", "Marissa Gilmore",
                            "Marites Felicilda", "Mark Todd", "Marla Pizzuto", "Marlene Yu",
                            "Marta Martin", "Mary Jane Opoku", "Matthew Miller", "Mayra Alcantar",
                            "Mayra Rodarte-Nava", "Melanie Ronning", "Melinda Duran", "Michael Juarez",
                            "Michelle Lopez", "Miguel Agredano", "Miisha Davis", "Miriam Oguejiofor",
                            "Nancy Madrid", "Naomi Kaidin", "Nayeli Meza Amaral", "Neta Markusfeld",
                            "Nicole Douglass", "Nicoli Ueda", "Nora Watanabe", "Nune Mc Combs",
                            "Oscar Montenegro", "Palma Scirone", "Paola Martinez", "Patricia Castillo",
                            "Patricia Chavez", "Patrick Navas", "Paula Dominguez", "Paulette Duarte",
                            "Paulette Shelley", "Pedro Aguilar", "Praveen Ray", "Ralph Bravo",
                            "Rana Khan", "Raquel Huerta", "Rebeca Chaidez", "Rene Gaudet",
                            "Rhory Rebellon", "Richard Lee", "Rick Swanson", "Robert Jones",
                            "Robert Moose", "Robin Aaron", "Rodolfo Gutierrez", "Rosalina Pacheco",
                            "Rosalyn Lee", "Rosanna Davisson", "Rosemarie Fagfoomsintu", "Ross Kramer",
                            "Ruth Rendon", "Ryan Boyes", "Sabrina Sheikh", "Sabrina Sullivan",
                            "Sallyann Tejeda", "Salvador Magana-Arriola", "Sandra Canela", "Sandra Hernandez",
                            "Sandra Meredith", "Sandra Mijarez", "Sandra Valdivia", "Sandy Estrada",
                            "Sandy Walker", "Sara Goico Alcantar", "Scott Cody", "Senisa Austin",
                            "Shannon Moultrie", "Shannon Sayer", "Sharon Maculada", "Shawn Hall",
                            "Sherita Rogers", "Sheveeta Jackson", "Silvia Ramos", "Silvia Sanchez",
                            "Sofia Manzo-Reyes", "Sofia Vasserman", "Stacey Byham", "Stacey Williams",
                            "Staci Holmes", "Stacy Orosco", "Stephanie Harlow", "Stephen Maccarone",
                            "Steven Vitela", "Suhjung Ko", "Susan Deloach", "Susan Nolan",
                            "Susana Mislang", "Susana Santa Cruz", "Susanna Garcia", "Tacy Schull",
                            "Tamryn Wilkins", "Tanya Acosta", "Tarah Bagadiong-Trice", "Tatianika Montalbo",
                            "Tiffanie Griffin", "Tiffany Vojkovich", "Toby Sperber", "Tonya Boyd",
                            "Tonya Thompson", "Troy Poe", "Valerie De La Rosa", "Valerie Hoggard",
                            "Vanessa Sandoval", "Veganush Frnzyan", "Veronica Arevalo", "Veronica Rodriguez Sifontes",
                            "Veronica Viramontes", "Victor Castaneda", "Victoria Maldonado", "Wendy Jasso",
                            "Wendy Marrero", "Wendy Mora", "Xiaowei Wei", "Yasmin Lilly",
                            "Yesenia Duran", "Yesenia Enriquez", "Yolanda Hashimoto", "Young Choy",
                            "Yuriko Jung", "Zarui Grigoryan", "Zina Dixon"
                        ];
                        employees.forEach((emp, eIdx) => {
                            document.write(`<tr>`);
                            document.write(`<td class="employee-col">${emp}</td>`);
                            months.forEach((month, mIdx) => {
                                ['paylog', 'hours', 'approval'].forEach(type => {
                                    // Keep fieldId logic consistent with data (mIdx-eIdx)
                                    const fieldId = `icaap-${mIdx}-${eIdx}-${type}`;
                                    document.write(`<td class="editable-cell" contenteditable="true" data-field="${fieldId}"></td>`);
                                });
                            });
                            document.write(`</tr>`);
                        });
                    </script>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const PERSISTENCE_KEY = 'icaap-tracking-data';
        let saveTimeout;
        let allEmployees = [];

        async function init() {
            // Load all tracking data in parallel
            const [hoursData, approvalData, paylogData] = await Promise.all([
                fetchHoursWorked(),
                fetchApprovalDates(),
                fetchPaylogSubmissions()
            ]);

            // Load custom/placeholder data
            const plannerData = await fetchPlannerData(PERSISTENCE_KEY, 1);
            
            // Extract all names from the fetched data
            const dbNames = new Set();
            hoursData.forEach(r => { if (r.name) dbNames.add(r.name); });
            approvalData.forEach(r => { if (r.Name) dbNames.add(r.Name); });
            paylogData.forEach(r => { if (r.name) dbNames.add(r.name); });

            // Merge hardcoded employees with any new names from DB
            const toTitleCase = (str) => {
                if (!str) return '';
                return str.split(' ').map(word => {
                    if (word.includes('-')) {
                        return word.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join('-');
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            };

            const nameSet = new Set(employees.map(toTitleCase));
            dbNames.forEach(name => nameSet.add(toTitleCase(name)));
            allEmployees = [...nameSet].sort();

            // Re-render table rows if names changed or to ensure consistency
            renderTableRows();

            const hoursMap = {};
            hoursData.forEach(row => {
                if (row.name) hoursMap[row.name.toLowerCase()] = row;
            });

            const approvalMap = {};
            approvalData.forEach(row => {
                if (row.Name) approvalMap[row.Name.toLowerCase()] = row;
            });

            const paylogMap = {};
            paylogData.forEach(row => {
                if (row.name) paylogMap[row.name.toLowerCase()] = row;
            });

            // Populate custom data
            plannerData.forEach(item => {
                const el = document.querySelector(`[data-field="${item.field_id}"]`);
                if (el) el.innerText = item.content;
            });

            // Populate real data
            document.querySelectorAll('.editable-cell').forEach(cell => {
                const fieldId = cell.dataset.field;
                const parts = fieldId.split('-'); // icaap, mIdx/total, eIdx, type
                
                if (parts[1] === 'total') {
                    const eIdx = parseInt(parts[2]);
                    const empName = allEmployees[eIdx];
                    if (!empName) return;
                    const row = hoursMap[empName.toLowerCase()];
                    if (row && row.total !== undefined && row.total !== null) {
                        cell.innerText = row.total;
                    }
                } else if (parts.length === 4) {
                    const mIdx = parseInt(parts[1]);
                    const eIdx = parseInt(parts[2]);
                    const type = parts[3];
                    const empName = allEmployees[eIdx];
                    if (!empName) return;
                    const monthName = months[mIdx].split(' ')[0];
                    const lowerEmpName = empName.toLowerCase();

                    if (type === 'hours') {
                        const row = hoursMap[lowerEmpName];
                        if (row) {
                            const val = row[monthName.toLowerCase().substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    } else if (type === 'approval') {
                        const row = approvalMap[lowerEmpName];
                        if (row) {
                            const val = row[monthName.substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    } else if (type === 'paylog') {
                        const row = paylogMap[lowerEmpName];
                        if (row) {
                            const val = row[monthName.toLowerCase().substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    }
                }

                cell.addEventListener('input', () => {
                    handleSave(cell);
                });
            });
        }

        function renderTableRows() {
            const tbody = document.getElementById('tracking-body');
            tbody.innerHTML = '';
            allEmployees.forEach((emp, eIdx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="employee-col">${emp}</td>`;
                months.forEach((month, mIdx) => {
                    ['paylog', 'hours', 'approval'].forEach(type => {
                        const fieldId = `icaap-${mIdx}-${eIdx}-${type}`;
                        tr.innerHTML += `<td class="editable-cell" contenteditable="true" data-field="${fieldId}"></td>`;
                    });
                });
                // Add Total Hours cell
                const totalFieldId = `icaap-total-${eIdx}`;
                tr.innerHTML += `<td class="editable-cell" contenteditable="true" data-field="${totalFieldId}" style="font-weight: bold; background-color: #f1f8e9;"></td>`;
                tbody.appendChild(tr);
            });
        }

        function handleSave(cell) {
            const fieldId = cell.dataset.field;
            const content = cell.innerText;
            const status = document.getElementById('save-status');
            status.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                status.innerText = 'Saving...';
                
                const parts = fieldId.split('-');
                let success = false;
                
                if (parts[1] === 'total') {
                    const eIdx = parseInt(parts[2]);
                    const empName = allEmployees[eIdx];
                    success = await saveTrackingData('hours_worked', empName, 'total', content);
                } else {
                    const mIdx = parseInt(parts[1]);
                    const eIdx = parseInt(parts[2]);
                    const type = parts[3];
                    const empName = allEmployees[eIdx];
                    const monthName = months[mIdx].split(' ')[0];

                    if (type === 'hours') {
                        success = await saveTrackingData('hours_worked', empName, monthName, content);
                    } else if (type === 'approval') {
                        success = await saveTrackingData('approval_dates', empName, monthName, content);
                    } else if (type === 'paylog') {
                        success = await saveTrackingData('paylog_submission', empName, monthName, content);
                        if (!success) {
                            success = await savePlannerData(PERSISTENCE_KEY, fieldId, content);
                        }
                    }
                }
                
                status.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
