<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCAAP Tracking - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --table-green: #1b5e20;
            --border-color: #ccc;
        }
        body {
            font-family: 'Coming Soon', cursive;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        .global-header {
            background: #00326b;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
            align-items: center;
        }
        .nav-link {
            text-decoration: none;
            color: #ffca38;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            border: 2px solid #ffca38;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .container {
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }
        .notebook-page {
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-width: max-content;
        }
        .page-title {
            color: var(--header-blue);
            border-bottom: 2px solid var(--header-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .tracking-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 11px;
        }
        .tracking-table th, .tracking-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }
        .header-row {
            background-color: var(--table-green);
            color: white;
        }
        .month-header {
            min-width: 150px;
        }
        .employee-col {
            background-color: #f9f9f9;
            font-weight: bold;
            text-align: left;
            min-width: 150px;
            position: sticky;
            left: 0;
            border-right: 2px solid var(--border-color);
            z-index: 5;
        }
        .header-row .employee-col {
            background-color: var(--table-green);
            z-index: 10;
        }
        .sub-header {
            font-size: 9px;
            background-color: #e8f5e9;
        }
        .editable-cell {
            outline: none;
            min-height: 20px;
            background-color: #fff;
        }
        .editable-cell:focus {
            background-color: #fffde7;
            box-shadow: inset 0 0 0 2px var(--header-blue);
        }
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: #666;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <header class="global-header">
        <a href="index.html" class="nav-link">Home</a>
        <a href="csea.html" class="nav-link">CSEA</a>
        <a href="financial.html" class="nav-link">Financial</a>
        <a href="hoa.html" class="nav-link">HOA</a>
        <a href="icaap.html" class="nav-link">iCAAP</a>
        <a href="planning.html" class="nav-link">Planning</a>
        <a href="mantra.html" class="nav-link">Mantra</a>
    </header>
    <div id="save-status" class="save-status">All changes saved</div>
    <div class="container">
        <div class="notebook-page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 class="page-title" style="margin-bottom: 0; border-bottom: none;">iCAAP Tracking Log</h1>
                <a href="icaap.html" class="nav-link" style="color: var(--header-blue); border-color: var(--header-blue);">
                    <span>üìù</span> iCAAP Notes
                </a>
            </div>
            <div style="border-bottom: 2px solid var(--header-blue); margin-bottom: 20px;"></div>
            <table class="tracking-table">
                <thead>
                    <tr class="header-row">
                        <script>
                            const months = [
                                'July 2025', 'August 2025', 'September 2025', 'October 2025', 
                                'November 2025', 'December 2025', 'January 2026', 'February 2026', 
                                'March 2026', 'April 2026', 'May 2026', 'June 2026'
                            ];
                            document.write(`<th rowspan="2" class="employee-col">Employee Name</th>`);
                            months.forEach(month => {
                                document.write(`<th colspan="3" class="month-header">${month}</th>`);
                            });
                        </script>
                    </tr>
                    <tr class="sub-header">
                        <script>
                            months.forEach(month => {
                                document.write(`<th>Paylog Sub.</th><th>Hours</th><th>Approval</th>`);
                            });
                        </script>
                    </tr>
                </thead>
                <tbody id="tracking-body">
                    <script>
                        const employees = [
                            'Robin Aaron', 'Tanya Acosta', 'Kristine Adams', 'Miguel Agredano', 'Pedro Aguilar', 
                            'Genesis Aguirre', 'Hina Ahmad', 'Ma Teresa Aki', 'Lilit Akilian', 'Mayra Alcantar', 
                            'Eileen Alcorn', 'Maria Aldave Cabrera', 'Jose Alvarenga', 'Liliana Amezcua', 
                            'Liberty Amos', 'Leslie Anderson', 'Veronica Arevalo', 'Alexander Aston', 
                            'Senisa Austin', 'Dulce Bacon', 'Tarah Bagadiong Trice', 'Jordan Baldry', 
                            'Deanna Baldwin', 'Gladys Barbosa', 'Cynthia Barrilleaux', 'Cecille Basilio', 
                            'Kristy Beaudry', 'Marie Bennett', 'Anthony Bernard', 'Cynthia Bitterman', 
                            'Lanette Black', 'Leslie Black', 'Barry Blisten', 'Chevon Booker', 
                            'Jittima Bouillot', 'Tonya Boyd', 'Ryan Boyes', 'Edith Braswell Grant', 
                            'Ralph Bravo', 'Stacey Byham', 'Julia Calamandrei', 'Sandra Canela', 
                            'Karen Caruso', 'Victor Castaneda', 'Isidro Castillo', 'Patricia Castillo', 
                            'Juan Catalan', 'Alicia Cerna', 'Andrea Chagoya', 'Rebeca Chaidez', 
                            'Elizabeth Chavez', 'Patricia Chavez', 'Christine Choi', 'Young Choy', 
                            'Christina Clark', 'Scott Cody', 'Crystal Cohen', 'Alexis Contreras', 
                            'Jacqueline Cruz', 'Louise Cummings', 'Claire Daigle', 'Lisa Darbidian', 
                            'Miisha Davis', 'Rosanna Davisson', 'Valerie De La Rosa', 'Gene Dean', 
                            'Ladan Dejam', 'Susan Deloach', 'Guillermo Diaz', 'Zina Dixon', 
                            'Paula Dominguez', 'Andrea Douglas', 'Nicole Douglass', 'Paulette Duarte', 
                            'Melinda Duran', 'Yesenia Duran', 'Elizabeth Elizalde', 'Yesenia Enriquez', 
                            'Sandy Estrada', 'Chinedu Ezeh', 'Rosemarie Fagfoomsintu', 'Jamall Farr', 
                            'Julianne Fassett', 'Marites Felicilda', 'Malika Ferrell', 'Dana Fikes', 
                            'Maikai Finnell', 'Jeanine Flier', 'Dawnise Francisco', 'Claudia Franco', 
                            'Deborah Francois', 'Veganush Frnzyan', 'Carmen Fuentes', 'Karsina Gaither', 
                            'Jeanne Garcia Armstrong', 'Rene Gaudet', 'Hamilton Gernon Wyatt', 
                            'Lailani Joy Gonzaga', 'Emir Gonzalez', 'Leticia Gudino', 'Ana Guevara', 
                            'David Hadjichristodoulou', 'Shawn Hall', 'Alyson Han', 'Dalese Hardin', 
                            'Stephanie Harlow', 'Dominique Harris', 'Laveda Harris', 'Lisa Harvey', 
                            'Yolanda Hashimoto', 'Kionna Hawkins', 'Jose Hernandez', 'Maria Hernandez', 
                            'Sandra Hernandez', 'Alice Hilal', 'Linda Hoang', 'Valerie Hoggard', 
                            'Staci Holmes', 'Cassondra Holt Hightower', 'Eric Hopson', 'Raquel Huerta', 
                            'Adrian Irvine', 'Charles Izuakor', 'Sheveeta Jackson', 'Wendy Jasso', 
                            'Liliana Jauregui George', 'Robert Jones', 'Yuriko Jung', 'Beverly Junio Magee', 
                            'Joy Kasper', 'Rana Khan', 'Suhjung Ko', 'Ross Kramer', 'Luciano Latini', 
                            'Cherie Lebron', 'Janet Ledesma', 'Richard Lee', 'Rosalyn Lee', 
                            'Agnes Lewis', 'Jiabei Li', 'Yasmin Lilly', 'Christopher Linares', 
                            'Angela Lopez', 'Gustavo Lopez', 'Jennifer Lopez', 'Michelle Lopez', 
                            'Stephen Maccarone', 'Sharon Maculada', 'Nancy Madrid', 'Farhad Mahmud', 
                            'Enas Makar', 'Victoria Maldonado', 'Araksya Manukyan', 'Sofia Manzo Reyes', 
                            'Karina Maravilla', 'Lisa Marks', 'Neta Markusfeld', 'Dora Marquez', 
                            'Wendy Marrero', 'Amparo Martin', 'Marta Martin', 'Hector Martinez', 
                            'Leticia Martinez', 'Liliana Martinez', 'Paola Martinez', 'Amber Mastroianni', 
                            'Antoinette Matiga', 'Nune Mc Combs', 'Evelyn Mcfarlane', 'Christa Mcmullin', 
                            'Kelvin Means', 'Crystal Mendez', 'Julian Mendez', 'Sandra Meredith', 
                            'Erin Mettlen', 'Nayeli Meza Amaral', 'Sandra Mijarez', 'Aline Millan', 
                            'Eimi Miller', 'Matthew Miller', 'Susana Mislang', 'Tatianika Montalbo', 
                            'Maeli Montecinos', 'Oscar Montenegro', 'Robert Moose', 'Wendy Mora', 
                            'Andreina Morales', 'Anthony Morales', 'Frances Morales', 'Shannon Moultrie', 
                            'Elisabeth Mullins Medina', 'Patrick Navas', 'Susan Nolan', 'Ameel Noos', 
                            'Danielle O\'conner', 'Sara O\'connor', 'Miriam Oguejiofor', 'Adriana Ojeda', 
                            'Mary Jane Opoku', 'Indira Ortiz', 'Rosalina Pacheco', 'Jacqueline Palacios', 
                            'Erica Pan', 'Erika Paz', 'Brigette Pena', 'Leslie Perez', 'Jenny Peterson', 
                            'Juan Pina', 'Bienvenido Pineda', 'Maria Pinto', 'Marla Pizzuto', 
                            'Troy Poe', 'Javier Ponce Garcia', 'Anna Quezada', 'Ida Quijada', 
                            'Iliana Quintero', 'Kimberly Rabas', 'Ancelmo Ramos', 'Lawrence Ramos', 
                            'Silvia Ramos', 'Praveen Ray', 'Ma Joanna Razon', 'Rhory Rebellon', 
                            'Douglas Reisgen', 'Ruth Rendon', 'Julie Ann Resurreccion', 'Malina Rios', 
                            'Crystal Rivera', 'Mayra Rodarte Nava', 'Veronica Rodriguez Sifontes', 
                            'Eberardo Rodriguez', 'Efren Rodriguez', 'Sherita Rogers', 'Elizabeth Romero', 
                            'Jose Romero', 'Melanie Ronning', 'Lila Rosas Madrigal', 'Baharak Saadat Beheshti', 
                            'Mandana Saidi', 'Irma Salas', 'Daniel Saldana', 'Adalid Sanchez Rodriguez', 
                            'Erica Sanchez', 'Silvia Sanchez', 'Jakeisha Sanders', 'Vanessa Sandoval', 
                            'Susana Santa Cruz', 'Linda Santana', 'Adan Saucedo', 'Shannon Sayer', 
                            'Tacy Schull', 'Palma Scirone', 'Dawn Sebastian', 'Kevin Seegan', 
                            'Jasmin Segovia', 'Beatris Segura', 'Sabrina Sheikh', 'Paulette Shelley', 
                            'Aya Shigenaga', 'Kerry Shimizu', 'Freshta Sidiqi', 'Karen Siercke Noriega', 
                            'Christina Silva', 'Christina Sithole', 'Alberto Solorzano', 'Julie Sornberger', 
                            'Toby Sperber', 'Jereme Stark', 'Barbara Stoliker', 'Sabrina Sullivan', 
                            'Rick Swanson', 'Glenda Tamay', 'Linda Taylor', 'Sallyann Tejeda', 
                            'Joseph Thomas', 'Tonya Thompson', 'Ivy Grace Thorne', 'Cynthia Timm', 
                            'Mark Todd', 'Irma Torres', 'Jorge Torres', 'Gavriela Trujillo', 
                            'Nicoli Ueda', 'Jehisol Urbina', 'Sandra Valdivia', 'Marianne Valencia', 
                            'Sofia Vasserman', 'Emilee Velazco Franco', 'Tiffany Vojkovich', 
                            'Sandy Walker', 'Jennifer Washington', 'Emily Wassler', 'Nora Watanabe', 
                            'Debora Wechsler', 'Xiaowei Wei', 'Tamryn Wilkins', 'Stacey Williams', 
                            'Amber Wilton', 'Bennett Winter', 'Ester Yang', 'Lucrecia Yescas Luna', 
                            'Jeen Yu', 'Marlene Yu', 'Leslie Zamora', 'Maria Zamora', 'Anthony Zarate', 
                            'Joseph Zeccola'
                        ];
                        employees.forEach((emp, eIdx) => {
                            document.write(`<tr>`);
                            document.write(`<td class="employee-col">${emp}</td>`);
                            months.forEach((month, mIdx) => {
                                ['paylog', 'hours', 'approval'].forEach(type => {
                                    // Keep fieldId logic consistent with data (mIdx-eIdx)
                                    const fieldId = `icaap-${mIdx}-${eIdx}-${type}`;
                                    document.write(`<td class="editable-cell" contenteditable="true" data-field="${fieldId}"></td>`);
                                });
                            });
                            document.write(`</tr>`);
                        });
                    </script>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const PERSISTENCE_KEY = 'icaap-tracking-data';
        let saveTimeout;
        let allEmployees = [];

        async function init() {
            // Load custom/placeholder data first
            const plannerData = await fetchPlannerData(PERSISTENCE_KEY, 1);
            
            // Load all tracking data in parallel
            const [hoursData, approvalData, paylogData, dbNames] = await Promise.all([
                fetchHoursWorked(),
                fetchApprovalDates(),
                fetchPaylogSubmissions(),
                fetchAllTrackingNames()
            ]);

            // Merge hardcoded employees with any new names from DB
            const nameSet = new Set(employees);
            dbNames.forEach(name => nameSet.add(name));
            allEmployees = [...nameSet].sort();

            // Re-render table rows if names changed or to ensure consistency
            renderTableRows();

            const hoursMap = {};
            hoursData.forEach(row => hoursMap[row.name] = row);

            const approvalMap = {};
            approvalData.forEach(row => approvalMap[row.Name] = row);

            const paylogMap = {};
            paylogData.forEach(row => paylogMap[row.name] = row);

            // Populate custom data
            plannerData.forEach(item => {
                const el = document.querySelector(`[data-field="${item.field_id}"]`);
                if (el) el.innerText = item.content;
            });

            // Populate real data
            document.querySelectorAll('.editable-cell').forEach(cell => {
                const fieldId = cell.dataset.field;
                const parts = fieldId.split('-'); // icaap, mIdx, eIdx, type
                if (parts.length === 4) {
                    const mIdx = parseInt(parts[1]);
                    const eIdx = parseInt(parts[2]);
                    const type = parts[3];
                    const empName = allEmployees[eIdx];
                    const monthName = months[mIdx].split(' ')[0];

                    if (type === 'hours') {
                        const row = hoursMap[empName];
                        if (row) {
                            const val = row[monthName.toLowerCase().substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    } else if (type === 'approval') {
                        const row = approvalMap[empName];
                        if (row) {
                            const val = row[monthName.substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    } else if (type === 'paylog') {
                        const row = paylogMap[empName];
                        if (row) {
                            const val = row[monthName.substring(0, 3)];
                            if (val !== undefined && val !== null) cell.innerText = val;
                        }
                    }
                }

                cell.addEventListener('input', () => {
                    handleSave(cell);
                });
            });
        }

        function renderTableRows() {
            const tbody = document.getElementById('tracking-body');
            tbody.innerHTML = '';
            allEmployees.forEach((emp, eIdx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="employee-col">${emp}</td>`;
                months.forEach((month, mIdx) => {
                    ['paylog', 'hours', 'approval'].forEach(type => {
                        const fieldId = `icaap-${mIdx}-${eIdx}-${type}`;
                        tr.innerHTML += `<td class="editable-cell" contenteditable="true" data-field="${fieldId}"></td>`;
                    });
                });
                tbody.appendChild(tr);
            });
        }

        function handleSave(cell) {
            const fieldId = cell.dataset.field;
            const content = cell.innerText;
            const status = document.getElementById('save-status');
            status.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                status.innerText = 'Saving...';
                
                const parts = fieldId.split('-');
                const mIdx = parseInt(parts[1]);
                const eIdx = parseInt(parts[2]);
                const type = parts[3];
                const empName = allEmployees[eIdx];
                const monthName = months[mIdx].split(' ')[0];

                let success = false;
                if (type === 'hours') {
                    success = await saveTrackingData('hours_worked', empName, monthName, content);
                } else if (type === 'approval') {
                    success = await saveTrackingData('approval_dates', empName, monthName, content);
                } else if (type === 'paylog') {
                    success = await saveTrackingData('Paylog_Submission', empName, monthName, content);
                    if (!success) {
                        success = await savePlannerData(PERSISTENCE_KEY, fieldId, content);
                    }
                }
                
                status.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
