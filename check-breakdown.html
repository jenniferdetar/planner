<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Breakdown Spreadsheet - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon;500;700&family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --sheet-green: #1b5e20;
            --border-color: #e1dfdd;
        }
        .page-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #e1dfdd;
            padding-bottom: 5px;
            flex-shrink: 0;
        }
        .page-title {
            font-size: 12px;
            color: var(--header-blue);
            margin: 0;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }
        body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 20px;
            height: 100%;
            box-sizing: border-box;
            min-height: 0;
        }
        .spreadsheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }
        .table-column {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .table-container {
            width: 100%;
            overflow: auto;
            border: 1px solid #e1dfdd;
            border-radius: 4px;
            flex: 1;
            min-height: 0;
        }
        .sheet-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }
        .sheet-table th, .sheet-table td {
            border: 1px solid #eee;
            padding: 4px 6px;
        }
        .header-row th {
            background-color: #f8f9fa;
            color: #323130;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            border-bottom: 2px solid #e1dfdd;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
        }
        .account-col {
            font-weight: 600;
            text-align: left !important;
            min-width: 120px;
            max-width: 120px;
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 15;
            border-right: 2px solid #e1dfdd !important;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-cell {
            text-align: right;
            outline: none;
            font-family: 'Coming Soon', cursive; font-size: 12px; line-height: 13px; font-weight: 600;
            font-size: 12px;
            color: #333;
            min-width: 60px;
        }
        .data-cell:focus {
            background-color: #fffde7;
            box-shadow: inset 0 0 0 2px var(--header-blue);
        }
        .left-over-row {
            background-color: #f3f2f1 !important;
            font-weight: 600;
        }
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 120px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="spreadsheet-grid">
            <div class="table-column">
                <div class="page-header"><h1 class="page-title" id="left-title">JULY - AUGUST 2025</h1></div>
                <div class="table-container">
                    <table class="sheet-table">
                        <thead><tr class="header-row" id="left-head"><th class="account-col">Account</th></tr></thead>
                        <tbody id="left-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="table-column">
                <div class="page-header"><h1 class="page-title" id="right-title">SEPTEMBER - OCTOBER 2025</h1></div>
                <div class="table-container">
                    <table class="sheet-table">
                        <thead><tr class="header-row" id="right-head"><th class="account-col">Account</th></tr></thead>
                        <tbody id="right-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="save-status" class="save-status">All changes saved</div>

    <script>
        let accounts = [];
        let allDates = [];
        let currentSpread = 0; // 0: Jul-Oct, 1: Nov-Feb, 2: Mar-Jun
        const PERSISTENCE_KEY = "check-breakdown-2025-2026";

        async function init() {
            setGlobalHeaderTitle("CHECK BREAKDOWN");
            // Setup Dates for Fiscal Year July 2025 - June 2026
            const startDate = new Date(2025, 6, 1); // July 1, 2025
            for (let i = 0; i < 12; i++) {
                const m = new Date(startDate);
                m.setMonth(startDate.getMonth() + i);
                
                const d5 = new Date(m); d5.setDate(5);
                allDates.push({ date: d5, label: `${d5.getMonth() + 1}/5/${d5.getFullYear()}` });
                
                const d20 = new Date(m); d20.setDate(20);
                allDates.push({ date: d20, label: `${d20.getMonth() + 1}/20/${d20.getFullYear()}` });
            }

            // Fetch Bills
            const billData = await fetchFinancialBills();
            const billMap = new Map();
            DEFAULT_BILLS.forEach(b => billMap.set(b.item, b));
            billData.forEach(b => billMap.set(b.item, b));
            const bills = [...billMap.values()].sort((a, b) => a.id - b.id);

            accounts = [
                "Currently in Checking",
                "Jennifer's Check",
                "Tithe",
                ...bills.map(b => b.item),
                "Left Over"
            ];

            const savedData = await fetchPlannerData(PERSISTENCE_KEY, 1000);
            renderCurrentSpread(savedData);

            window.changeMonth = (dir) => {
                const direction = dir > 0 ? 'next' : 'prev';
                if ((dir > 0 && currentSpread < 2) || (dir < 0 && currentSpread > 0)) {
                    const panes = document.querySelectorAll('.view-pane');
                    const targetPane = (direction === 'next') ? panes[panes.length - 1] : panes[0];
                    if (targetPane) {
                        targetPane.classList.add(`flip-out-${direction}`);
                        setTimeout(() => {
                            currentSpread += dir;
                            targetPane.classList.remove(`flip-out-${direction}`);
                            renderCurrentSpread(savedData);
                        }, 800);
                    }
                }
            };
        }

        function renderCurrentSpread(savedData) {
            // Spread 0: Months 0,1,2,3 (Indices 0-7 in allDates)
            // Spread 1: Months 4,5,6,7 (Indices 8-15)
            // Spread 2: Months 8,9,10,11 (Indices 16-23)
            const leftStart = currentSpread * 8;
            const leftDates = allDates.slice(leftStart, leftStart + 4);
            const rightDates = allDates.slice(leftStart + 4, leftStart + 8);

            const leftMonths = [...new Set(leftDates.map(d => d.date.toLocaleString('default', { month: 'long' })))].join(' - ');
            const rightMonths = [...new Set(rightDates.map(d => d.date.toLocaleString('default', { month: 'long' })))].join(' - ');
            const year = leftDates[0].date.getFullYear();
            const rightYear = rightDates[0].date.getFullYear();

            document.getElementById('left-title').innerText = `${leftMonths.toUpperCase()} ${year}`;
            document.getElementById('right-title').innerText = `${rightMonths.toUpperCase()} ${rightYear}`;

            renderPage('left', leftDates, savedData, leftStart);
            renderPage('right', rightDates, savedData, leftStart + 4);
        }

        function renderPage(side, dates, savedData, globalColOffset) {
            const head = document.getElementById(`${side}-head`);
            const body = document.getElementById(`${side}-body`);
            head.innerHTML = '<th class="account-col">Account</th>';
            body.innerHTML = '';

            dates.forEach(d => {
                const th = document.createElement('th');
                th.innerText = d.label;
                head.appendChild(th);
            });

            accounts.forEach((acc, rowIndex) => {
                const isLeftOver = acc === "Left Over";
                const isTithe = acc === "Tithe";
                const tr = document.createElement('tr');
                if (isLeftOver) tr.className = 'left-over-row';
                
                let html = `<td class="account-col" title="${acc}">${acc}</td>`;
                dates.forEach((date, localColIndex) => {
                    const globalColIndex = globalColOffset + localColIndex;
                    const fieldId = `grid-${rowIndex}-${globalColIndex}`;
                    const content = savedData.find(d => d.field_id === fieldId)?.content || '';
                    html += `<td class="data-cell" ${isLeftOver || isTithe ? '' : 'contenteditable="true"'} data-field="${fieldId}" data-row="${rowIndex}" data-col="${globalColIndex}">${content}</td>`;
                });
                tr.innerHTML = html;
                body.appendChild(tr);
            });

            // Re-attach listeners and calculate
            body.querySelectorAll('.data-cell[contenteditable="true"]').forEach(cell => {
                cell.oninput = () => {
                    saveWithDebounce(PERSISTENCE_KEY, cell.dataset.field, cell.innerText);
                    calculateAll(globalColOffset, globalColOffset + dates.length);
                };
            });

            calculateAll(globalColOffset, globalColOffset + dates.length);
        }

        function parseAmount(text) {
            if (!text) return 0;
            return parseFloat(text.replace(/[$,]/g, '')) || 0;
        }

        function formatAmount(amount) {
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calculateAll(startCol, endCol) {
            for (let c = startCol; c < endCol; c++) {
                const cells = document.querySelectorAll(`[data-col="${c}"]`);
                let income = 0;
                let expenses = 0;
                let jennifersCheck = 0;
                const leftOverRowIndex = accounts.length - 1;

                cells.forEach(cell => {
                    const rowIndex = parseInt(cell.dataset.row);
                    if (rowIndex === 1) jennifersCheck = parseAmount(cell.innerText);
                    
                    if (rowIndex === 2) {
                        const titheAmount = Math.ceil(jennifersCheck * 0.1);
                        cell.innerText = formatAmount(titheAmount);
                    }
                });

                cells.forEach(cell => {
                    const rowIndex = parseInt(cell.dataset.row);
                    const val = parseAmount(cell.innerText);
                    if (rowIndex === 0 || rowIndex === 1) income += val;
                    else if (rowIndex >= 2 && rowIndex < leftOverRowIndex) expenses += val;
                    
                    if (rowIndex === leftOverRowIndex) {
                        cell.innerText = formatAmount(income - expenses);
                    }
                });
            }
        }

        let debounceTimer;
        function saveWithDebounce(pk, field, content) {
            const statusEl = document.getElementById('save-status');
            statusEl.innerText = 'Saving...';
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const savedValue = await savePlannerData(pk, field, content);
                if (savedValue) {
                    statusEl.innerText = 'All changes saved';
                    if (savedValue !== content) {
                        const el = document.querySelector(`[data-field="${field}"]`);
                        if (el) {
                            if (el.innerText !== undefined) el.innerText = savedValue;
                            else el.value = savedValue;
                        }
                    }
                } else {
                    statusEl.innerText = 'Error saving';
                }
            }, 1000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>