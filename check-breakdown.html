<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Breakdown Spreadsheet - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --sheet-green: #1b5e20;
            --border-color: #ccc;
            --text-color: #333;
            --csea-yellow: #ffca38;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: var(--text-color);
        }
        .global-header {
            background: #00326b;
            padding: 5px 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
            align-items: center;
        }
        .nav-link {
            text-decoration: none;
            color: #ffca38;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            border: 2px solid #ffca38;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        .nav-link:hover {
            background-color: #ffca38;
            color: #00326b;
        }
        .spreadsheet-container {
            width: 100%;
            overflow-x: auto;
            background: #fff;
            min-height: calc(100vh - 60px);
        }
        .sheet-table {
            border-collapse: collapse;
            width: max-content;
            min-width: 100%;
            font-size: 13px;
        }
        .sheet-table th, .sheet-table td {
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            min-width: 100px;
        }
        .header-row {
            background-color: var(--sheet-green);
            color: #ffffff;
        }
        .header-row th {
            font-weight: 700;
            text-align: center;
            height: 30px;
            position: sticky;
            top: 40px;
            z-index: 10;
            color: #ffffff;
        }
        .account-col {
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 5;
            min-width: 250px;
            text-align: left;
            font-weight: 500;
        }
        .header-row .account-col {
            background-color: var(--sheet-green);
            z-index: 15;
            top: 40px;
        }
        .data-cell {
            text-align: right;
            outline: none;
            font-family: monospace;
        }
        .data-cell:focus {
            background-color: #e8f0fe;
            box-shadow: inset 0 0 0 2px #1a73e8;
        }
        .sheet-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .sheet-table tbody tr:nth-child(even) .account-col {
            background-color: #f8f9fa;
        }
        .left-over-row {
            background-color: #f1f3f4 !important;
            font-weight: bold;
        }
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: #666;
            z-index: 2000;
        }
        .sheet-title-bar {
            background: #f1f3f4;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #ccc;
        }
        .sheet-icon {
            color: var(--sheet-green);
            font-size: 24px;
        }
        .sheet-name {
            font-weight: 500;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <header class="global-header">
        <a href="index.html" class="nav-link">Home</a>
        <a href="csea.html" class="nav-link">CSEA</a>
        <a href="financial.html" class="nav-link">Financial</a>
        <a href="personal-goals.html" class="nav-link">Goals</a>
        <a href="hoa.html" class="nav-link">HOA</a>
        <a href="icaap.html" class="nav-link">iCAAP</a>
        <a href="planning.html" class="nav-link">Planning</a>
        <a href="mantra.html" class="nav-link">Mantra</a>
    </header>

    <div class="sheet-title-bar">
        <span class="sheet-icon">ðŸ“…</span>
        <span class="sheet-name">Check Breakdown</span>
    </div>

    <div id="save-status" class="save-status">All changes saved</div>

    <div class="spreadsheet-container">
        <table class="sheet-table">
            <thead>
                <tr class="header-row">
                    <th class="account-col">Account</th>
                    <script>
                        const dates = [
                            '7/5/2025', '7/20/2025', '8/5/2025', '8/19/2025', '9/5/2025', 
                            '9/20/2025', '10/5/2025', '10/20/2025', '11/4/2025', '11/18/2025', 
                            '12/5/2025', '12/20/2025', '1/5/2026', '1/20/2026', '2/3/2026', 
                            '2/20/2026', '3/3/2026', '3/20/2026', '4/5/2026', '4/20/2026'
                        ];
                        dates.forEach(d => document.write(`<th>${d}</th>`));
                    </script>
                </tr>
            </thead>
            <tbody id="sheet-body">
                <script>
                    const accounts = [
                        "Currently in Checking",
                        "Jennifer's Check",
                        "Tithe",
                        "ADT",
                        "Amazon - Necessities",
                        "Auto Maintenance",
                        "Blow",
                        "Ana",
                        "DWP",
                        "Gas",
                        "Groceries",
                        "Hair (Expensive)",
                        "Hair (Cheap)",
                        "HSA",
                        "Jennifer's Student Loans - NelNet",
                        "Jennifer's Student Loans - Salli...",
                        "Laundry",
                        "Mercury Auto Insurance",
                        "Orkin",
                        "Schools First Loan",
                        "Spectrum",
                        "Summer Saver",
                        "Tahoe Registration",
                        "Trailblazer Registration",
                        "Verizon",
                        "Left Over"
                    ];

                    accounts.forEach((acc, rowIndex) => {
                        const isLeftOver = acc === "Left Over";
                        document.write(`<tr class="${isLeftOver ? 'left-over-row' : ''}">`);
                        document.write(`<td class="account-col">${acc}</td>`);
                        dates.forEach((date, colIndex) => {
                            const fieldId = `grid-${rowIndex}-${colIndex}`;
                            document.write(`<td class="data-cell" contenteditable="true" data-field="${fieldId}" data-row="${rowIndex}" data-col="${colIndex}"></td>`);
                        });
                        document.write(`</tr>`);
                    });
                </script>
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Data using shared.js logic
            // We use a fixed date "2025-01-01" to store the whole grid 
            // OR we can use the date from the column header for date_key.
            // Let's use "grid-system" as the date_key to keep the entire spreadsheet in one "page".
            const PERSISTENCE_KEY = "check-breakdown-spreadsheet";
            
            const data = await fetchPlannerData(PERSISTENCE_KEY, 1);
            data.forEach(item => {
                const el = document.querySelector(`[data-field="${item.field_id}"]`);
                if (el) el.innerText = item.content;
            });

            // Setup Auto-save and Calculation
            document.querySelectorAll('.data-cell').forEach(cell => {
                const rowIndex = parseInt(cell.dataset.row);
                if (rowIndex === 25 || rowIndex === 2) {
                    cell.contentEditable = "false";
                }

                cell.addEventListener('input', () => {
                    saveWithDebounce(PERSISTENCE_KEY, cell.dataset.field, cell.innerText);
                    if (rowIndex !== 25) {
                        calculateColumn(parseInt(cell.dataset.col));
                    }
                });
            });

            // Initial calculation
            for (let i = 0; i < dates.length; i++) {
                calculateColumn(i);
            }
        });

        function parseAmount(text) {
            if (!text) return 0;
            return parseFloat(text.replace(/[$,]/g, '')) || 0;
        }

        function formatAmount(amount) {
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calculateColumn(colIndex) {
            const rows = document.querySelectorAll('#sheet-body tr');
            let income = 0;
            let expenses = 0;
            let jennifersCheck = 0;

            // First pass to get Jennifer's Check
            const checkCell = rows[1].querySelector(`[data-col="${colIndex}"]`);
            if (checkCell) {
                jennifersCheck = parseAmount(checkCell.innerText);
            }

            // Calculate and set Tithe (10% rounded up)
            const titheCell = rows[2].querySelector(`[data-col="${colIndex}"]`);
            if (titheCell) {
                const titheAmount = Math.ceil(jennifersCheck * 0.1);
                titheCell.innerText = formatAmount(titheAmount);
            }

            rows.forEach((row, rowIndex) => {
                const cell = row.querySelector(`[data-col="${colIndex}"]`);
                if (!cell) return;
                
                if (rowIndex === 25) {
                    cell.innerText = formatAmount(income - expenses);
                } else {
                    const val = parseAmount(cell.innerText);
                    if (rowIndex === 0 || rowIndex === 1) {
                        income += val;
                    } else if (rowIndex >= 2 && rowIndex <= 24) {
                        expenses += val;
                    }
                }
            });
        }

        let debounceTimer;
        function saveWithDebounce(date, field, content) {
            document.getElementById('save-status').innerText = 'Saving...';
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const success = await savePlannerData(date, field, content);
                if (success) {
                    document.getElementById('save-status').innerText = 'All changes saved';
                } else {
                    document.getElementById('save-status').innerText = 'Error saving';
                }
            }, 1000);
        }
    </script>
</body>
</html>
