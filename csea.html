<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Csea - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Indie+Flower&family=Plus+Jakarta+Sans:wght@400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <link href="onenote.css" rel="stylesheet">
    <style>
        /* Keep page-specific table styles but adjust for lines */
        .log-section {
            margin-top: 40px;
            overflow-x: auto;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Coming Soon', cursive;
            font-size: 10pt;
            margin-bottom: 20px;
            border: 1px solid #666;
        }
        .log-table th {
            background-color: #2d5a45;
            color: white;
            padding: 12px 10px;
            text-align: left;
            border: 1px solid #000;
            font-weight: 600;
            position: sticky;
            top: 40px;
            z-index: 100;
        }
        .log-table td {
            padding: 10px;
            border: 1px solid #666;
            vertical-align: top;
        }
        .log-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .log-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .log-table tbody tr:hover {
            background-color: #f1f8e9;
        }
        .log-input-row td {
            background-color: #fffde7;
        }
        .log-input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 5px;
            box-sizing: border-box;
            font-family: 'Coming Soon', cursive;
            font-size: 10pt;
        }
        .add-log-btn {
            background-color: #2d5a45;
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .add-log-btn:hover {
            opacity: 0.9;
        }
        .interaction-log-header {
            font-family: 'Indie Flower', cursive;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="onenote-tabs">
        <a href="index.html" class="onenote-tab tab-home">Home</a>
        <a href="work-planner.html" class="onenote-tab tab-planning">Work</a>
        <a href="personal-planner.html" class="onenote-tab tab-home">Personal</a>
        <a href="csea.html" class="onenote-tab tab-csea active" id="tab-csea">Csea</a>
        <a href="hoa.html" class="onenote-tab tab-hoa" id="tab-hoa">Hoa</a>
        <a href="icaap.html" class="onenote-tab tab-icaap" id="tab-icaap">Icaap</a>
        <a href="financial.html" class="onenote-tab tab-financial" id="tab-financial">Financial</a>
        <a href="planning.html" class="onenote-tab tab-planning" id="tab-planning">Planning</a>
        <a href="personal-goals.html" class="onenote-tab tab-goals" id="tab-goals">Goals</a>
        <a href="mantra.html" class="onenote-tab tab-mantra" id="tab-mantra">Mantra</a>
    </nav>
    <div class="notepaper">
        <div class="notepaper-content">
            <h1 class="page-title">Csea Notes</h1>
            <div class="notes-section">
                <div class="input-group">
                    <textarea id="new-note-content" placeholder="Type a new note here..." oninput="handleDraftInput()"></textarea>
                    <button class="save-btn" onclick="handleAddNote()" style="margin-top: 10px; background: #2d5a45; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-family: 'Coming Soon', cursive;">Save Note</button>
                    <div id="save-status" class="save-status">All changes saved</div>
                </div>
                <div id="entries-list" class="entries-list">
                    <!-- Entries will be loaded here -->
                </div>
                <div class="log-section">
                    <h2 class="page-title interaction-log-header">Member Interaction Log</h2>
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th style="width: 20px;"></th>
                                <th>Date Spoke</th>
                                <th>Member Name</th>
                                <th>Type</th>
                                <th>Member Number</th>
                                <th>Site/Location</th>
                                <th>Discussion/Concern</th>
                                <th>Involved/Action</th>
                                <th>Union/Labor Rep</th>
                                <th>Outcome</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="interaction-log-body">
                            <!-- Existing interactions -->
                        </tbody>
                        <tfoot>
                            <tr class="log-input-row">
                                <td></td>
                                <td><input type="date" id="log-date" class="log-input"></td>
                                <td>
                                    <input type="text" id="log-member" class="log-input" placeholder="Name" list="members-list">
                                    <datalist id="members-list"></datalist>
                                </td>
                                <td>
                                    <select id="log-type" class="log-input">
                                        <option value="Auto">Auto-Detect</option>
                                        <option value="Grievance">Grievance</option>
                                        <option value="Inquiry">Inquiry</option>
                                    </select>
                                </td>
                                <td><input type="text" id="log-number" class="log-input" placeholder="Number"></td>
                                <td>
                                    <input type="text" id="log-location" class="log-input" placeholder="Location" list="schools-list">
                                    <datalist id="schools-list"></datalist>
                                </td>
                                <td>
                                    <input type="text" id="log-discussion" class="log-input" placeholder="Discussion" list="issues-list">
                                    <datalist id="issues-list"></datalist>
                                </td>
                                <td><input type="text" id="log-who" class="log-input" placeholder="Who involved"></td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <input type="text" id="log-contact" class="log-input" placeholder="Union Rep" list="stewards-list">
                                        <input type="text" id="log-labor-rep" class="log-input" placeholder="Labor Rep">
                                    </div>
                                </td>
                                <td><input type="text" id="log-outcome" class="log-input" placeholder="Outcome"></td>
                                <td><button class="add-log-btn" onclick="handleAddInteraction()">Add</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const CATEGORY = 'CSEA';
        const PERSISTENCE_KEY = `draft-note-${CATEGORY.toLowerCase()}`;
        const entriesList = document.getElementById('entries-list');
        const newNoteContent = document.getElementById('new-note-content');
        const saveStatus = document.getElementById('save-status');
        const interactionLogBody = document.getElementById('interaction-log-body');
        let saveTimeout = null;

        // Reference Data
        let cachedMembers = [];
        async function populateDatalists() {
            const [members, stewards, issues, schools] = await Promise.all([
                fetchCseaMembers(),
                fetchCseaStewards(),
                fetchCseaIssues(),
                fetchSchoolDirectory()
            ]);
            cachedMembers = members;
            const membersList = document.getElementById('members-list');
            membersList.innerHTML = members.map(m => `<option value="${m.name}">`).join('');
            const stewardsList = document.getElementById('stewards-list');
            stewardsList.innerHTML = stewards.map(s => `<option value="${s.name}">`).join('');
            const issuesList = document.getElementById('issues-list');
            issuesList.innerHTML = issues.map(i => `<option value="${i.issue_name}">`).join('');
            const schoolsList = document.getElementById('schools-list');
            schoolsList.innerHTML = schools.map(s => `<option value="${s.site_name}">`).join('');
        }
        const logMember = document.getElementById('log-member');
        if (logMember) {
            logMember.addEventListener('input', (e) => {
                const memberName = e.target.value;
                const member = cachedMembers.find(m => m.name === memberName);
                if (member && member.work_location) {
                    document.getElementById(`log-location`).value = member.work_location;
                }
            });
        }
        function createEntryElement(entry) {
            const div = document.createElement('div');
            div.className = 'note-entry';
            div.id = `entry-${entry.id}`;
            div.innerHTML = `
                <div class="entry-header">
                    <span>${formatDate(entry.created_at)}</span>
                    <span class="delete-btn" onclick="handleDeleteNote(${entry.id})">Delete</span>
                </div>
                <div class="entry-content" contenteditable="true" oninput="handleEditNote(event, ${entry.id})">${entry.content}</div>
            `;
            return div;
        }
        async function loadEntries() {
            const entries = await fetchCategoryEntries(CATEGORY);
            entriesList.innerHTML = '';
            entries.forEach(entry => {
                entriesList.appendChild(createEntryElement(entry));
            });

            // Load draft
            const draft = await fetchPlannerData(PERSISTENCE_KEY, 1);
            if (draft && draft.length > 0) {
                newNoteContent.value = draft[0].content;
            }
        }
        function handleDraftInput() {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await savePlannerData(PERSISTENCE_KEY, 'draft', newNoteContent.value);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }
        function handleEditNote(e, id) {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await updateCategoryEntry(id, e.target.innerText);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }
        async function handleAddNote() {
            const content = newNoteContent.value;
            if (!content.trim()) return;
            saveStatus.innerText = 'Saving...';
            const newEntry = await saveCategoryEntry(CATEGORY, content);
            if (newEntry) {
                newNoteContent.value = '';
                // Clear draft
                await savePlannerData(PERSISTENCE_KEY, 'draft', '');
                saveStatus.innerText = 'Saved';
                entriesList.prepend(createEntryElement(newEntry));
                setTimeout(() => { saveStatus.innerText = 'All changes saved'; }, 2000);
            } else {
                saveStatus.innerText = 'Error saving';
            }
        }
        async function handleDeleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                const success = await deleteCategoryEntry(id);
                if (success) {
                    document.getElementById(`entry-${id}`).remove();
                }
            }
        }
        // Interaction Log Functions
        async function loadInteractions() {
            const interactions = await fetchInteractions(CATEGORY);
            interactionLogBody.innerHTML = '';
            interactions.forEach(inter => {
                const type = detectType(inter);
                interactionLogBody.appendChild(createInteractionRow(inter, type));
            });
        }
        function detectType(inter) {
            // Priority: Explicitly saved type if it exists
            if (inter.explicit_type) return inter.explicit_type;
            // Heuristic based on discussion content
            const discussion = (inter.discussion || '').toLowerCase();
            const isInquiry = discussion.includes('lay off') || 
                             discussion.includes('handshake') || 
                             discussion.includes('salary study') || 
                             discussion.includes('seniority') || 
                             discussion.includes('fsa') || 
                             discussion.includes('invoice') || 
                             discussion.includes('lunch schedule') ||
                             discussion.includes('benefits') ||
                             discussion.includes('probation') ||
                             discussion.includes('transfer') ||
                             discussion.includes('vacation');
            return isInquiry ? 'Inquiry' : 'Grievance';
        }
        function createInteractionRow(inter, type) {
            // Move specific long messages to the outcome column if they are in contact_person
            const stringsToShift = [
                "When the seniority list gets printed, it has to be checked multiple times by different departments (some are short-staffed) to make sure all of our members are accounted for. These reports go to Letetsia first to review, and she catches many of the mistakes that appear",
                "District does not offer Golden Handshakes",
                "No lays off are happening, just involuntary movements"
            ];

            if (stringsToShift.includes(inter.contact_person)) {
                inter.outcome = inter.contact_person;
                inter.contact_person = '';
            }

            const tr = document.createElement('tr');
            tr.id = `inter-${inter.id}`;
            const reps = [inter.contact_person, inter.labor_rep].filter(Boolean).join(' / ');
            tr.innerHTML = `
                <td></td>
                <td>${formatDateMMM(inter.date_spoke)}</td>
                <td>${toTitleCase(inter.member_name)}</td>
                <td><span style="color: ${type === 'Grievance' ? '#cc0000' : '#2d5a45'}; font-weight: 600;">${type}</span></td>
                <td>${inter.member_number || ''}</td>
                <td>${toTitleCase(inter.work_location) || ''}</td>
                <td>${inter.discussion || ''}</td>
                <td>${toTitleCase(inter.who_involved) || ''}</td>
                <td>${toTitleCase(reps)}</td>
                <td>${inter.outcome || ''}</td>
                <td><span class="delete-btn" onclick="handleDeleteInteraction(${inter.id})">Delete</span></td>
            `;
            return tr;
        }
        async function handleAddInteraction() {
            const explicitType = document.getElementById('log-type').value;
            const interaction = {
                date_spoke: document.getElementById(`log-date`).value,
                member_name: document.getElementById(`log-member`).value,
                member_number: document.getElementById(`log-number`).value,
                work_location: document.getElementById(`log-location`).value,
                discussion: document.getElementById(`log-discussion`).value,
                who_involved: document.getElementById(`log-who`).value,
                contact_person: document.getElementById(`log-contact`).value,
                labor_rep: document.getElementById(`log-labor-rep`).value,
                outcome: document.getElementById(`log-outcome`).value
            };
            if (!interaction.date_spoke || !interaction.member_name) {
                alert('Date and Member Name are required');
                return;
            }
            if (explicitType !== 'Auto') {
                interaction.explicit_type = explicitType;
            }
            const newInter = await saveInteraction(CATEGORY, interaction);
            if (newInter) {
                loadInteractions(); 
                // Clear inputs
                const fields = ['date', 'member', 'number', 'location', 'discussion', 'who', 'contact', 'labor-rep', 'outcome'];
                fields.forEach(f => {
                    const el = document.getElementById(`log-${f}`);
                    if (el) el.value = '';
                });
                document.getElementById('log-type').value = 'Auto';
            }
        }
        async function handleDeleteInteraction(id) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                const success = await deleteInteraction(id);
                if (success) {
                    document.getElementById(`inter-${id}`).remove();
                }
            }
        }
        // Initialize
        loadEntries();
        loadInteractions();
        populateDatalists();
    </script>
</body>
</html>
