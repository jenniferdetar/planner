<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Csea - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root { 
            --soft-bg: #fdfcf0; 
            --header-blue: #00326b;
            --step-yellow: #ffcb32;
            --step-orange: #f39200;
            --step-lblue: #ade3f4;
            --step-mblue: #2b7eb3;
            --step-dblue: #00326b;
        }
        body { margin: 0; padding: 0; font-family: 'Coming Soon', cursive; background: #fff; }
        
        .content-area { padding: 0 !important; width: 100%; overflow: hidden !important; }
        
        /* Tabs Styling */
        .tabs-nav {
            display: flex;
            gap: 5px;
            padding: 10px 15px 0 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            padding: 8px 20px;
            border: 1px solid #ddd;
            border-bottom: none;
            background: #eee;
            cursor: pointer;
            font-family: 'Coming Soon', cursive;
            font-weight: 700;
            font-size: 10pt;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #fff;
            border-bottom: 2px solid #fff;
            margin-bottom: -1px;
            color: var(--header-blue);
        }
        .tab-content {
            display: none;
            padding: 15px;
        }
        .tab-content.active {
            display: block;
        }

        .view-section { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .handwriting, textarea, .planner-edit { font-family: 'Coming Soon', cursive; font-size: 10pt; color: #2c3e50; }
        
        .page-title { font-size: 10pt; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--header-blue); margin-bottom: 5px; border-bottom: 2px solid var(--header-blue); padding-bottom: 5px; text-align: center; }
        
        .save-btn { padding: 8px 25px; background-color: var(--header-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Segoe UI', sans-serif; font-weight: 600; font-size: 10pt; transition: opacity 0.2s; }
        .save-btn:hover { opacity: 0.9; }
        .save-status { font-size: 10pt; color: #888; }
        .delete-btn { cursor: pointer; color: #a4262c; font-size: 10pt; text-transform: uppercase; font-weight: 600; }

        /* Table styles for log */
        .special-table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        .special-table { border-collapse: collapse; width: 100%; font-size: 10pt; table-layout: auto; }
        .special-table th, .special-table td { border: 1px solid #eee; padding: 6px; text-align: left; vertical-align: top; }
        .special-table th { background: #f8f9fa; font-weight: 700; text-transform: uppercase; font-size: 10pt; }
        .log-input { width: 100%; border: 1px solid #eee; padding: 4px; font-family: 'Coming Soon', cursive; font-size: 10pt; border-radius: 4px; }
        .add-log-btn { padding: 5px 15px; background-color: var(--header-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10pt; font-weight: 600; }

        /* 610 Process Grid Styling */
        .reopener-container {
            background: #fff;
            padding: 20px;
            position: relative;
        }
        .reopener-header {
            background-color: var(--header-blue);
            color: white;
            padding: 15px 25px;
            font-size: 18pt;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 10px solid var(--step-yellow);
        }
        .reopener-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            column-gap: 25px;
            row-gap: 40px;
            position: relative;
        }
        .step-box {
            padding: 12px;
            border-radius: 8px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            min-height: 160px;
            z-index: 2;
        }
        /* Connecting lines */
        .step-box::after {
            content: '';
            position: absolute;
            background: #ddd;
            z-index: -1;
        }
        /* Horizontal lines */
        .step-box:not(:nth-child(4n))::after {
            width: 25px;
            height: 4px;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Vertical lines */
        .step-box:nth-child(4n):not(:last-child)::after {
            width: 4px;
            height: 40px;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .step-title {
            font-weight: 700;
            font-size: 8.5pt;
            line-height: 1.3;
            text-align: center;
            margin-bottom: 5px;
        }
        .step-policy {
            font-size: 7.5pt;
            text-align: center;
            font-weight: normal;
            margin-bottom: 8px;
        }
        .step-number-mid {
            font-size: 10pt;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .step-date-container {
            margin-top: auto;
            background: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            width: 90%;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .step-date-label {
            font-size: 8pt;
            font-weight: 700;
            color: #666;
        }
        .step-date-input {
            border: none;
            outline: none;
            width: 100%;
            font-family: 'Coming Soon', cursive;
            font-size: 8.5pt;
            background: transparent;
            text-align: center;
        }

        /* Row Colors */
        .row-yellow { background-color: var(--step-yellow); }
        .row-orange { background-color: var(--step-orange); color: #fff; }
        .row-lblue { background-color: var(--step-lblue); }
        .row-mblue { background-color: var(--step-mblue); color: #fff; }
        .row-dblue { background-color: var(--step-dblue); color: #fff; }
        
        .row-orange .step-date-label, .row-mblue .step-date-label, .row-dblue .step-date-label { color: #444; }

        /* Print Styles */
        @media print {
            @page {
                size: landscape;
                margin: 0.5cm;
            }
            body, html, .dashboard-container, .dashboard-main, .dashboard-body, .content-area {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
                overflow: visible !important;
                background: #fff !important;
            }
            .dashboard-sidebar, .dashboard-header, .tabs-nav, .save-status, .save-btn, #notes-log, #entries-list, .add-log-btn, .print-btn-hide {
                display: none !important;
            }
            #reopener {
                display: block !important;
                padding: 0 !important;
            }
            .view-section {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .reopener-header {
                margin-bottom: 15px !important;
                padding: 10px 20px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .reopener-grid {
                column-gap: 15px !important;
                row-gap: 20px !important;
            }
            .step-box {
                min-height: 130px !important;
                padding: 10px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .step-title { font-size: 7.5pt !important; }
            .step-policy { font-size: 6.5pt !important; }
            .step-number-mid { font-size: 9pt !important; margin-bottom: 5px !important; }
            .step-date-container { padding: 2px 5px !important; }
            .step-date-input { font-size: 7.5pt !important; }
        }
    </style>
</head>
<body>
    <div class="content-area">
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('notes-log')">Notes & Log</button>
            <button class="tab-btn" onclick="switchTab('reopener')">LA 500 Reopener</button>
        </div>

        <!-- Tab 1: Notes & Interaction Log -->
        <div id="notes-log" class="tab-content active">
            <div class="view-section">
                <div class="page-title">CSEA NOTES</div>
                <div class="new-note-area">
                    <textarea id="new-note-content" class="handwriting" placeholder="Start typing CSEA notes..." oninput="handleNoteDraftInput()" style="width: 100%; min-height: 200px; border: none; outline: none; background: transparent; resize: none;"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <button class="save-btn" onclick="handleAddNote()">Save Note</button>
                        <div id="save-status" class="save-status">All changes saved</div>
                    </div>
                </div>
            </div>

            <div class="view-section">
                <div class="page-title">MEMBER INTERACTION LOG</div>
                <div class="special-table-container">
                    <table class="special-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Member</th>
                                <th>Location</th>
                                <th>Discussion</th>
                                <th>Outcome</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="interaction-log-body"></tbody>
                        <tfoot>
                            <tr style="background: #fffde7;">
                                <td><input type="date" id="log-date" class="log-input"></td>
                                <td>
                                    <input type="text" id="log-member" class="log-input" placeholder="Name" list="members-list">
                                    <datalist id="members-list"></datalist>
                                </td>
                                <td>
                                    <input type="text" id="log-location" class="log-input" placeholder="Location" list="schools-list">
                                    <datalist id="schools-list"></datalist>
                                </td>
                                <td>
                                    <input type="text" id="log-discussion" class="log-input" placeholder="Issue" list="issues-list">
                                    <datalist id="issues-list"></datalist>
                                </td>
                                <td><input type="text" id="log-outcome" class="log-input" placeholder="Result"></td>
                                <td><button class="add-log-btn" onclick="handleAddInteraction()">Add</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div id="entries-list"></div>
        </div>

        <!-- Tab 2: LA 500 Reopener -->
        <div id="reopener" class="tab-content">
            <div class="reopener-container">
                <div class="reopener-header">
                    <span>610 PROCESS - SURVEY TO RATIFICATION</span>
                    <button class="save-btn print-btn-hide" onclick="window.print()" style="background: #fff; color: var(--header-blue); padding: 5px 15px; font-size: 10pt;">Print Chart</button>
                </div>
                
                <div class="reopener-grid" id="reopener-grid-container">
                    <!-- Grid items will be generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const displayDate = dateParam ? new Date(dateParam) : new Date();
        const currentYear = displayDate.getFullYear();
        const CATEGORY = `CSEA-${currentYear}`;
        const PERSISTENCE_KEY = `draft-note-${CATEGORY}`;
        const REOPENER_KEY = `csea-reopener-24-26`;
        
        const entriesList = document.getElementById('entries-list');
        const newNoteContent = document.getElementById('new-note-content');
        const saveStatus = document.getElementById('save-status');
        const interactionLogBody = document.getElementById('interaction-log-body');
        let saveTimeout = null;

        const reopenerSteps = [
            { id: 1, row: 'yellow', title: 'LRR review 610 process with bargaining team', policy: 'Policy 610.4' },
            { id: 2, row: 'yellow', title: 'Survey membership (successor contract) & analyze/prioritize survey', policy: 'Policy 610.5.01' },
            { id: 3, row: 'yellow', title: 'Analyze/prioritize surveys and write initial proposal', policy: '' },
            { id: 4, row: 'yellow', title: 'Forward initial proposal to field director through LRR for review', policy: 'Policy 610.5.02' },
            
            { id: 5, row: 'orange', title: 'Distribute initial proposal to membership', policy: '' },
            { id: 6, row: 'orange', title: 'Chapter to approve initial proposal', policy: 'Policy 610.5.01' },
            { id: 7, row: 'orange', title: 'Chapter forwards initial proposal to district for "sunshining"', policy: '' },
            { id: 8, row: 'orange', title: 'District "sunshines" chapter\'s initial proposal', policy: 'Gov. Code 3547 (a)(b)' },
            
            { id: 9, row: 'lblue', title: 'District "sunshines" its initial proposal', policy: 'Gov. Code 3547 (a)(b)' },
            { id: 10, row: 'lblue', title: 'Bargaining team review 610 process with district', policy: 'Policy 610.5' },
            { id: 11, row: 'lblue', title: 'Negotiations begins', policy: '' },
            { id: 12, row: 'lblue', title: 'Negotiations team shall provide bargaining updates after each session', policy: 'Policy 610.7.05' },
            
            { id: 13, row: 'mblue', title: 'Tentative agreement reached', policy: '' },
            { id: 14, row: 'mblue', title: 'Submit signed T.A. to LRR', policy: 'Policy 610.9.01' },
            { id: 15, row: 'mblue', title: 'LRR sends T.A. to field director for review', policy: 'Policy 610.9.02' },
            { id: 16, row: 'mblue', title: 'Field director reviews TA/issues 610 letter to chapter president', policy: 'Policy 610.9.01, and Policy 610.9.02' },
            
            { id: 17, row: 'dblue', title: '5 Day meeting notice sent to bargaining unit members with a copy of agreement or summary', policy: 'Policy 610.9.05 & Policy 610.09.06' },
            { id: 18, row: 'dblue', title: 'Ratification vote via secret ballot in accordance with chapter constitution', policy: 'Policy 610.10' },
            { id: 19, row: 'dblue', title: 'Chapter informs LRR of date agreement is ratified', policy: '' },
            { id: 20, row: 'dblue', title: 'Violations of ratification policies and practices', policy: 'Appeal Rights 4.10.12.02 & 4.10.13.06(b)' }
        ];

        // Initialize Global Sidebar/Header
        if (typeof setGlobalHeaderTitle === 'function') {
            setGlobalHeaderTitle(`CSEA NOTES ${currentYear}`);
        }

        async function init() {
            await Promise.all([loadEntries(), loadInteractions(), populateDatalists(), loadReopenerData()]);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        async function populateDatalists() {
            try {
                const [members, issues, schools] = await Promise.all([
                    fetchCseaMembers().catch(() => []),
                    fetchCseaIssues().catch(() => []),
                    fetchSchoolDirectory().catch(() => [])
                ]);
                document.getElementById('members-list').innerHTML = (members || []).map(m => `<option value="${m.name || m.full_name || ''}">`).join('');
                document.getElementById('issues-list').innerHTML = (issues || []).map(i => `<option value="${i.issue_name || ''}">`).join('');
                document.getElementById('schools-list').innerHTML = (schools || []).map(s => `<option value="${s.site_name || ''}">`).join('');
            } catch (e) { console.error(e); }
        }

        async function loadEntries() {
            const entries = await fetchCategoryEntries(CATEGORY);
            entriesList.innerHTML = '';
            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'view-section handwriting';
                div.style.position = 'relative';
                div.style.marginBottom = '20px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; font-size: 10pt; color: #888; margin-bottom: 5px;">
                        <span>${new Date(entry.created_at).toLocaleDateString()}</span>
                        <span class="delete-btn" onclick="handleDeleteNote(${entry.id})">Delete</span>
                    </div>
                    <div class="planner-edit" contenteditable="true" oninput="handleEditNote(event, ${entry.id})" style="outline: none;">${entry.content}</div>
                `;
                entriesList.appendChild(div);
            });

            const draft = await fetchPlannerData(PERSISTENCE_KEY, 1);
            if (draft && draft.length > 0) newNoteContent.value = draft[0].content;
        }

        async function loadInteractions() {
            const interactions = await fetchInteractions('CSEA');
            interactionLogBody.innerHTML = '';
            interactions.forEach(inter => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(inter.date_spoke).toLocaleDateString()}</td>
                    <td>${inter.member_name}</td>
                    <td>${inter.work_location}</td>
                    <td>${inter.discussion}</td>
                    <td>${inter.outcome || ''}</td>
                    <td><span class="delete-btn" onclick="handleDeleteInteraction(${inter.id})">X</span></td>
                `;
                interactionLogBody.appendChild(tr);
            });
        }

        async function loadReopenerData() {
            const data = await fetchPlannerData(REOPENER_KEY, 100);
            const dataMap = {};
            const tsRegex = /^\[\d{2}\/\d{2}\/\d{2}\s\d{2}:\d{2}\s[AP]M\]\s*/;
            data.forEach(item => {
                let clean = item.content || '';
                if (typeof clean === 'string') clean = clean.replace(tsRegex, '');
                dataMap[item.field_id] = clean;
            });

            const gridContainer = document.getElementById('reopener-grid-container');
            gridContainer.innerHTML = reopenerSteps.map(step => {
                const fieldId = `step-${step.id}-date`;
                const savedDate = dataMap[fieldId] || '';
                return `
                    <div class="step-box row-${step.row}">
                        <div class="step-title">${step.title}</div>
                        <div class="step-policy">${step.policy || '&nbsp;'}</div>
                        <div class="step-number-mid">${step.id}</div>
                        <div class="step-date-container">
                            <span class="step-date-label">Date:</span>
                            <input type="text" class="step-date-input" 
                                placeholder="mm/dd/yyyy"
                                data-field="${fieldId}"
                                value="${savedDate}"
                                oninput="handleReopenerSave(this)">
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleReopenerSave(el) {
            const fieldId = el.dataset.field;
            const content = el.value;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await savePlannerData(REOPENER_KEY, fieldId, content, true);
            }, 1000);
        }

        async function handleAddInteraction() {
            const date = document.getElementById('log-date').value;
            const member = document.getElementById('log-member').value;
            const loc = document.getElementById('log-location').value;
            const disc = document.getElementById('log-discussion').value;
            const out = document.getElementById('log-outcome').value;
            if (!date || !member) return;
            
            const success = await saveInteraction('CSEA', {
                date_spoke: date,
                member_name: member,
                work_location: loc,
                discussion: disc,
                outcome: out
            });
            if (success) {
                document.querySelectorAll('.log-input').forEach(i => i.value = '');
                loadInteractions();
            }
        }

        async function handleDeleteInteraction(id) {
            if (confirm('Delete interaction?')) {
                if (await deleteInteraction(id)) loadInteractions();
            }
        }

        function handleNoteDraftInput() {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const result = await savePlannerData(PERSISTENCE_KEY, 'draft', newNoteContent.value);
                if (result !== null) {
                    saveStatus.innerText = 'All changes saved';
                } else {
                    saveStatus.innerText = 'Error saving - check console';
                    saveStatus.style.color = '#a4262c';
                    setTimeout(() => { saveStatus.style.color = '#888'; }, 3000);
                }
            }, 1000);
        }

        function handleEditNote(e, id) {
            saveStatus.innerText = 'Unsaved changes';
            const content = e.target.innerText;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await updateCategoryEntry(id, content);
                if (success) {
                    saveStatus.innerText = 'All changes saved';
                } else {
                    saveStatus.innerText = 'Error saving - check console';
                    saveStatus.style.color = '#a4262c';
                    setTimeout(() => { saveStatus.style.color = '#888'; }, 3000);
                }
            }, 1000);
        }

        async function handleAddNote() {
            const content = newNoteContent.value;
            if (!content.trim()) return;
            saveStatus.innerText = 'Saving...';
            if (await saveCategoryEntry(CATEGORY, content)) {
                newNoteContent.value = '';
                await savePlannerData(PERSISTENCE_KEY, 'draft', '');
                saveStatus.innerText = 'Saved';
                loadEntries();
            } else {
                saveStatus.innerText = 'Error saving - check console';
                saveStatus.style.color = '#a4262c';
                setTimeout(() => { saveStatus.style.color = '#888'; }, 3000);
            }
        }

        async function handleDeleteNote(id) {
            if (confirm('Delete note?')) {
                if (await deleteCategoryEntry(id)) loadEntries();
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>