<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Csea - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Indie+Flower&family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --border-color: #e1dfdd;
            --section-sidebar-width: 60px;
        }
        /* CSEA Specific Styles */

        .notebook-page {
            width: 100%;
            padding: 10px !important;
            background: #fff;
            box-sizing: border-box;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .page-title {
            font-family: 'Coming Soon', cursive;
            font-size: 9pt;
            color: var(--header-blue);
            margin: 0 0 10px 0;
            letter-spacing: 3px;
            font-weight: 700;
            border-bottom: 1px solid #e1dfdd;
            padding-bottom: 10px;
            text-transform: uppercase;
        }

        .notes-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .input-group {
            background: #fdfdfd;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1dfdd;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        textarea {
            width: 100%;
            height: 120px;
            font-family: 'Coming Soon', cursive;
            font-size: 9pt;
            padding: 15px;
            border: 1px solid #e1dfdd;
            border-radius: 4px;
            line-height: 1.6;
            resize: vertical;
            box-sizing: border-box;
            outline: none;
            background: #fff;
        }

        .save-btn {
            align-self: flex-end;
            padding: 8px 25px;
            background-color: var(--header-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Coming Soon', cursive;
            font-weight: 600;
            font-size: 9pt;
            transition: opacity 0.2s;
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .note-entry {
            background: #fff;
            border: 1px solid #e1dfdd;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative;
            transition: box-shadow 0.2s;
        }
        .note-entry:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            font-size: 9pt;
            color: #a19f9d;
            margin-bottom: 12px;
            font-family: 'Coming Soon', cursive;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .entry-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-family: 'Coming Soon', cursive;
            font-size: 9pt;
            color: #333;
            outline: none;
        }

        .delete-btn {
            cursor: pointer;
            color: #a4262c;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .delete-btn:hover {
            opacity: 1;
        }

        .save-status-inline {
            font-size: 9pt;
            color: #a19f9d;
            height: 15px;
        }

        /* Interaction Log Table Styles */
        .log-section {
            margin-top: 50px;
            border-top: 2px solid #f3f2f1;
            padding-top: 30px;
        }

        .interaction-log-header {
            font-family: 'Coming Soon', cursive;
            font-weight: 700;
            margin-bottom: 20px;
            color: #323130;
            font-size: 9pt;
        }

        .log-table-container {
            width: 100%;
            overflow: auto;
            border: 1px solid #e1dfdd;
            border-radius: 4px;
            flex: 1;
            min-height: 0;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .log-table th {
            background-color: #f8f9fa;
            color: #323130;
            padding: 5px 8px;
            text-align: left;
            border-bottom: 2px solid #e1dfdd;
            border-right: 1px solid #eee;
            font-weight: 600;
            font-family: 'Coming Soon', cursive;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 9pt;
        }

        .log-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            vertical-align: top;
            font-family: 'Coming Soon', cursive;
            font-size: 9pt;
            color: #333;
        }

        .log-table tr:nth-child(even) {
            background-color: #fafafa;
        }

        .log-table tr:hover {
            background-color: #fdfdfd;
        }

        .log-input-row td {
            background-color: #fffde7;
            border-top: 2px solid #e1dfdd;
        }

        .log-input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 6px;
            box-sizing: border-box;
            font-family: 'Coming Soon', cursive;
            font-size: 9pt;
            border-radius: 2px;
        }

        .add-log-btn {
            background-color: #2b579a;
            color: white;
            border: none;
            padding: 6px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Coming Soon', cursive;
            font-weight: 600;
            font-size: 9pt;
        }
        .add-log-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div style="padding: 10px; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
        <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; flex: 1; min-height: 0;">
            <div class="notes-section">
                <div class="input-group">
                    <textarea id="new-note-content" placeholder="Type a new note here..." oninput="handleDraftInput()"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div id="save-status" class="save-status-inline">All changes saved</div>
                        <button class="save-btn" onclick="handleAddNote()">Save Note</button>
                    </div>
                </div>
                <div id="entries-list" class="entries-list">
                    <!-- Entries will be loaded here -->
                </div>
            </div>
            <div class="log-section" style="margin-top: 0; border-top: none; padding-top: 0; overflow-x: auto;">
                <h2 class="interaction-log-header">Member Interaction Log</h2>
                <div class="log-table-container">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th style="width: 20px;"></th>
                                <th>Date Spoke</th>
                                <th>Member Name</th>
                                <th>Type</th>
                                <th>Member Number</th>
                                <th>Site/Location</th>
                                <th>Discussion/Concern</th>
                                <th>Involved/Action</th>
                                <th>Union/Labor Rep</th>
                                <th>Outcome</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="interaction-log-body">
                            <!-- Existing interactions -->
                        </tbody>
                        <tfoot>
                            <tr class="log-input-row">
                                <td></td>
                                <td><input type="date" id="log-date" class="log-input"></td>
                                <td>
                                    <input type="text" id="log-member" class="log-input" placeholder="Name" list="members-list">
                                    <datalist id="members-list"></datalist>
                                </td>
                                <td>
                                    <select id="log-type" class="log-input">
                                        <option value="Auto">Auto-Detect</option>
                                        <option value="Grievance">Grievance</option>
                                        <option value="Inquiry">Inquiry</option>
                                    </select>
                                </td>
                                <td><input type="text" id="log-number" class="log-input" placeholder="Number"></td>
                                <td>
                                    <input type="text" id="log-location" class="log-input" placeholder="Location" list="schools-list">
                                    <datalist id="schools-list"></datalist>
                                </td>
                                <td>
                                    <input type="text" id="log-discussion" class="log-input" placeholder="Discussion" list="issues-list">
                                    <datalist id="issues-list"></datalist>
                                </td>
                                <td><input type="text" id="log-who" class="log-input" placeholder="Who involved"></td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <input type="text" id="log-contact" class="log-input" placeholder="Union Rep" list="stewards-list">
                                        <input type="text" id="log-labor-rep" class="log-input" placeholder="Labor Rep">
                                    </div>
                                </td>
                                <td><input type="text" id="log-outcome" class="log-input" placeholder="Outcome"></td>
                                <td><button class="add-log-btn" onclick="handleAddInteraction()">Add</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const currentYear = dateParam ? new Date(dateParam).getFullYear() : new Date().getFullYear();
        const CATEGORY = `CSEA-${currentYear}`;
        const PERSISTENCE_KEY = `draft-note-csea-${currentYear}`;

        const entriesList = document.getElementById('entries-list');
        const newNoteContent = document.getElementById('new-note-content');
        const saveStatus = document.getElementById('save-status');
        const interactionLogBody = document.getElementById('interaction-log-body');
        let saveTimeout = null;

        // Update Title
        setGlobalHeaderTitle(`CSEA NOTES ${currentYear}`);
        document.querySelector('.interaction-log-header').innerText = `Member Interaction Log ${currentYear}`;

        // Reference Data
        let cachedMembers = [];
        async function populateDatalists() {
            const [members, stewards, issues, schools] = await Promise.all([
                fetchCseaMembers(),
                fetchCseaStewards(),
                fetchCseaIssues(),
                fetchSchoolDirectory()
            ]);
            cachedMembers = members;
            const membersList = document.getElementById('members-list');
            membersList.innerHTML = members.map(m => `<option value="${m.name}">`).join('');
            const stewardsList = document.getElementById('stewards-list');
            stewardsList.innerHTML = stewards.map(s => `<option value="${s.name}">`).join('');
            const issuesList = document.getElementById('issues-list');
            issuesList.innerHTML = issues.map(i => `<option value="${i.issue_name}">`).join('');
            const schoolsList = document.getElementById('schools-list');
            schoolsList.innerHTML = schools.map(s => `<option value="${s.site_name}">`).join('');
        }
        const logMember = document.getElementById('log-member');
        if (logMember) {
            logMember.addEventListener('input', (e) => {
                const memberName = e.target.value;
                const member = cachedMembers.find(m => m.name === memberName);
                if (member && member.work_location) {
                    document.getElementById(`log-location`).value = member.work_location;
                }
            });
        }
        function createEntryElement(entry) {
            const div = document.createElement('div');
            div.className = 'note-entry';
            div.id = `entry-${entry.id}`;
            div.innerHTML = `
                <div class="entry-header">
                    <span>${formatDate(entry.created_at)}</span>
                    <span class="delete-btn" onclick="handleDeleteNote(${entry.id})">Delete</span>
                </div>
                <div class="entry-content" contenteditable="true" oninput="handleEditNote(event, ${entry.id})">${entry.content}</div>
            `;
            return div;
        }
        async function loadEntries() {
            const entries = await fetchCategoryEntries(CATEGORY);
            entriesList.innerHTML = '';
            entries.forEach(entry => {
                entriesList.appendChild(createEntryElement(entry));
            });

            // Load draft
            const draft = await fetchPlannerData(PERSISTENCE_KEY, 1);
            if (draft && draft.length > 0) {
                newNoteContent.value = draft[0].content;
            }
        }
        function handleDraftInput() {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const savedValue = await savePlannerData(PERSISTENCE_KEY, 'draft', newNoteContent.value);
                if (savedValue) {
                    saveStatus.innerText = 'All changes saved';
                    if (savedValue !== newNoteContent.value) {
                        newNoteContent.value = savedValue;
                    }
                } else {
                    saveStatus.innerText = 'Error saving';
                }
            }, 1000);
        }
        function handleEditNote(e, id) {
            saveStatus.innerText = 'Unsaved changes';
            const el = e.target;
            const content = el.innerText;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const savedValue = await updateCategoryEntry(id, content);
                if (savedValue) {
                    saveStatus.innerText = 'All changes saved';
                    if (savedValue !== content) {
                        el.innerText = savedValue;
                    }
                } else {
                    saveStatus.innerText = 'Error saving';
                }
            }, 1000);
        }
        async function handleAddNote() {
            const content = newNoteContent.value;
            if (!content.trim()) return;
            saveStatus.innerText = 'Saving...';
            const newEntry = await saveCategoryEntry(CATEGORY, content);
            if (newEntry) {
                newNoteContent.value = '';
                // Clear draft
                await savePlannerData(PERSISTENCE_KEY, 'draft', '');
                saveStatus.innerText = 'Saved';
                entriesList.prepend(createEntryElement(newEntry));
                setTimeout(() => { saveStatus.innerText = 'All changes saved'; }, 2000);
            } else {
                saveStatus.innerText = 'Error saving';
            }
        }
        async function handleDeleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                const success = await deleteCategoryEntry(id);
                if (success) {
                    document.getElementById(`entry-${id}`).remove();
                }
            }
        }
        // Interaction Log Functions
        async function loadInteractions() {
            let interactions = await fetchInteractions(CATEGORY);
            
            // Filter by current year
            interactions = interactions.filter(inter => {
                if (!inter.date_spoke) return false;
                const d = new Date(inter.date_spoke);
                return d.getFullYear() === currentYear;
            });

            interactionLogBody.innerHTML = '';
            interactions.forEach(inter => {
                const type = detectType(inter);
                interactionLogBody.appendChild(createInteractionRow(inter, type));
            });
        }
        function detectType(inter) {
            // Priority: Explicitly saved type if it exists
            if (inter.explicit_type) return inter.explicit_type;
            // Heuristic based on discussion content
            const discussion = (inter.discussion || '').toLowerCase();
            const isInquiry = discussion.includes('lay off') || 
                             discussion.includes('handshake') || 
                             discussion.includes('salary study') || 
                             discussion.includes('seniority') || 
                             discussion.includes('fsa') || 
                             discussion.includes('invoice') || 
                             discussion.includes('lunch schedule') ||
                             discussion.includes('benefits') ||
                             discussion.includes('probation') ||
                             discussion.includes('transfer') ||
                             discussion.includes('vacation');
            return isInquiry ? 'Inquiry' : 'Grievance';
        }
        function createInteractionRow(inter, type) {
            // Move specific long messages to the outcome column if they are in contact_person
            const stringsToShift = [
                "When the seniority list gets printed, it has to be checked multiple times by different departments (some are short-staffed) to make sure all of our members are accounted for. These reports go to Letetsia first to review, and she catches many of the mistakes that appear",
                "District does not offer Golden Handshakes",
                "No lays off are happening, just involuntary movements"
            ];

            if (stringsToShift.includes(inter.contact_person)) {
                inter.outcome = inter.contact_person;
                inter.contact_person = '';
            }

            const tr = document.createElement('tr');
            tr.id = `inter-${inter.id}`;
            const reps = [inter.contact_person, inter.labor_rep].filter(Boolean).join(' / ');
            tr.innerHTML = `
                <td></td>
                <td>${formatDateMMM(inter.date_spoke)}</td>
                <td>${toTitleCase(inter.member_name)}</td>
                <td><span style="color: ${type === 'Grievance' ? '#cc0000' : '#2d5a45'}; font-weight: 600;">${type}</span></td>
                <td>${inter.member_number || ''}</td>
                <td>${toTitleCase(inter.work_location) || ''}</td>
                <td>${inter.discussion || ''}</td>
                <td>${toTitleCase(inter.who_involved) || ''}</td>
                <td>${toTitleCase(reps)}</td>
                <td>${inter.outcome || ''}</td>
                <td><span class="delete-btn" onclick="handleDeleteInteraction(${inter.id})">Delete</span></td>
            `;
            return tr;
        }
        async function handleAddInteraction() {
            const explicitType = document.getElementById('log-type').value;
            const interaction = {
                date_spoke: document.getElementById(`log-date`).value,
                member_name: document.getElementById(`log-member`).value,
                member_number: document.getElementById(`log-number`).value,
                work_location: document.getElementById(`log-location`).value,
                discussion: document.getElementById(`log-discussion`).value,
                who_involved: document.getElementById(`log-who`).value,
                contact_person: document.getElementById(`log-contact`).value,
                labor_rep: document.getElementById(`log-labor-rep`).value,
                outcome: document.getElementById(`log-outcome`).value
            };
            if (!interaction.date_spoke || !interaction.member_name) {
                alert('Date and Member Name are required');
                return;
            }
            if (explicitType !== 'Auto') {
                interaction.explicit_type = explicitType;
            }
            const newInter = await saveInteraction(CATEGORY, interaction);
            if (newInter) {
                loadInteractions(); 
                // Clear inputs
                const fields = ['date', 'member', 'number', 'location', 'discussion', 'who', 'contact', 'labor-rep', 'outcome'];
                fields.forEach(f => {
                    const el = document.getElementById(`log-${f}`);
                    if (el) el.value = '';
                });
                document.getElementById('log-type').value = 'Auto';
            }
        }
        async function handleDeleteInteraction(id) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                const success = await deleteInteraction(id);
                if (success) {
                    document.getElementById(`inter-${id}`).remove();
                }
            }
        }
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEntries();
            loadInteractions();
            populateDatalists();
            updateNavigationLinks(dateParam || new Date());
        });
    </script>
</body>
</html>
