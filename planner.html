<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root { --soft-bg: #fdfcf0; }
        body { margin: 0; padding: 0; font-family: 'Coming Soon', cursive; height: 100vh; display: flex; overflow: hidden; color: var(--text-color); }
        #main-content-container { overflow-y: auto !important; padding: 0 !important; display: flex !important; flex: 1; }
        .notebook-page { 
            width: 100%; 
            margin: 0; 
            padding: 10px; 
            background: #fff; 
            box-sizing: border-box; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .view-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .handwriting, textarea, .editable-cell, .slot-content, .editable-area, .special-table td, .special-table th { font-family: 'Coming Soon', cursive; font-size: 12px; color: #2c3e50; }
        .page-title { font-size: 12px; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: var(--accent-color); margin-bottom: 5px; border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; text-align: center; }
        .page-meta { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; font-style: italic; }
        .text-wrap-clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 13px; max-height: 2.4em; word-break: break-word; }
        .special-table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        .special-table { border-collapse: collapse; width: 100%; font-size: 12px; table-layout: auto; }
        .special-table th, .special-table td { border: 1px solid #eee; padding: 0 6px; text-align: center; vertical-align: middle; height: 35px; }
        .special-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; font-size: 12px; text-transform: uppercase; height: 35px; }
        .text-left { text-align: left !important; }
        
        /* Column adjustments for auto layout */
        .special-table .clamp-wrapper {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 13px;
            max-height: 2.2em;
            word-break: break-word;
            margin: 0 auto;
        }
        .special-table .text-left .clamp-wrapper {
            margin: 0;
        }
        
        /* Category specific colors */
        .cat-auto { color: #27ae60; }
        .cat-bill { color: #2980b9; }
        .cat-cash { color: #8e44ad; }
        .cat-cc { color: #e67e22; }
        .cat-housing { color: #c0392b; }
        .cat-savings { color: #16a085; }
        .daily-columns { display: grid; gap: 2px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; flex: 1; }
        .day-col { display: flex; flex-direction: column; background: #fff; min-width: 0; }
        .day-header { text-align: center; padding: 8px; font-weight: 600; font-size: 12px; color: #fff; text-transform: uppercase; }
        .sun-header { background: #f59e9e; } .mon-header { background: #ffca38; } .tue-header { background: #a2d9d9; }
        .wed-header { background: #5d9cec; } .thu-header { background: #f59e9e; } .fri-header { background: #ffca38; } .sat-header { background: #a2d9d9; }
        .time-slot { height: auto; min-height: 35px; border-bottom: 1px dotted #eee; display: flex; align-items: center; padding: 4px 5px; font-size: 12px; }
        .time-label { width: 35px; color: #888; font-size: 12px; flex-shrink: 0; }
        .check-box { width: 14px; height: 14px; border: 1px solid #ccc; flex-shrink: 0; cursor: pointer; margin-right: 5px; border-radius: 2px; }
        .check-box.checked { background: var(--accent-color); position: relative; border-color: var(--accent-color); }
        .check-box.checked::after { content: '‚úì'; color: #fff; font-size: 10px; position: absolute; top: -1px; left: 2px; }
        .slot-content { flex-grow: 1; outline: none; min-height: 100%; display: flex; align-items: center; padding-left: 2px; overflow: visible; }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            border: 1px solid #eee; 
            margin-top: 10px; 
            flex: 1; 
            min-height: 0;
            grid-template-rows: auto repeat(6, 20%);
        }
        .calendar-header { background: #f8f9fa; padding: 2px; font-weight: 600; font-size: 12px; text-align: center; border: 0.5px solid #eee; }
        .calendar-day { 
            padding: 3px; 
            border: 0.5px solid #eee; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            gap: 1px; 
            overflow: hidden;
        }
        .day-number { font-size: 12px; font-weight: 600; color: #333; margin-bottom: 0px; line-height: 1; }
        .event-container { display: flex; flex-direction: column; gap: 1px; flex: 1; }
        .event-link { font-size: 12px; line-height: 13px; padding: 1px 3px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 2px; text-align: center; font-weight: 600; }
        .hub-pill {
            background-color: #4a3427;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-family: 'Coming Soon', cursive;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 12px;
            width: 100%;
            max-width: 350px;
            transition: all 0.2s;
        }
        .hub-pill:hover {
            background-color: #5d4437;
            transform: scale(1.02);
        }
        .hub-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="planner-content" class="notebook-page"></div>

    <script>
        const sections = {
            Home: { title: 'Home Page', views: ['Calendar', 'MonthlyFocus'] },
            'Work-Planner': { title: 'Work Planner', views: ['WorkPlanner'] },
            'Personal-Planner': { title: 'Personal Planner', views: ['PersonalPlanner'] },
            HOA: { title: 'HOA Notes', views: ['Notes'] },
            CSEA: { title: 'CSEA Hub', views: ['Notes', 'InteractionLog'] },
            ICAAP: { title: 'iCAAP Tracking', views: ['Notes'] },
            'ICAAP-Attendance': { title: 'Attendance Tracking', views: ['Attendance'] },
            'ICAAP-Paylog': { title: 'iCAAP Paylog Submissions', views: ['TrackingPaylog'] },
            'ICAAP-Hours': { title: 'iCAAP Hours Worked', views: ['TrackingHours'] },
            'ICAAP-Approval': { title: 'iCAAP Approval Dates', views: ['TrackingApproval'] },
            Finance: { title: 'Financial Planning', views: ['Budget', 'FinanceLinks'] },
            'Check-Breakdown': { title: 'Check Breakdown', views: ['CheckBreakdown', 'Notes'] },
            'Monthly-Review': { title: 'Financial Review', views: ['FinancialReview', 'Notes'] },
            Goals: { title: 'Yearly Goals', views: ['Notes', 'MonthlyFocus'] },
            Planning: { title: 'Planning & Review', views: ['Notes'] },
            Mantra: { title: 'Personal Mantras', views: ['Notes'] }
        };

        let employees = (typeof DEFAULT_EMPLOYEES !== 'undefined' ? DEFAULT_EMPLOYEES : [
            "Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin",
            "Rene Gaudet", "Steve Maccarone", "Zina Dixon"
        ]);
        let financialBills = [];
        const attnOptions = ["", "Cochren", "Beaudry", "Illness", "Kin Care", "Personal Necessity", "Vacation", "Bereavement"];
        const monthNames = ['July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June'];

        async function refreshGlobalData() {
            try {
                if (typeof fetchCseaMembers !== 'function') return;
                const [empData, billData, trackingNames] = await Promise.all([ 
                    fetchCseaMembers().catch(e => { console.error(e); return []; }), 
                    fetchFinancialBills().catch(e => { console.error(e); return []; }),
                    fetchAllTrackingNames(fiscalYear).catch(e => { console.error(e); return []; })
                ]);
                
                // Initialize nameSet with DEFAULT_EMPLOYEES or the hardcoded list
                const baseList = (typeof DEFAULT_EMPLOYEES !== 'undefined' ? DEFAULT_EMPLOYEES : [
                    "Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin",
                    "Rene Gaudet", "Steve Maccarone", "Zina Dixon"
                ]);
                const nameSet = new Set(baseList.map(toTitleCase));
                
                if (empData) empData.forEach(m => { const name = m.full_name || m.name; if (name) nameSet.add(toTitleCase(name)); });
                if (trackingNames) trackingNames.forEach(name => nameSet.add(toTitleCase(name)));
                
                employees = [...nameSet].sort();
                const billMap = new Map();
                if (typeof DEFAULT_BILLS !== 'undefined') DEFAULT_BILLS.forEach(b => billMap.set(b.item, b));
                if (billData) billData.forEach(b => billMap.set(b.item, b));
                financialBills = [...billMap.values()].sort((a, b) => (a.id || 0) - (b.id || 0));
                
                // Refresh views if we are on a page that uses employees
                if (currentCategory === 'ICAAP-Tracking' || currentCategory === 'ICAAP-Attendance') {
                    switchTab(currentCategory);
                }
            } catch (err) {
                console.error('Error in refreshGlobalData:', err);
            }
        }

        async function renderMonthlyFocus(container) {
            const isYearly = currentCategory === 'Goals';
            const key = isYearly ? `yearly-goals-${displayDate.getFullYear()}` : `monthly-focus-${displayDate.getFullYear()}-${displayDate.getMonth()+1}`;
            const title = isYearly ? 'YEARLY GOALS & DREAMS' : 'MONTHLY FOCUS';
            
            container.innerHTML = `
                <div class="page-title">${title}</div>
                <div style="margin-top: 20px;">
                    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 12px; margin-bottom: 10px; color: var(--accent-color);">${isYearly ? 'CORE GOALS' : 'KEY GOALS'}</div>
                        <textarea class="handwriting" data-field="goals" oninput="handleModuleEdit(this, '${key}')" style="width: 100%; min-height: 150px; border: none; background: transparent; resize: none;"></textarea>
                    </div>
                    <div style="margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 12px; margin-bottom: 10px; color: var(--accent-color);">${isYearly ? 'DREAMS & INTENTIONS' : 'NOTES & REFLECTIONS'}</div>
                        <textarea class="handwriting" data-field="reflections" oninput="handleModuleEdit(this, '${key}')" style="width: 100%; min-height: 200px; border: none; background: transparent; resize: none;"></textarea>
                    </div>
                </div>
            `;
            const data = await fetchPlannerData(key, 10);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }

        let currentCategory = 'Home';
        let saveTimeout = null;
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        let displayDate = dateParam ? new Date(dateParam) : new Date();
        if (dateParam && dateParam.includes('-')) {
            const [y, m, d] = dateParam.split('-').map(Number);
            displayDate = new Date(y, m - 1, d);
        }
        let currentYear = displayDate.getFullYear();
        let fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();

        function updateGlobalDate(newDate) {
            displayDate = newDate;
            currentYear = displayDate.getFullYear();
            fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();
            switchTab(currentCategory);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshGlobalData();
            const catParam = urlParams.get('category');
            if (catParam) {
                const matchingKey = Object.keys(sections).find(k => k.toLowerCase() === catParam.toLowerCase());
                if (matchingKey) currentCategory = matchingKey;
            }
            switchTab(currentCategory);
        });

        async function switchTab(tabId) {
            try {
                // Find matching section case-insensitively
                const matchingKey = Object.keys(sections).find(k => k.toLowerCase() === tabId.toLowerCase());
                currentCategory = matchingKey || tabId;
                
                const dateStr = displayDate.toISOString().split('T')[0];
                const newUrl = `planner.html?${currentCategory}&date=${dateStr}`;
                window.history.pushState({ category: currentCategory, date: dateStr }, '', newUrl);
                
                const config = sections[currentCategory];
                if (!config) {
                    console.error('No config found for category:', tabId);
                    return;
                }
                
                // Get element dynamically to handle DOM restructuring from shared.js
                const contentArea = document.getElementById('planner-content');
                if (!contentArea) {
                    console.warn('planner-content element not found, retrying in 100ms...');
                    setTimeout(() => switchTab(tabId), 100);
                    return;
                }
                
                contentArea.innerHTML = '<div class="handwriting" style="text-align: center; margin-top: 50px;">Loading...</div>';
                
                // Clear content and render all views vertically
                contentArea.innerHTML = '';
                for (const view of config.views) {
                    const viewContainer = document.createElement('div');
                    viewContainer.className = 'view-section';
                    viewContainer.style.marginBottom = '40px';
                    contentArea.appendChild(viewContainer);
                    await renderView(view, viewContainer);
                }
            } catch (err) {
                console.error('Error switching tab:', err);
                const contentArea = document.getElementById('planner-content');
                if (contentArea) {
                    contentArea.innerHTML = `<div class="handwriting" style="padding: 20px; color: red;">Error: ${err.message}</div>`;
                }
            }
        }

        async function renderView(viewType, container) {
            switch(viewType) {
                case 'Calendar': await renderCalendar(container); break;
                case 'MonthlyFocus': await renderMonthlyFocus(container); break;
                case 'WorkPlanner': await renderWorkPlanner(container); break;
                case 'PersonalPlanner': await renderPersonalPlanner(container); break;
                case 'Notes': await renderNotes(container); break;
                case 'InteractionLog': await renderCseaLog(container); break;
                case 'Attendance': await renderIcaapAttendance(container); break;
                case 'TrackingPaylog': await renderIcaapTracking(container, 'paylog'); break;
                case 'TrackingHours': await renderIcaapTracking(container, 'hours'); break;
                case 'TrackingApproval': await renderIcaapTracking(container, 'appr'); break;
                case 'CheckBreakdown': await renderCheckBreakdown(container); break;
                case 'FinancialReview': await renderFinancialReview(container); break;
                case 'Budget': await renderBudget(container); break;
                case 'FinanceLinks': await renderFinanceLinks(container); break;
                case 'iCAAPLinks': renderIcaapLinks(container); break;
                default: container.innerHTML = `<div style="padding:20px;">View ${viewType} not implemented</div>`;
            }
        }

        function renderWorkPlannerView() { switchTab('WorkPlanner'); }
        function renderPersonalPlannerView() { switchTab('PersonalPlanner'); }
        function renderIcaapAttendanceView() { switchTab('ICAAP-Attendance'); }
        function renderIcaapPaylogView() { switchTab('ICAAP-Paylog'); }
        function renderIcaapHoursView() { switchTab('ICAAP-Hours'); }
        function renderIcaapApprovalView() { switchTab('ICAAP-Approval'); }
        function renderCheckBreakdownView() { switchTab('Check-Breakdown'); }
        function renderFinancialReviewView() { switchTab('Monthly-Review'); }

        async function renderWorkPlanner(container) {
            const startDay = displayDate.getDay();
            const weekStart = new Date(displayDate);
            weekStart.setDate(weekStart.getDate() - startDay);
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(weekStart), fetchPlannerData(weekStart) ]);
            const timeSlots = []; for (let h = 6; h <= 21; h++) { timeSlots.push(`${h}:00`, `${h}:30`); } timeSlots.push('22:00');
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            
            container.innerHTML = `<div class="page-title">WORK PLANNER - WEEKLY VIEW</div><div id="planner-cols-weekly" class="daily-columns" style="grid-template-columns: repeat(7, 1fr);"></div>`;
            const cols = container.querySelector('#planner-cols-weekly');
            for (let i = 0; i < 7; i++) renderDayCol(cols, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses);
            
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
        }

        function renderDayCol(container, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses) {
            const dayDate = new Date(weekStart); dayDate.setDate(dayDate.getDate() + i); const dayStr = dayDate.toISOString().split('T')[0];
            const dayEvents = events.filter(e => e.date === dayStr);
            const dayCol = document.createElement('div'); dayCol.className = 'day-col';
            dayCol.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()} ${formatDateMMM(dayStr).toUpperCase()}</div>`;
            timeSlots.forEach(slot => {
                const isChecked = plannerData.some(d => d.date === dayStr && d.field_id === `check-slot-${slot}` && d.content === 'true');
                const saved = plannerData.find(d => d.date === dayStr && d.field_id === `slot-${slot}`);
                const eventTitle = getEventForSlot(dayEvents, slot, i);
                const slotDiv = document.createElement('div'); slotDiv.className = 'time-slot';
                slotDiv.innerHTML = `<div class="time-label">${formatTime(slot, true)}</div><div class="check-box${isChecked ? ' checked' : ''}" onclick="togglePlannerCheck(this, '${dayStr}', 'check-slot-${slot}')"></div><div class="slot-content ${eventTitle ? '' : 'planner-edit'} text-wrap-clamp" ${eventTitle ? '' : 'contenteditable="true"'} data-field="slot-${slot}" data-date="${dayStr}" style="font-size: 12px;">${eventTitle ? `<div class="${getEventClass(eventTitle)}">${eventTitle}</div>` : (saved ? saved.content : '')}</div>`;
                dayCol.appendChild(slotDiv);
            });
            container.appendChild(dayCol);
        }

        function getEventForSlot(events, slot, dayIndex) {
            const [h, m] = slot.split(':').map(Number);
            const slotMinutes = h * 60 + m;
            const event = events.find(e => {
                const [eh, em] = e.time.split(':').map(Number);
                const eventStart = eh * 60 + em;
                return slotMinutes >= eventStart && slotMinutes < eventStart + (e.duration || 30);
            });
            return event ? event.title : null;
        }

        async function renderCalendar(container) {
            const month = displayDate.getMonth(); const year = displayDate.getFullYear();
            const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay();
            const monthName = displayDate.toLocaleString('default', { month: 'long' });
            container.innerHTML = `<div class="page-title">${monthName.toUpperCase()} ${year}</div><div class="calendar-grid">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="calendar-header">${d}</div>`).join('')}${Array(startingDay).fill('').map(() => `<div class="calendar-day"></div>`).join('')}${Array(daysInMonth).fill(0).map((_, i) => { const d = i + 1; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; return `<div class="calendar-day" style="cursor: pointer;" onclick="updateGlobalDate(new Date(${year}, ${month}, ${d}))"><div style="font-weight: 600; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 12px;">${d}</div><div id="events-${dateStr}"></div></div>`; }).join('')}</div>`;
            const events = await fetchCalendarEvents(firstDay, daysInMonth);
            events.forEach(e => { const dc = container.querySelector('#events-' + e.date); if (dc) { const p = document.createElement('div'); p.className = 'event-link text-wrap-clamp'; p.innerText = e.title; dc.appendChild(p); } });
        }

        async function renderNotes(container) {
            const isIcaap = currentCategory.startsWith('iCAAP');
            const category = isIcaap ? `iCAAP-${fiscalYear}` : currentCategory;
            const persistenceKey = `draft-note-${category}`;
            
            container.innerHTML = `
                <div class="page-title">${currentCategory.toUpperCase()} NOTES</div>
                ${isIcaap ? `
                <div class="tracking-links-container" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <button class="event-link" onclick="renderIcaapAttendanceView()">üë§ Attendance</button>
                    <button class="event-link" onclick="renderIcaapPaylogView()">üìà Paylog</button>
                    <button class="event-link" onclick="renderIcaapHoursView()">‚è∞ Hours</button>
                    <button class="event-link" onclick="renderIcaapApprovalView()">‚úÖ Approval</button>
                </div>` : ''}
                <div class="new-note-area">
                    <textarea id="new-note-content" class="handwriting" placeholder="Start typing your notes here..." oninput="handleNoteDraftInput('${category}')" style="width: 100%; min-height: 200px; border: none; outline: none; background: transparent; resize: none;"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <button class="save-btn" onclick="handleAddNote('${category}')">Save Note</button>
                        <div id="save-status" class="save-status">All changes saved</div>
                    </div>
                </div>
                <div id="entries-list" style="margin-top: 20px;"></div>
            `;
            
            // Load draft
            const draft = await fetchPlannerData(persistenceKey, 1);
            if (draft && draft.length > 0) {
                document.getElementById('new-note-content').value = draft[0].content;
            }
            
            await loadEntries(container.querySelector('#entries-list'), category);
        }

        function handleNoteDraftInput(category) {
            const content = document.getElementById('new-note-content').value;
            const statusEl = document.getElementById('save-status');
            if (statusEl) statusEl.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (statusEl) statusEl.innerText = 'Saving...';
                const success = await savePlannerData(`draft-note-${category}`, 'draft', content);
                if (statusEl) statusEl.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        async function loadEntries(container, category) {
            const entries = await fetchCategoryEntries(category);
            container.innerHTML = '';
            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'view-section handwriting';
                div.style.position = 'relative';
                div.style.marginBottom = '20px';
                div.style.borderBottom = '1px solid #eee';
                div.style.paddingBottom = '10px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px;">
                        <span>${new Date(entry.created_at).toLocaleDateString()}</span>
                        <span style="cursor: pointer; color: #a4262c;" onclick="handleDeleteNote(${entry.id}, '${currentCategory}')">Delete</span>
                    </div>
                    <div class="planner-edit" contenteditable="true" oninput="handleEditNote(event, ${entry.id})" style="outline: none; font-size: 12px;">${entry.content}</div>
                `;
                container.appendChild(div);
            });
        }

        async function handleAddNote(category) {
            const content = document.getElementById('new-note-content').value;
            if (!content.trim()) return;
            const statusEl = document.getElementById('save-status');
            if (statusEl) statusEl.innerText = 'Saving...';
            const newEntry = await saveCategoryEntry(category, content);
            if (newEntry) {
                document.getElementById('new-note-content').value = '';
                await savePlannerData(`draft-note-${category}`, 'draft', '');
                if (statusEl) statusEl.innerText = 'Saved';
                switchTab(currentCategory);
            } else {
                if (statusEl) statusEl.innerText = 'Error saving';
            }
        }

        async function renderPersonalPlanner(container) {
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(displayDate), fetchPlannerData(displayDate) ]);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            
            container.innerHTML = `<div class="page-title">PERSONAL PLANNER - WEEKLY VIEW</div>
                <div class="habit-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    ${renderHabitSection('Self Care', ['Shower', 'Read', 'Bible App'])}
                    ${renderHabitSection('Home Care', ['Make beds', 'Laundry', 'Meals'])}
                </div>
                <div class="enjoy-banner" style="margin-bottom: 15px; text-align:center; font-weight:bold; color:#4a3427;">üè† ‚ù§ ENJOY YOUR FAMILY ‚ù§ üè†</div>
                <div id="personal-cols-weekly" class="daily-columns" style="grid-template-columns: repeat(7, 1fr);"></div>`;
            
            const cols = container.querySelector('#personal-cols-weekly');
            for (let i = 0; i < 7; i++) renderPersonalDay(cols, i, displayDate, plannerData, dayNames, dayClasses);
            
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
        }

        function renderPersonalDay(container, i, startDate, plannerData, dayNames, dayClasses) {
            const d = new Date(startDate); d.setDate(d.getDate() + i); const ds = d.toISOString().split('T')[0];
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()} ${formatDateMMM(ds).toUpperCase()}</div><div style="padding: 5px;"><div style="font-size: 12px; font-weight:bold;">Focus</div><div class="planner-edit handwriting" contenteditable="true" data-field="focus" data-date="${ds}" style="min-height: 40px; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 12px;">${plannerData.find(d => d.date === ds && d.field_id === 'focus')?.content || ''}</div><div style="font-size: 12px; font-weight:bold;">Notes</div><div class="planner-edit handwriting" contenteditable="true" data-field="notes" data-date="${ds}" style="min-height: 250px; font-size: 12px;">${plannerData.find(d => d.date === ds && d.field_id === 'notes')?.content || ''}</div></div>`;
            container.appendChild(col);
        }

        function renderHabitSection(title, habits) {
            return `<div style="padding: 5px; border: 1px solid #eee; border-radius: 5px;"><div style="font-size: 12px; margin-bottom: 5px; font-weight:bold; text-align:center;">${title}</div>${habits.map(h => `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px;"><span style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60px;">${h}</span><div style="display: flex; gap: 2px;">${[0,1,2,3,4,5,6].map(d => { const date = new Date(displayDate); date.setDate(date.getDate() - date.getDay() + d); const ds = date.toISOString().split('T')[0]; return `<div class="mini-day-box" style="width:8px; height:8px; border:1px solid #ccc; cursor:pointer;" data-field="habit-${h}" data-date="${ds}" onclick="toggleHabitCheck(this)"></div>`; }).join('')}</div></div>`).join('')}</div>`;
        }

        async function renderCseaLog(container) {
            container.innerHTML = `<div class="page-title">MEMBER INTERACTION LOG</div><div class="special-table-container"><table class="special-table"><thead><tr><th>Date</th><th>Member</th><th>Location</th><th>Discussion</th><th>Outcome</th><th></th></tr></thead><tbody id="interaction-log-body"></tbody><tfoot><tr><td><input type="date" id="log-date" style="width:100%; font-size:9pt;"></td><td><input type="text" id="log-member" placeholder="Name" style="width:100%; font-size:9pt;"></td><td><input type="text" id="log-location" placeholder="Loc" style="width:100%; font-size:9pt;"></td><td><input type="text" id="log-discussion" placeholder="Issue" style="width:100%; font-size:9pt;"></td><td><input type="text" id="log-outcome" placeholder="Result" style="width:100%; font-size:9pt;"></td><td><button onclick="handleAddInteraction()" style="font-size:9pt;">Add</button></td></tr></tfoot></table></div>`;
            const interactions = await fetchInteractions('CSEA'); const tbody = container.querySelector('#interaction-log-body');
            interactions.forEach(inter => { const tr = document.createElement('tr'); tr.innerHTML = `<td style="font-size: 12px;"><div class="clamp-wrapper">${formatDateMMM(inter.date_spoke)}</div></td><td style="font-size: 12px;"><div class="clamp-wrapper">${inter.member_name}</div></td><td style="font-size: 12px;"><div class="clamp-wrapper">${inter.work_location}</div></td><td style="font-size: 12px;" class="text-left"><div class="clamp-wrapper">${inter.discussion}</div></td><td style="font-size: 12px;" class="text-left"><div class="clamp-wrapper">${inter.outcome || ''}</div></td><td><button onclick="handleDeleteInteraction(${inter.id})" style="font-size:9pt;">X</button></td>`; tbody.appendChild(tr); });
        }

        async function handleAddInteraction() {
            const interaction = { date_spoke: document.getElementById('log-date').value, member_name: document.getElementById('log-member').value, work_location: document.getElementById('log-location').value, discussion: document.getElementById('log-discussion').value, outcome: document.getElementById('log-outcome').value };
            if (!interaction.date_spoke || !interaction.member_name) return;
            if (await saveInteraction('CSEA', interaction)) switchTab('CSEA');
        }

        async function handleDeleteInteraction(id) { if (confirm('Delete?')) { if (await deleteInteraction(id)) switchTab('CSEA'); } }

        function toggleHabitCheck(el) { el.classList.toggle('checked'); if (el.classList.contains('checked')) el.style.background = '#4a3427'; else el.style.background = 'transparent'; const { field, date } = el.dataset; savePlannerData(date, field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function handleAttendanceSave(select) { await savePlannerData(`icaap-attendance-data-${fiscalYear}`, select.dataset.field, select.value); }

        async function handleTrackingSave(el) {
            const name = el.dataset.name;
            const month = el.dataset.month;
            const type = el.dataset.type;
            const value = el.innerText;
            
            const tableMap = { 'paylog': 'paylog submission', 'hours': 'hours_worked', 'appr': 'approval_dates' };
            const tableName = tableMap[type];
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await saveTrackingData(tableName, name, month, value, fiscalYear);
            }, 1000);
        }

        async function changeAttendanceWeek(delta) { displayDate.setDate(displayDate.getDate() + (delta * 7)); switchTab('iCAAPAttendance'); }

        async function handlePlannerInput(el) {
            const fieldId = el.dataset.field || el.id; const content = el.innerText; const dateStr = el.dataset.date || displayDate.toISOString().split('T')[0];
            clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { await savePlannerData(dateStr, fieldId, content); }, 1000);
        }

        async function togglePlannerCheck(el, date, fieldId) { el.classList.toggle('checked'); await savePlannerData(date, fieldId, el.classList.contains('checked') ? 'true' : 'false'); }

        function renderIcaapLinks(container) { 
            container.innerHTML = `
                <div class="page-title">ICAAP LOGS</div>
                <div class="hub-container">
                    <button class="hub-pill" onclick="renderIcaapAttendanceView()">üë§ Attendance Tracking</button>
                    <button class="hub-pill" onclick="renderIcaapPaylogView()">üìà Paylog Submission</button>
                    <button class="hub-pill" onclick="renderIcaapHoursView()">‚è∞ Hours Worked</button>
                    <button class="hub-pill" onclick="renderIcaapApprovalView()">‚úÖ Approval Date</button>
                </div>`; 
        }
        function renderFinanceLinks(container) { 
            container.innerHTML = `
                <div class="page-title">FINANCIAL TOOLS</div>
                <div class="hub-container">
                    <button class="hub-pill" onclick="renderCheckBreakdownView()">üìä Check Breakdown</button>
                    <button class="hub-pill" onclick="renderFinancialReviewView()">üí∏ Financial Review</button>
                </div>`; 
        }

        async function renderBudget(container) {
            const months = ['J','A','S','O','N','D','J','F','M','A','M','J'];
            const headerHtml = `<th>Cat</th><th>Item</th><th>Amt</th>${months.map(m => `<th>${m}</th>`).join('')}`;
            
            container.innerHTML = `
                <div class="page-title">BUDGET PLANNING ${currentYear}</div>
                <div class="special-table-container">
                    <table class="special-table" style="width: 100%; table-layout: auto;">
                        <thead><tr>${headerHtml}</tr></thead>
                        <tbody id="budget-body"></tbody>
                    </table>
                </div>`;
            const tbody = container.querySelector('#budget-body');
            
            const catColors = {
                'Auto': '#fdf2f2',
                'Bill Pay': '#f2f9f2',
                'Cash': '#f2f2f9',
                'Credit Card': '#fff9f2',
                'Housing': '#f9f2f9',
                'Savings': '#f2f9f9'
            };

            financialBills.forEach(bill => { 
                const tr = document.createElement('tr'); 
                const bgColor = catColors[bill.cat] || 'transparent';
                tr.style.backgroundColor = bgColor;
                
                const monthCells = months.map((_, i) => `<td><div class="check-box" data-field="chk-${bill.id}-${i + 1}" onclick="toggleBudgetCheck(this)"></div></td>`).join('');
                tr.innerHTML = `
                    <td class="handwriting" style="font-size: 12px; vertical-align: middle;"><div style="word-wrap: break-word;">${bill.cat}</div></td>
                    <td class="text-left handwriting" style="font-size: 12px; vertical-align: middle;"><div style="word-wrap: break-word;">${bill.item}</div></td>
                    <td class="handwriting" style="font-size: 12px; vertical-align: middle;"><div>${bill.amt}</div></td>
                    ${monthCells}`; 
                tbody.appendChild(tr); 
            });
            
            const data = await fetchPlannerData(`${currentYear}-financial`, 366);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el && item.content === 'true') el.classList.add('checked'); });
        }

        function toggleBudgetCheck(el) { el.classList.toggle('checked'); savePlannerData(`${currentYear}-financial`, el.dataset.field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function renderIcaapAttendance(container) {
            const weekStart = new Date(displayDate); weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            const weekdays = []; for(let i=0; i<5; i++) { const d = new Date(weekStart); d.setDate(d.getDate() + i); weekdays.push(d); }
            
            container.innerHTML = `
                <div class="page-title">ATTENDANCE TRACKING</div>
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
                    <button onclick="changeAttendanceWeek(-1)">Prev Week</button>
                    <button onclick="changeAttendanceWeek(1)">Next Week</button>
                </div>
                <div class="special-table-container">
                    <table class="special-table" style="width: 100%; table-layout: auto;">
                        <thead>
                            <tr>
                                <th style="min-width: 100px; font-size: 12px;" class="sticky-col">Name</th>
                                ${weekdays.map(d => `<th style="font-size: 12px;">${d.toLocaleDateString('en-US', { weekday: 'short' })}<br>${formatDateMMM(d.toISOString().split('T')[0])}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="attn-body"></tbody>
                    </table>
                </div>`;

            const tbody = container.querySelector('#attn-body');
            employees.forEach(emp => {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `
                    <td class="sticky-col text-left" style="font-size: 12px; line-height: 13px; vertical-align: middle;">
                        <div style="word-wrap: break-word; max-width: 100px; white-space: normal;">${emp}</div>
                    </td>
                    ${weekdays.map(d => `<td><select class="attendance-select" data-field="attn-${emp}-${d.toISOString().split('T')[0]}" onchange="handleAttendanceSave(this)" style="font-size: 12px; width: 100%;">${attnOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select></td>`).join('')}`; 
                tbody.appendChild(tr);
            });
            const data = await fetchPlannerData(`icaap-attendance-data-${fiscalYear}`, 366);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }

        async function renderIcaapTracking(container, type = 'paylog') {
            const monthsToRender = monthNames;
            const typeLabels = { 'paylog': 'Paylog Submissions', 'hours': 'Hours Worked', 'appr': 'Approval Dates' };
            const typeTitle = typeLabels[type] || 'Tracking';
            
            container.innerHTML = `
                <div class="page-title">${typeTitle.toUpperCase()}</div>
                <div class="special-table-container" style="overflow: auto;">
                    <table class="special-table" style="width: 100%; table-layout: auto;">
                        <thead>
                            <tr>
                                <th style="min-width: 100px; font-size: 12px;" class="sticky-col">Name</th>
                                ${monthsToRender.map(m => `<th style="font-size: 12px;">${m.substring(0,3)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="track-body-${type}"></tbody>
                    </table>
                </div>`;

            const tbody = container.querySelector(`#track-body-${type}`);
            
            // Fetch specialized data
            let data = [];
            if (type === 'paylog') data = await fetchPaylogSubmissions(fiscalYear);
            else if (type === 'hours') data = await fetchHoursWorked(fiscalYear);
            else if (type === 'appr') data = await fetchApprovalDates(fiscalYear);

            // Merge with current employees list to ensure all are shown
            const nameMap = new Map();
            employees.forEach(name => nameMap.set(name, {}));
            if (data) {
                data.forEach(item => {
                    const name = toTitleCase(item.name || item.Name || '');
                    if (name) {
                        const existing = nameMap.get(name) || {};
                        nameMap.set(name, { ...existing, ...item });
                    }
                });
            }

            const sortedNames = [...nameMap.keys()].sort();

            sortedNames.forEach((name) => {
                const item = nameMap.get(name);
                const tr = document.createElement('tr'); 
                
                // Name cell with wrapping support and small font
                let nameHtml = `<td class="sticky-col text-left" style="font-size: 12px; line-height: 13px; vertical-align: middle;">
                                    <div style="word-wrap: break-word; max-width: 100px; white-space: normal;">${name}</div>
                                </td>`;
                
                const monthCells = monthsToRender.map((m) => {
                    const col = m.toLowerCase().substring(0, 3);
                    const val = item[col] || '';
                    return `<td contenteditable="true" class="editable-cell handwriting" 
                                data-name="${name}" data-month="${m}" data-type="${type}"
                                oninput="handleTrackingSave(this)" 
                                style="font-size: 12px; min-width: 30px; height: 30px; vertical-align: middle;">${val}</td>`;
                }).join('');
                
                tr.innerHTML = nameHtml + monthCells;
                tbody.appendChild(tr);
            });
        }

        async function handleEditNote(e, id) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await updateCategoryEntry(id, e.target.innerText);
            }, 1000);
        }

        async function handleDeleteNote(id, category) {
            if (confirm('Are you sure you want to delete this note?')) {
                const success = await deleteCategoryEntry(id);
                if (success) switchTab(category);
            }
        }

        async function renderCheckBreakdown(container) {
            container.innerHTML = `<div class="page-title">CHECK BREAKDOWN</div><div class="special-table-container"><table class="special-table"><thead><tr id="check-header"><th class="sticky-col">Account</th></tr></thead><tbody id="check-body"><tr><td class="sticky-col text-left">Checking</td></tr><tr><td class="sticky-col text-left">Jennifer Check</td></tr><tr><td class="sticky-col text-left">Tithe</td></tr><tr><td class="sticky-col text-left">Left Over</td></tr></tbody></table></div>`;
            const header = container.querySelector('#check-header'); const tbody = container.querySelector('#check-body');
            const payDates = ['1/5/2026', '1/20/2026', '2/5/2026', '2/20/2026', '3/5/2026', '3/20/2026', '4/5/2026', '4/20/2026', '5/5/2026', '5/20/2026', '6/5/2026', '6/20/2026'];
            payDates.forEach((pd, i) => {
                const th = document.createElement('th'); th.innerText = pd; header.appendChild(th);
                tbody.querySelectorAll('tr').forEach((tr, ri) => { const td = document.createElement('td'); td.contentEditable = true; td.className = 'editable-cell'; td.dataset.field = `chk-${i}-${ri}`; td.oninput = (e) => handleModuleEdit(e.target, `check-breakdown-${currentYear}`); tr.appendChild(td); });
            });
            const data = await fetchPlannerData(`check-breakdown-${currentYear}`, 100);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.innerText = item.content; });
        }

        async function handleModuleEdit(el, pk) {
            const fieldId = el.dataset.field || el.id;
            const content = el.innerText || el.value;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const savedValue = await savePlannerData(pk, fieldId, content);
                if (savedValue && savedValue !== content) {
                    if (el.innerText !== undefined) el.innerText = savedValue;
                    else el.value = savedValue;
                }
            }, 1000);
        }

        async function renderFinancialReview(container) {
            container.innerHTML = `<div class="page-title">FINANCIAL REVIEW</div><div style="display:grid; grid-template-columns:1fr; gap:10px;">${['Goals', 'Expenses', 'Savings'].map(t => `<div style="border:1px solid #eee; padding:10px;"><div style="font-weight:bold; font-size:9pt; margin-bottom:5px;">${t}</div><textarea class="handwriting" data-field="fin-${t.toLowerCase()}" oninput="handleModuleEdit(this, 'fin-review-${currentYear}')" style="width: 100%; min-height: 80px; border: none; background: transparent; resize:none;"></textarea></div>`).join('')}</div>`;
            const data = await fetchPlannerData(`fin-review-${currentYear}`, 10);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }
    </script>
</body>
</html>
