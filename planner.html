<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root { --soft-bg: #fdfcf0; }
        body { margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; overflow: hidden; color: var(--text-color); }
        #main-content-container { flex-direction: column !important; overflow-y: auto !important; padding: 0 !important; display: flex !important; flex: 1; }
        .view-pane { 
            flex: 1; 
            background: #fff; 
            margin: 0 !important; 
            padding: 15px !important; 
            overflow-y: auto !important; 
            position: relative; 
            border-radius: 0 !important; 
            box-shadow: none !important; 
            height: 100%;
            scrollbar-width: thin;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }
        #left-pane-content { padding-right: 55px !important; }
        #right-pane-content { padding-left: 55px !important; }

        .handwriting, textarea, .editable-cell, .slot-content, .editable-area, .special-table td, .special-table th { font-family: 'Coming Soon', cursive; font-size: 7.5pt; color: #2c3e50; }
        .page-title { font-size: 10pt; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--accent-color); margin-bottom: 5px; border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; text-align: center; }
        .page-meta { font-size: 8pt; color: #888; text-align: center; margin-bottom: 15px; font-style: italic; }
        .text-wrap-clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; max-height: 2.4em; word-break: break-word; }
        .special-table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        .special-table { border-collapse: collapse; width: 100%; font-size: 7pt; table-layout: auto; }
        .special-table th, .special-table td { border: 1px solid #eee; padding: 2px 3px; text-align: center; vertical-align: middle; }
        .special-table th { background: #f8f9fa; font-weight: 700; position: sticky; top: 0; z-index: 10; font-size: 7pt; text-transform: uppercase; }
        .text-left { text-align: left !important; }
        
        /* Column adjustments for auto layout */
        .special-table .clamp-wrapper {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
            max-height: 2.2em;
            word-break: break-word;
            margin: 0 auto;
        }
        .special-table .text-left .clamp-wrapper {
            margin: 0;
        }
        
        /* Category specific colors */
        .cat-auto { color: #27ae60; }
        .cat-bill { color: #2980b9; }
        .cat-cash { color: #8e44ad; }
        .cat-cc { color: #e67e22; }
        .cat-housing { color: #c0392b; }
        .cat-savings { color: #16a085; }
        .daily-columns { display: grid; gap: 2px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; flex: 1; }
        .day-col { display: flex; flex-direction: column; background: #fff; min-width: 0; }
        .day-header { text-align: center; padding: 8px; font-weight: 700; font-size: 8pt; color: #fff; text-transform: uppercase; }
        .sun-header { background: #f59e9e; } .mon-header { background: #ffca38; } .tue-header { background: #a2d9d9; }
        .wed-header { background: #5d9cec; } .thu-header { background: #f59e9e; } .fri-header { background: #ffca38; } .sat-header { background: #a2d9d9; }
        .time-slot { height: 35px; border-bottom: 1px dotted #eee; display: flex; align-items: center; padding: 2px 5px; font-size: 8pt; }
        .time-label { width: 35px; color: #888; font-size: 7pt; flex-shrink: 0; }
        .check-box { width: 14px; height: 14px; border: 1px solid #ccc; flex-shrink: 0; cursor: pointer; margin-right: 5px; border-radius: 2px; }
        .check-box.checked { background: var(--accent-color); position: relative; border-color: var(--accent-color); }
        .check-box.checked::after { content: '‚úì'; color: #fff; font-size: 10px; position: absolute; top: -1px; left: 2px; }
        .slot-content { flex-grow: 1; outline: none; min-height: 100%; display: flex; align-items: center; padding-left: 2px; overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #eee; margin-top: 10px; flex: 1; }
        .calendar-header { background: #f8f9fa; padding: 5px; font-weight: 700; font-size: 8pt; text-align: center; border: 0.5px solid #eee; }
        .calendar-day { 
            min-height: 80px; 
            padding: 3px; 
            border: 0.5px solid #eee; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            gap: 1px; 
            overflow: hidden;
        }
        .day-number { font-size: 8pt; font-weight: 700; color: #333; margin-bottom: 0px; line-height: 1; }
        .event-container { display: flex; flex-direction: column; gap: 1px; overflow-y: auto; flex: 1; }
        .event-link { font-size: 7pt; line-height: 1.1; padding: 1px 3px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 2px; text-align: center; font-weight: 500; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content" id="main-content-container">
            <div class="notebook-spread">
                <div class="view-pane" id="left-pane-content"></div>
                <div class="view-pane" id="right-pane-content"></div>
            </div>
        </div>
    </div>

    <script>
        const sections = {
            Home: { title: 'Home Page', leftView: 'Calendar', rightView: 'MonthlyFocus' },
            'Work-Planner': { title: 'Work Planner', leftView: 'WorkPlannerLeft', rightView: 'WorkPlannerRight' },
            'Personal-Planner': { title: 'Personal Planner', leftView: 'PersonalPlannerLeft', rightView: 'PersonalPlannerRight' },
            HOA: { title: 'HOA Notes', leftView: 'NotesLeft', rightView: 'NotesRight' },
            CSEA: { title: 'CSEA Hub', leftView: 'NotesLeft', rightView: 'InteractionLog' },
            iCAAP: { title: 'iCAAP Tracking', leftView: 'NotesLeft', rightView: 'iCAAPLinks' },
            'ICAAP-Attendance': { title: 'Attendance Tracking', leftView: 'AttendanceLeft', rightView: 'AttendanceRight' },
            'ICAAP-Tracking': { title: 'iCAAP Tracking Log', leftView: 'TrackingLogLeft', rightView: 'TrackingLogRight' },
            Finance: { title: 'Financial Planning', leftView: 'BudgetLeft', rightView: 'BudgetRight' },
            'Check-Breakdown': { title: 'Check Breakdown', leftView: 'CheckBreakdown', rightView: 'NotesRight' },
            'Monthly-Review': { title: 'Financial Review', leftView: 'FinancialReview', rightView: 'NotesRight' },
            Goals: { title: 'Yearly Goals', leftView: 'NotesLeft', rightView: 'MonthlyFocus' },
            Planning: { title: 'Planning & Review', leftView: 'NotesLeft', rightView: 'NotesRight' }
        };

        let employees = (typeof DEFAULT_EMPLOYEES !== 'undefined' ? DEFAULT_EMPLOYEES : [
            "Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin",
            "Rene Gaudet", "Steve Maccarone", "Zina Dixon"
        ]);
        let financialBills = [];
        const attnOptions = ["", "Cochren", "Beaudry", "Illness", "Kin Care", "Personal Necessity", "Vacation", "Bereavement"];
        const monthNames = ['July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June'];

        async function refreshGlobalData() {
            try {
                if (typeof fetchCseaMembers !== 'function') return;
                const [empData, billData, trackingNames] = await Promise.all([ 
                    fetchCseaMembers().catch(e => { console.error(e); return []; }), 
                    fetchFinancialBills().catch(e => { console.error(e); return []; }),
                    fetchAllTrackingNames(fiscalYear).catch(e => { console.error(e); return []; })
                ]);
                
                // Initialize nameSet with DEFAULT_EMPLOYEES or the hardcoded list
                const baseList = (typeof DEFAULT_EMPLOYEES !== 'undefined' ? DEFAULT_EMPLOYEES : [
                    "Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin",
                    "Rene Gaudet", "Steve Maccarone", "Zina Dixon"
                ]);
                const nameSet = new Set(baseList.map(toTitleCase));
                
                if (empData) empData.forEach(m => { const name = m.full_name || m.name; if (name) nameSet.add(toTitleCase(name)); });
                if (trackingNames) trackingNames.forEach(name => nameSet.add(toTitleCase(name)));
                
                employees = [...nameSet].sort();
                const billMap = new Map();
                if (typeof DEFAULT_BILLS !== 'undefined') DEFAULT_BILLS.forEach(b => billMap.set(b.item, b));
                if (billData) billData.forEach(b => billMap.set(b.item, b));
                financialBills = [...billMap.values()].sort((a, b) => (a.id || 0) - (b.id || 0));
                
                // Refresh views if we are on a page that uses employees
                if (currentCategory === 'ICAAP-Tracking' || currentCategory === 'ICAAP-Attendance') {
                    switchTab(currentCategory);
                }
            } catch (err) {
                console.error('Error in refreshGlobalData:', err);
            }
        }

        async function renderMonthlyFocus(container) {
            const isYearly = currentCategory === 'Goals';
            const key = isYearly ? `yearly-goals-${displayDate.getFullYear()}` : `monthly-focus-${displayDate.getFullYear()}-${displayDate.getMonth()+1}`;
            const title = isYearly ? 'YEARLY GOALS & DREAMS' : 'MONTHLY FOCUS';
            
            container.innerHTML = `
                <div class="page-title">${title}</div>
                <div style="margin-top: 20px;">
                    <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 700; font-size: 10pt; margin-bottom: 10px; color: var(--accent-color);">${isYearly ? 'CORE GOALS' : 'KEY GOALS'}</div>
                        <textarea class="handwriting" data-field="goals" oninput="handleModuleEdit(this, '${key}')" style="width: 100%; min-height: 150px; border: none; background: transparent; resize: none;"></textarea>
                    </div>
                    <div style="margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 700; font-size: 10pt; margin-bottom: 10px; color: var(--accent-color);">${isYearly ? 'DREAMS & INTENTIONS' : 'NOTES & REFLECTIONS'}</div>
                        <textarea class="handwriting" data-field="reflections" oninput="handleModuleEdit(this, '${key}')" style="width: 100%; min-height: 200px; border: none; background: transparent; resize: none;"></textarea>
                    </div>
                </div>
            `;
            const data = await fetchPlannerData(key, 10);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }

        let currentCategory = 'Home';
        const leftPage = document.getElementById('left-pane-content');
        const rightPage = document.getElementById('right-pane-content');
        let saveTimeout = null;
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        let displayDate = dateParam ? new Date(dateParam) : new Date();
        if (dateParam && dateParam.includes('-')) {
            const [y, m, d] = dateParam.split('-').map(Number);
            displayDate = new Date(y, m - 1, d);
        }
        let currentYear = displayDate.getFullYear();
        let fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();

        function updateGlobalDate(newDate) {
            displayDate = newDate;
            currentYear = displayDate.getFullYear();
            fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();
            switchTab(currentCategory);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshGlobalData();
            const catParam = urlParams.get('category');
            if (catParam && sections[catParam]) currentCategory = catParam;
            switchTab(currentCategory);
        });

        async function switchTab(tabId) {
            try {
                const panes = document.querySelectorAll('.view-pane');
                const direction = 'next'; // Sidebar navigation is usually "forward"
                const targetPane = panes[panes.length - 1]; // Target right page for forward flip
                
                if (targetPane && (targetPane.classList.contains('flip-in-next') || targetPane.classList.contains('flip-in-prev'))) {
                    targetPane.classList.remove('flip-in-next', 'flip-in-prev');
                    targetPane.classList.add(`flip-out-${direction}`);
                    await new Promise(resolve => setTimeout(resolve, 600));
                }

                currentCategory = tabId;
                const dateStr = displayDate.toISOString().split('T')[0];
                const newUrl = `planner.html?category=${tabId}&date=${dateStr}`;
                window.history.pushState({ category: tabId, date: dateStr }, '', newUrl);
                document.querySelectorAll('.tab').forEach(t => {
                    const text = t.innerText.toLowerCase();
                    t.classList.toggle('active', 
                        text === tabId.toLowerCase() || 
                        (text === 'plan' && (tabId === 'Planning' || tabId === 'Goals' || tabId.startsWith('ICAAP'))) ||
                        (text === 'finance' && (tabId === 'Finance' || tabId === 'Check-Breakdown' || tabId === 'Monthly-Review'))
                    );
                });
                const config = sections[tabId];
                if (!config) {
                    console.error('No config found for category:', tabId);
                    return;
                }
                leftPage.innerHTML = '<div class="handwriting" style="text-align: center; margin-top: 50%;">Loading...</div>';
                rightPage.innerHTML = '';
                await renderView(config.leftView, leftPage);
                await renderView(config.rightView, rightPage);

                if (targetPane) {
                    targetPane.classList.remove(`flip-out-${direction}`);
                }
            } catch (err) {
                console.error('Error switching tab:', err);
                leftPage.innerHTML = `<div class="handwriting" style="padding: 20px; color: red;">Error: ${err.message}</div>`;
            }
        }

        async function renderView(viewType, container) {
            switch(viewType) {
                case 'Calendar': await renderCalendar(container); break;
                case 'MonthlyFocus': await renderMonthlyFocus(container); break;
                case 'WorkPlannerLeft': await renderWorkPlanner(container, 'left'); break;
                case 'WorkPlannerRight': await renderWorkPlanner(container, 'right'); break;
                case 'PersonalPlannerLeft': await renderPersonalPlanner(container, 'left'); break;
                case 'PersonalPlannerRight': await renderPersonalPlanner(container, 'right'); break;
                case 'NotesLeft': await renderNotes(container, 'left'); break;
                case 'NotesRight': await renderNotes(container, 'right'); break;
                case 'InteractionLog': await renderCseaLog(container); break;
                case 'AttendanceLeft': await renderIcaapAttendance(container, 'left'); break;
                case 'AttendanceRight': await renderIcaapAttendance(container, 'right'); break;
                case 'TrackingLogLeft': await renderIcaapTracking(container, 'left'); break;
                case 'TrackingLogRight': await renderIcaapTracking(container, 'right'); break;
                case 'CheckBreakdown': await renderCheckBreakdown(container); break;
                case 'FinancialReview': await renderFinancialReview(container); break;
                case 'BudgetLeft': await renderBudget(container, 'left'); break;
                case 'BudgetRight': await renderBudget(container, 'right'); break;
                case 'FinanceLinks': await renderFinanceLinks(container); break;
                default: container.innerHTML = `<div style="padding:20px;">View ${viewType} not implemented</div>`;
            }
        }

        function renderWorkPlannerView() { switchTab('WorkPlanner'); }
        function renderPersonalPlannerView() { switchTab('PersonalPlanner'); }
        function renderIcaapAttendanceView() { switchTab('ICAAP-Attendance'); }
        function renderIcaapTrackingView() { switchTab('ICAAP-Tracking'); }
        function renderCheckBreakdownView() { switchTab('Check-Breakdown'); }
        function renderFinancialReviewView() { switchTab('Monthly-Review'); }

        async function renderWorkPlanner(container, side) {
            const startDay = displayDate.getDay();
            const weekStart = new Date(displayDate);
            weekStart.setDate(weekStart.getDate() - startDay);
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(weekStart), fetchPlannerData(weekStart) ]);
            const timeSlots = []; for (let h = 6; h <= 21; h++) { timeSlots.push(`${h}:00`, `${h}:30`); } timeSlots.push('22:00');
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            if (side === 'left') {
                container.innerHTML = `<div class="page-title">WORK PLANNER - SUN-TUE</div><div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;"><div class="top-section"><div class="section-title">Priority #1</div><div class="editable-area planner-edit handwriting" contenteditable="true" id="priority-1" data-field="priority-1"></div></div><div class="top-section"><div class="section-title">Priority #2</div><div class="editable-area planner-edit handwriting" contenteditable="true" id="priority-2" data-field="priority-2"></div></div></div><div id="planner-cols-left" class="daily-columns" style="grid-template-columns: repeat(3, 1fr);"></div>`;
                const startStr = weekStart.toISOString().split('T')[0];
                plannerData.forEach(item => { if (item.date === startStr) { const el = container.querySelector('#' + item.field_id); if (el) el.innerText = item.content; } });
                const cols = container.querySelector('#planner-cols-left');
                for (let i = 0; i < 3; i++) renderDayCol(cols, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses);
            } else {
                container.innerHTML = `<div class="page-title">WORK PLANNER - WED-SAT</div><div id="planner-cols-right" class="daily-columns" style="grid-template-columns: repeat(4, 1fr);"></div>`;
                const cols = container.querySelector('#planner-cols-right');
                for (let i = 3; i < 7; i++) renderDayCol(cols, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses);
            }
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
        }

        function renderDayCol(container, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses) {
            const dayDate = new Date(weekStart); dayDate.setDate(dayDate.getDate() + i); const dayStr = dayDate.toISOString().split('T')[0];
            const dayEvents = events.filter(e => e.date === dayStr);
            const dayCol = document.createElement('div'); dayCol.className = 'day-col';
            dayCol.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()} ${formatDateMMM(dayStr).toUpperCase()}</div>`;
            timeSlots.forEach(slot => {
                const isChecked = plannerData.some(d => d.date === dayStr && d.field_id === `check-slot-${slot}` && d.content === 'true');
                const saved = plannerData.find(d => d.date === dayStr && d.field_id === `slot-${slot}`);
                const eventTitle = getEventForSlot(dayEvents, slot, i);
                const slotDiv = document.createElement('div'); slotDiv.className = 'time-slot';
                slotDiv.innerHTML = `<div class="time-label">${formatTime(slot, true)}</div><div class="check-box${isChecked ? ' checked' : ''}" onclick="togglePlannerCheck(this, '${dayStr}', 'check-slot-${slot}')"></div><div class="slot-content ${eventTitle ? '' : 'planner-edit'} text-wrap-clamp" ${eventTitle ? '' : 'contenteditable="true"'} data-field="slot-${slot}" data-date="${dayStr}" style="font-size: 0.9rem;">${eventTitle ? `<div class="${getEventClass(eventTitle)}">${eventTitle}</div>` : (saved ? saved.content : '')}</div>`;
                dayCol.appendChild(slotDiv);
            });
            container.appendChild(dayCol);
        }

        function getEventForSlot(events, slot, dayIndex) {
            const [h, m] = slot.split(':').map(Number);
            const slotMinutes = h * 60 + m;
            const event = events.find(e => {
                const [eh, em] = e.time.split(':').map(Number);
                const eventStart = eh * 60 + em;
                return slotMinutes >= eventStart && slotMinutes < eventStart + (e.duration || 30);
            });
            return event ? event.title : null;
        }

        async function renderCalendar(container) {
            const month = displayDate.getMonth(); const year = displayDate.getFullYear();
            const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay();
            const monthName = displayDate.toLocaleString('default', { month: 'long' });
            container.innerHTML = `<div class="page-title">${monthName.toUpperCase()} ${year}</div><div class="calendar-grid">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="calendar-header">${d}</div>`).join('')}${Array(startingDay).fill('').map(() => `<div class="calendar-day"></div>`).join('')}${Array(daysInMonth).fill(0).map((_, i) => { const d = i + 1; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; return `<div class="calendar-day" style="cursor: pointer;" onclick="updateGlobalDate(new Date(${year}, ${month}, ${d}))"><div style="font-weight: 700; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 8pt;">${d}</div><div id="events-${dateStr}"></div></div>`; }).join('')}</div>`;
            const events = await fetchCalendarEvents(firstDay, daysInMonth);
            events.forEach(e => { const dc = container.querySelector('#events-' + e.date); if (dc) { const p = document.createElement('div'); p.className = 'event-link text-wrap-clamp'; p.innerText = e.title; dc.appendChild(p); } });
        }

        async function renderNotes(container, side) {
            container.innerHTML = `<div class="page-title">${currentCategory.toUpperCase()} NOTES (${side.toUpperCase()})</div><div class="page-meta">${displayDate.toLocaleDateString()}</div><div class="new-note-area"><textarea id="new-note-content-${side}" class="handwriting" placeholder="Start typing your notes here..." style="width: 100%; min-height: 200px; border: none; outline: none; background: transparent; resize: none;"></textarea><div style="display: flex; justify-content: space-between; align-items: center;"><button class="save-btn" onclick="handleAddNote('${side}')">Add Entry</button><div id="save-status-${side}" class="save-status">All changes saved</div></div></div><div id="entries-list-${side}" style="margin-top: 20px;"></div>`;
            await loadEntries(container.querySelector(`#entries-list-${side}`), side);
        }

        async function renderPersonalPlanner(container, side) {
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(displayDate), fetchPlannerData(displayDate) ]);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            if (side === 'left') {
                container.innerHTML = `<div class="page-title">PERSONAL PLANNER - SUN-TUE</div><div class="habit-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">${renderHabitSection('Self Care', ['Shower', 'Read', 'Bible App'])}${renderHabitSection('Home Care', ['Make beds', 'Laundry', 'Meals'])}</div><div id="personal-cols-left" class="daily-columns" style="grid-template-columns: repeat(3, 1fr);"></div>`;
                const cols = container.querySelector('#personal-cols-left');
                for (let i = 0; i < 3; i++) renderPersonalDay(cols, i, displayDate, plannerData, dayNames, dayClasses);
            } else {
                container.innerHTML = `<div class="page-title">PERSONAL PLANNER - WED-SAT</div><div class="enjoy-banner" style="margin-bottom: 15px; text-align:center; font-weight:bold; color:#4a3427;">üè† ‚ù§ ENJOY YOUR FAMILY ‚ù§ üè†</div><div id="personal-cols-right" class="daily-columns" style="grid-template-columns: repeat(4, 1fr);"></div>`;
                const cols = container.querySelector('#personal-cols-right');
                for (let i = 3; i < 7; i++) renderPersonalDay(cols, i, displayDate, plannerData, dayNames, dayClasses);
            }
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
        }

        function renderPersonalDay(container, i, startDate, plannerData, dayNames, dayClasses) {
            const d = new Date(startDate); d.setDate(d.getDate() + i); const ds = d.toISOString().split('T')[0];
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()} ${formatDateMMM(ds).toUpperCase()}</div><div style="padding: 5px;"><div style="font-size: 7pt; font-weight:bold;">Focus</div><div class="planner-edit handwriting" contenteditable="true" data-field="focus" data-date="${ds}" style="min-height: 40px; border-bottom: 1px solid #eee; margin-bottom: 5px;">${plannerData.find(d => d.date === ds && d.field_id === 'focus')?.content || ''}</div><div style="font-size: 7pt; font-weight:bold;">Notes</div><div class="planner-edit handwriting" contenteditable="true" data-field="notes" data-date="${ds}" style="min-height: 250px; font-size: 0.9rem;">${plannerData.find(d => d.date === ds && d.field_id === 'notes')?.content || ''}</div></div>`;
            container.appendChild(col);
        }

        function renderHabitSection(title, habits) {
            return `<div style="padding: 5px; border: 1px solid #eee; border-radius: 5px;"><div style="font-size: 8pt; margin-bottom: 5px; font-weight:bold; text-align:center;">${title}</div>${habits.map(h => `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px;"><span style="font-size: 7pt; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60px;">${h}</span><div style="display: flex; gap: 2px;">${[0,1,2,3,4,5,6].map(d => { const date = new Date(displayDate); date.setDate(date.getDate() - date.getDay() + d); const ds = date.toISOString().split('T')[0]; return `<div class="mini-day-box" style="width:8px; height:8px; border:1px solid #ccc; cursor:pointer;" data-field="habit-${h}" data-date="${ds}" onclick="toggleHabitCheck(this)"></div>`; }).join('')}</div></div>`).join('')}</div>`;
        }

        async function renderCseaLog(container) {
            container.innerHTML = `<div class="page-title">MEMBER INTERACTION LOG</div><div class="special-table-container"><table class="special-table"><thead><tr><th>Date</th><th>Member</th><th>Location</th><th>Discussion</th><th>Outcome</th><th></th></tr></thead><tbody id="interaction-log-body"></tbody><tfoot><tr><td><input type="date" id="log-date" style="width:100%; font-size:8pt;"></td><td><input type="text" id="log-member" placeholder="Name" style="width:100%; font-size:8pt;"></td><td><input type="text" id="log-location" placeholder="Loc" style="width:100%; font-size:8pt;"></td><td><input type="text" id="log-discussion" placeholder="Issue" style="width:100%; font-size:8pt;"></td><td><input type="text" id="log-outcome" placeholder="Result" style="width:100%; font-size:8pt;"></td><td><button onclick="handleAddInteraction()" style="font-size:8pt;">Add</button></td></tr></tfoot></table></div>`;
            const interactions = await fetchInteractions('CSEA'); const tbody = container.querySelector('#interaction-log-body');
            interactions.forEach(inter => { const tr = document.createElement('tr'); tr.innerHTML = `<td style="font-size: 8pt;"><div class="clamp-wrapper">${formatDateMMM(inter.date_spoke)}</div></td><td style="font-size: 8pt;"><div class="clamp-wrapper">${inter.member_name}</div></td><td style="font-size: 8pt;"><div class="clamp-wrapper">${inter.work_location}</div></td><td style="font-size: 8pt;" class="text-left"><div class="clamp-wrapper">${inter.discussion}</div></td><td style="font-size: 8pt;" class="text-left"><div class="clamp-wrapper">${inter.outcome || ''}</div></td><td><button onclick="handleDeleteInteraction(${inter.id})" style="font-size:7pt;">X</button></td>`; tbody.appendChild(tr); });
        }

        async function handleAddInteraction() {
            const interaction = { date_spoke: document.getElementById('log-date').value, member_name: document.getElementById('log-member').value, work_location: document.getElementById('log-location').value, discussion: document.getElementById('log-discussion').value, outcome: document.getElementById('log-outcome').value };
            if (!interaction.date_spoke || !interaction.member_name) return;
            if (await saveInteraction('CSEA', interaction)) switchTab('CSEA');
        }

        async function handleDeleteInteraction(id) { if (confirm('Delete?')) { if (await deleteInteraction(id)) switchTab('CSEA'); } }

        function toggleHabitCheck(el) { el.classList.toggle('checked'); if (el.classList.contains('checked')) el.style.background = '#4a3427'; else el.style.background = 'transparent'; const { field, date } = el.dataset; savePlannerData(date, field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function handleAttendanceSave(select) { await savePlannerData(`icaap-attendance-data-${fiscalYear}`, select.dataset.field, select.value); }

        async function handleTrackingSave(el) { const fieldId = el.dataset.field; const content = el.innerText; clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { savePlannerData(`icaap-tracking-data-${fiscalYear}`, fieldId, content); }, 1000); }

        async function changeAttendanceWeek(delta) { displayDate.setDate(displayDate.getDate() + (delta * 7)); switchTab('iCAAPAttendance'); }

        async function handlePlannerInput(el) {
            const fieldId = el.dataset.field || el.id; const content = el.innerText; const dateStr = el.dataset.date || displayDate.toISOString().split('T')[0];
            clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { await savePlannerData(dateStr, fieldId, content); }, 1000);
        }

        async function togglePlannerCheck(el, date, fieldId) { el.classList.toggle('checked'); await savePlannerData(date, fieldId, el.classList.contains('checked') ? 'true' : 'false'); }

        function renderIcaapLinks(container) { container.innerHTML = `<div class="page-title">ICAAP LOGS</div><div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"><button class="tab active" style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid #ccc; cursor: pointer;" onclick="renderIcaapAttendanceView()">üë§ Attendance Tracking</button><button class="tab active" style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid #ccc; cursor: pointer;" onclick="renderIcaapTrackingView()">üìà iCAAP Tracking Log</button></div>`; }
        function renderFinanceLinks(container) { container.innerHTML = `<div class="page-title">FINANCIAL TOOLS</div><div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"><button class="tab active" style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid #ccc; cursor: pointer;" onclick="renderCheckBreakdownView()">üìä Check Breakdown</button><button class="tab active" style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid #ccc; cursor: pointer;" onclick="renderFinancialReviewView()">üí∏ Financial Review</button></div>`; }

        async function renderBudget(container, side = 'left') {
            const months = side === 'left' ? ['J','F','M','A','M','J'] : ['J','A','S','O','N','D'];
            const startMonth = side === 'left' ? 1 : 7;
            const headerHtml = `<th>Cat</th><th>Item</th><th>Amt</th>${months.map(m => `<th>${m}</th>`).join('')}`;
            
            container.innerHTML = `<div class="page-title">BUDGET PLANNING ${currentYear} (${side.toUpperCase()})</div><div class="special-table-container"><table class="special-table"><thead><tr>${headerHtml}</tr></thead><tbody id="budget-body-${side}"></tbody></table></div>`;
            const tbody = container.querySelector(`#budget-body-${side}`);
            
            financialBills.forEach(bill => { 
                const tr = document.createElement('tr'); 
                tr.className = bill.class || '';
                const monthCells = months.map((_, i) => `<td><div class="check-box" data-field="chk-${bill.id}-${startMonth + i}" onclick="toggleBudgetCheck(this)"></div></td>`).join('');
                tr.innerHTML = `<td class="handwriting"><div class="clamp-wrapper">${bill.cat}</div></td><td class="text-left handwriting"><div class="clamp-wrapper">${bill.item}</div></td><td class="handwriting"><div class="clamp-wrapper">${bill.amt}</div></td>${monthCells}`; 
                tbody.appendChild(tr); 
            });
            
            const data = await fetchPlannerData(`${currentYear}-financial`, 366);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el && item.content === 'true') el.classList.add('checked'); });
        }

        function toggleBudgetCheck(el) { el.classList.toggle('checked'); savePlannerData(`${currentYear}-financial`, el.dataset.field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function loadEntries(container, side) {
            const dateStr = displayDate.toISOString().split('T')[0];
            const entries = await fetchEntries(`${currentCategory}-${side}`, dateStr);
            container.innerHTML = entries.map(e => `<div class="handwriting" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">${e.content}</div>`).join('');
        }

        async function handleAddNote(side) {
            const content = document.getElementById(`new-note-content-${side}`).value;
            if (!content) return;
            const dateStr = displayDate.toISOString().split('T')[0];
            if (await saveEntry(`${currentCategory}-${side}`, dateStr, content)) { document.getElementById(`new-note-content-${side}`).value = ''; switchTab(currentCategory); }
        }

        async function renderIcaapAttendance(container, side) {
            const weekStart = new Date(displayDate); weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            const daysToRender = side === 'left' ? [0, 1, 2] : [3, 4];
            const weekdays = []; daysToRender.forEach(i => { const d = new Date(weekStart); d.setDate(d.getDate() + i); weekdays.push(d); });
            container.innerHTML = `<div class="page-title">ATTENDANCE (${side.toUpperCase()})</div><div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;"><button onclick="changeAttendanceWeek(-1)">Prev Week</button><button onclick="changeAttendanceWeek(1)">Next Week</button></div><div class="special-table-container"><table class="special-table"><thead><tr><th class="sticky-col">Name</th>${weekdays.map(d => `<th>${d.toLocaleDateString('en-US', { weekday: 'short' })}<br>${formatDateMMM(d.toISOString().split('T')[0])}</th>`).join('')}</tr></thead><tbody id="attn-body-${side}"></tbody></table></div>`;
            const tbody = container.querySelector(`#attn-body-${side}`);
            employees.forEach(emp => {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td class="sticky-col text-left" style="font-size: 8pt;"><div class="clamp-wrapper">${emp}</div></td>${weekdays.map(d => `<td><select class="attendance-select" data-field="attn-${emp}-${d.toISOString().split('T')[0]}" onchange="handleAttendanceSave(this)" style="font-size: 8pt; width: 100%;">${attnOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select></td>`).join('')}`; 
                tbody.appendChild(tr);
            });
            const data = await fetchPlannerData(`icaap-attendance-data-${fiscalYear}`, 366);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }

        async function renderIcaapTracking(container, side) {
            const monthsToRender = side === 'left' ? monthNames.slice(0, 6) : monthNames.slice(6);
            const startIdx = side === 'left' ? 0 : 6;
            container.innerHTML = `<div class="page-title">ICAAP TRACKING (${side.toUpperCase()})</div><div class="special-table-container" style="overflow: auto;"><table class="special-table" style="min-width: 600px;"><thead><tr><th class="sticky-col">Name</th>${monthsToRender.map(m => `<th colspan="3">${m}</th>`).join('')}</tr><tr><th class="sticky-col"></th>${monthsToRender.map(() => `<th>Pay</th><th>Hrs</th><th>Appr</th>`).join('')}</tr></thead><tbody id="track-body-${side}"></tbody></table></div>`;
            const tbody = container.querySelector(`#track-body-${side}`);
            employees.forEach((emp, ei) => {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td class="sticky-col text-left" style="font-size: 8pt;"><div class="clamp-wrapper">${emp}</div></td>${monthsToRender.map((m, mi) => `<td contenteditable="true" class="editable-cell" data-field="m${mi + startIdx}-${ei}-paylog" oninput="handleTrackingSave(this)" style="font-size: 8pt;"></td><td contenteditable="true" class="editable-cell" data-field="m${mi + startIdx}-${ei}-hours" oninput="handleTrackingSave(this)" style="font-size: 8pt;"></td><td contenteditable="true" class="editable-cell" data-field="m${mi + startIdx}-${ei}-appr" oninput="handleTrackingSave(this)" style="font-size: 8pt;"></td>`).join('')}`; 
                tbody.appendChild(tr);
            });
            const data = await fetchPlannerData(`icaap-tracking-data-${fiscalYear}`, 366);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.innerText = item.content; });
        }

        async function renderCheckBreakdown(container) {
            container.innerHTML = `<div class="page-title">CHECK BREAKDOWN</div><div class="special-table-container"><table class="special-table"><thead><tr id="check-header"><th class="sticky-col">Account</th></tr></thead><tbody id="check-body"><tr><td class="sticky-col text-left">Checking</td></tr><tr><td class="sticky-col text-left">Jennifer Check</td></tr><tr><td class="sticky-col text-left">Tithe</td></tr><tr><td class="sticky-col text-left">Left Over</td></tr></tbody></table></div>`;
            const header = container.querySelector('#check-header'); const tbody = container.querySelector('#check-body');
            const payDates = ['1/5/2026', '1/20/2026', '2/5/2026', '2/20/2026', '3/5/2026', '3/20/2026', '4/5/2026', '4/20/2026', '5/5/2026', '5/20/2026', '6/5/2026', '6/20/2026'];
            payDates.forEach((pd, i) => {
                const th = document.createElement('th'); th.innerText = pd; header.appendChild(th);
                tbody.querySelectorAll('tr').forEach((tr, ri) => { const td = document.createElement('td'); td.contentEditable = true; td.className = 'editable-cell'; td.dataset.field = `chk-${i}-${ri}`; td.oninput = (e) => handleModuleEdit(e.target, `check-breakdown-${currentYear}`); tr.appendChild(td); });
            });
            const data = await fetchPlannerData(`check-breakdown-${currentYear}`, 100);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.innerText = item.content; });
        }

        async function handleModuleEdit(el, pk) { const fieldId = el.dataset.field || el.id; const content = el.innerText || el.value; clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { savePlannerData(pk, fieldId, content); }, 1000); }

        async function renderFinancialReview(container) {
            container.innerHTML = `<div class="page-title">FINANCIAL REVIEW</div><div style="display:grid; grid-template-columns:1fr; gap:10px;">${['Goals', 'Expenses', 'Savings'].map(t => `<div style="border:1px solid #eee; padding:10px;"><div style="font-weight:bold; font-size:9pt; margin-bottom:5px;">${t}</div><textarea class="handwriting" data-field="fin-${t.toLowerCase()}" oninput="handleModuleEdit(this, 'fin-review-${currentYear}')" style="width: 100%; min-height: 80px; border: none; background: transparent; resize:none;"></textarea></div>`).join('')}</div>`;
            const data = await fetchPlannerData(`fin-review-${currentYear}`, 10);
            data.forEach(item => { const el = container.querySelector(`[data-field="${item.field_id}"]`); if (el) el.value = item.content; });
        }
    </script>
</body>
</html>
