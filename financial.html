<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --row-auto: #2d8a2d;
            --row-bill: #00326b;
            --row-cash: #d14d9c;
            --row-cc: #d68100;
            --row-housing: #a33b3b;
            --row-savings: #7a4da3;
        }
        body { margin: 0; padding: 0; font-family: 'Coming Soon', cursive; background: #fff; }
        .content-area { padding: 0 !important; width: 100vw; box-sizing: border-box; overflow: hidden !important; }
        .view-section { background: #fff; padding: 5px 10px; border-radius: 0; border: 1px solid #eee; margin-bottom: 5px; box-shadow: none; width: 100vw; box-sizing: border-box; }
        .handwriting, .planner-edit { font-family: 'Coming Soon', cursive; font-size: 10pt; color: #2c3e50; }
        .page-title { font-size: 10pt; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--header-blue); margin-bottom: 5px; border-bottom: 2px solid var(--header-blue); padding-bottom: 5px; text-align: right; }
        .bill-table-container { width: 100%; overflow: auto; margin-top: 5px; max-height: 50vh; }
        .bill-table { width: auto; border-collapse: collapse; font-size: 10pt; table-layout: auto; }
        .bill-table th, .bill-table td { border: 1px solid #eee; padding: 8px; text-align: left; vertical-align: middle; width: 1%; }
        .bill-table th { background: #f8f9fa; font-weight: 700; text-transform: uppercase; font-size: 10pt; text-align: center; }
        .item-col { white-space: nowrap !important; width: 1%; }
        .amt-col { width: 1%; }
        td.amt-col { text-align: right !important; }
        .cat-col { width: 1%; }
        td.cat-col { text-align: center !important; }
        .month-col { width: 1%; text-align: center !important; min-width: 35px; }
        .category-pill { display: inline-block; padding: 2px 8px; border-radius: 12px; color: #fff; font-size: 10pt; font-weight: 700; text-transform: uppercase; min-width: 60px; text-align: center; }
        .row-auto .category-pill { background-color: var(--row-auto); }
        .row-bill .category-pill { background-color: var(--row-bill); }
        .row-cash .category-pill { background-color: var(--row-cash); }
        .row-cc .category-pill { background-color: var(--row-cc); }
        .row-housing .category-pill { background-color: var(--row-housing); }
        .row-savings .category-pill { background-color: var(--row-savings); }
        .checkbox { width: 18px; height: 18px; border: 1px solid #ddd; display: inline-block; cursor: pointer; border-radius: 50%; vertical-align: middle; }
        .checkbox.checked { background-color: #333; position: relative; }
        .checkbox.checked::after { content: 'âœ“'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10pt; }
        .save-status { font-size: 10pt; color: #888; text-align: right; margin-top: 10px; }
        .cb-1 { background-color: #ffcccc; } .cb-2 { background-color: #ffe6cc; }
        .cb-3 { background-color: #ffffcc; } .cb-4 { background-color: #e6ffcc; }
        .cb-5 { background-color: #ccffcc; } .cb-6 { background-color: #ccffe6; }
        .cb-7 { background-color: #ccffff; } .cb-8 { background-color: #cce6ff; }
        .cb-9 { background-color: #ccccff; } .cb-10 { background-color: #e6ccff; }
        .cb-11 { background-color: #ffccff; } .cb-12 { background-color: #ffcce6; }
    </style>
</head>
<body>
    <div class="content-area">
        <div class="view-section">
            <div class="page-title">RECURRING BILLS & EXPENSES</div>
            <div class="bill-table-container">
                <table class="bill-table">
                    <thead>
                        <tr>
                            <th class="cat-col">Cat</th>
                            <th class="item-col">Item</th>
                            <th class="amt-col">Amt</th>
                            <th class="month-col">J</th><th class="month-col">F</th><th class="month-col">M</th>
                            <th class="month-col">A</th><th class="month-col">M</th><th class="month-col">J</th>
                            <th class="month-col">J</th><th class="month-col">A</th><th class="month-col">S</th>
                            <th class="month-col">O</th><th class="month-col">N</th><th class="month-col">D</th>
                        </tr>
                    </thead>
                    <tbody id="bill-body"></tbody>
                </table>
            </div>
            <div id="save-status" class="save-status">All changes saved</div>
        </div>

        <div class="view-section handwriting" style="margin-bottom: 0;">
            <div class="page-title">FINANCIAL GOALS & NOTES</div>
            <div id="financial-goals" class="planner-edit" contenteditable="true" oninput="handleGoalsInput()" style="min-height: 50px; outline: none;"></div>
        </div>
    </div>

    <script>
        let saveTimeout;
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const displayDate = dateParam ? new Date(dateParam) : new Date();
        const currentYear = displayDate.getFullYear();
        const PLANNING_DATE = `${currentYear}-financial`;

        async function init() {
            if (typeof setGlobalHeaderTitle === 'function') setGlobalHeaderTitle(`FINANCE ${currentYear}`);
            if (typeof updateNavigationLinks === 'function') updateNavigationLinks(displayDate);

            const [bills, budgetData] = await Promise.all([
                fetchFinancialBills(),
                fetchPlannerData(PLANNING_DATE, 400)
            ]);

            const tbody = document.getElementById('bill-body');
            const goalsEl = document.getElementById('financial-goals');
            
            // Load goals
            const goalsData = budgetData.find(d => d.field_id === 'financial-goals');
            if (goalsData) goalsEl.innerText = goalsData.content;

            tbody.innerHTML = '';
            bills.forEach(bill => {
                const tr = document.createElement('tr');
                tr.className = bill.class || 'row-bill';
                
                let html = `
                    <td class="cat-col planner-edit" contenteditable="true" oninput="handleBillSave('${bill.id}', 'cat', this.innerText)"><span class="category-pill">${bill.cat}</span></td>
                    <td class="item-col planner-edit" contenteditable="true" oninput="handleBillSave('${bill.id}', 'item', this.innerText)">${bill.item}</td>
                    <td class="amt-col planner-edit" contenteditable="true" oninput="handleBillSave('${bill.id}', 'amt', this.innerText)">${bill.amt}</td>
                `;

                for (let m = 1; m <= 12; m++) {
                    const fieldId = `chk-${bill.id}-${m}`;
                    const isChecked = budgetData.some(d => d.field_id === fieldId && d.content === 'true');
                    html += `<td class="month-col"><div class="checkbox cb-${m} ${isChecked ? 'checked' : ''}" onclick="toggleCheck(this, '${fieldId}')"></div></td>`;
                }
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        async function toggleCheck(el, fieldId) {
            el.classList.toggle('checked');
            const isChecked = el.classList.contains('checked');
            const status = document.getElementById('save-status');
            status.innerText = 'Saving...';
            await savePlannerData(PLANNING_DATE, fieldId, isChecked.toString());
            status.innerText = 'All changes saved';
        }

        function handleBillSave(billId, field, content) {
            const status = document.getElementById('save-status');
            status.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                status.innerText = 'Saving...';
                await updateFinancialBill(billId, field, content);
                status.innerText = 'All changes saved';
            }, 1000);
        }

        function handleGoalsInput() {
            const status = document.getElementById('save-status');
            const content = document.getElementById('financial-goals').innerText;
            status.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                status.innerText = 'Saving...';
                await savePlannerData(PLANNING_DATE, 'financial-goals', content);
                status.innerText = 'All changes saved';
            }, 1000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>