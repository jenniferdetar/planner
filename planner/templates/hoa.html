{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOA</title>
  <link rel="stylesheet" href="{% static 'css/opus-core.css' %}?v=20260108">
  <link rel="stylesheet" href="{% static 'css/home.css' %}?v=20260108">
  <link rel="stylesheet" href="{% static 'css/calendar.css' %}?v=20260108">
  <style>
    .hoa-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .hoa-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #99B3C5;
      border-radius: 999px;
      padding: 12px 16px;
      border: 2px solid rgba(10, 47, 95, 0.15);
      box-shadow: var(--opus-shadow-sm);
    }

    .hoa-card:nth-child(4n+1) { background: #99B3C5; }
    .hoa-card:nth-child(4n+2) { background: #FFA1AB; }
    .hoa-card:nth-child(4n+3) { background: #FFC68D; }
    .hoa-card:nth-child(4n+4) { background: #9ADBDE; }

    .hoa-card-icon {
      display: grid;
      place-items: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.1rem;
      color: #0a2f5f;
      border: 2px solid rgba(10, 47, 95, 0.2);
      background: #ffffff;
      flex-shrink: 0;
      box-shadow: var(--opus-shadow-xs);
    }

    .hoa-card:nth-child(4n+1) .hoa-card-icon { background: #99B3C5; }
    .hoa-card:nth-child(4n+2) .hoa-card-icon { background: #FFA1AB; }
    .hoa-card:nth-child(4n+3) .hoa-card-icon { background: #FFC68D; }
    .hoa-card:nth-child(4n+4) .hoa-card-icon { background: #9ADBDE; }

    .hoa-card-title {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.12;
      color: var(--opus-primary);
    }

    .hoa-card-note {
      margin: 4px 0 0;
      font-size: 0.78rem;
      line-height: 1.2;
      color: var(--opus-text-secondary);
    }

    .hoa-units-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px 12px;
      margin-top: 16px;
    }

    .hoa-unit-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(10, 47, 95, 0.2);
      font-size: 0.8rem;
      color: #0a2f5f;
      line-height: 1;
      white-space: nowrap;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .hoa-unit-badge:hover {
      background: #fff;
      border-color: var(--opus-primary);
      transform: translateY(-1px);
    }

    .hoa-upload {
      display: grid;
      gap: 12px;
    }

    .hoa-upload input[type="file"] {
      padding: 10px;
      border: 2px dashed #7f9db3;
      border-radius: 12px;
      background: #f8fafc;
      cursor: pointer;
    }

    .hoa-summary {
      background: #ffffff;
      border: 2px solid #dbeafe;
      border-radius: 12px;
      padding: 12px;
      box-shadow: var(--opus-shadow-sm);
      font-size: 0.95rem;
      color: #0f172a;
      min-height: 80px;
      white-space: pre-wrap;
    }

    .hoa-summary-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.88rem;
      color: #475569;
    }

    .hoa-summary-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e6eef5;
      border: 1px solid #7f9db3;
      color: #0a2f5f;
      font-weight: 700;
      font-size: 0.85rem;
    }
  </style>
</head>
<body data-module="hoaPage">
  <div class="planner-container">
    {% include 'header_include.html' %}

    <div class="planner-content">
      <header class="planner-header">
        <div class="planner-header-left">
          <h1>HOA</h1>
          <p>Track HOA reminders, documents, and community updates.</p>
        </div>
        <div class="planner-header-right">
          <div class="planner-header-date" id="today-date"></div>
        </div>
      </header>
      

      <main class="planner-main">
        <section class="planner-section">
          <div class="planner-section-header">
            <span class="planner-section-icon">üìÑ</span>
            <h2 class="planner-section-title">Upload & Summarize PDF</h2>
          </div>
          <div class="planner-section-content">
            <div class="hoa-upload">
              <input type="file" id="hoa-pdf-input" accept="application/pdf">
              <div class="hoa-summary-meta" id="hoa-summary-meta" aria-live="polite"></div>
              <div class="hoa-summary" id="hoa-summary-output">Select a PDF to generate a quick summary.</div>
            </div>
          </div>
        </section>

        <section class="planner-section">
          <div class="planner-section-header">
            <span class="planner-section-icon">üè°</span>
            <h2 class="planner-section-title">HOA Library</h2>
          </div>
          <div class="planner-section-content">
            <p class="planner-card-content">Quick access to your most-used HOA folders and records.</p>
            <div class="planner-grid hoa-grid">
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">üì£</div>
                <div>
                  <h3 class="hoa-card-title">Announcements</h3>
                  <p class="hoa-card-note">Community updates and notices.</p>
                </div>
              </div>
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">üë•</div>
                <div>
                  <h3 class="hoa-card-title">BOD</h3>
                  <p class="hoa-card-note">Board of Directors contacts.</p>
                </div>
              </div>
              <a href="/hoa/financials" class="planner-card hoa-card link-unstyled">
                <div class="hoa-card-icon">üíµ</div>
                <div>
                  <h3 class="hoa-card-title">Financials</h3>
                  <p class="hoa-card-note">Budgets, expenses, and dues.</p>
                </div>
              </a>
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">üìÇ</div>
                <div>
                  <h3 class="hoa-card-title">Homeowner Documents</h3>
                  <p class="hoa-card-note">Policies, bylaws, and forms.</p>
                </div>
              </div>
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">üõ°Ô∏è</div>
                <div>
                  <h3 class="hoa-card-title">Insurance</h3>
                  <p class="hoa-card-note">Coverage and claim details.</p>
                </div>
              </div>
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">‚öñÔ∏è</div>
                <div>
                  <h3 class="hoa-card-title">Legal</h3>
                  <p class="hoa-card-note">Compliance and legal records.</p>
                </div>
              </div>
              <a href="/hoa/maintenance-repairs" class="planner-card hoa-card link-unstyled">
                <div class="hoa-card-icon">üõ†Ô∏è</div>
                <div>
                  <h3 class="hoa-card-title">Maintenance &amp; Repairs</h3>
                  <p class="hoa-card-note">Work orders and vendor history.</p>
                </div>
              </a>
              <div class="planner-card hoa-card">
                <div class="hoa-card-icon">üßæ</div>
                <div>
                  <h3 class="hoa-card-title">Statements</h3>
                  <p class="hoa-card-note">Monthly statements and summaries.</p>
                </div>
              </div>
              <a href="/hoa/units" class="planner-card hoa-card link-unstyled">
                <div class="hoa-card-icon">üèòÔ∏è</div>
                <div>
                  <h3 class="hoa-card-title">Units</h3>
                  <p class="hoa-card-note">Unit roster and owner info.</p>
                </div>
              </a>
            </div>
          </div>
        </section>

        <section class="planner-section">
          <div class="planner-section-header">
            <span class="planner-section-icon">üèòÔ∏è</span>
            <h2 class="planner-section-title">Unit Directory</h2>
          </div>
          <div class="planner-section-content">
            <p class="planner-card-content">Quick access to unit information.</p>
            <div class="hoa-units-list">
                <a href="/hoa/units" class="hoa-unit-badge">Unit 001</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 002</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 003</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 004</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 005</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 006</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 007</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 008</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 009</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 010</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 011</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 012</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 013</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 014</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 015</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 016</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 017</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 018</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 019</a>
                <a href="/hoa/units" class="hoa-unit-badge">Unit 020</a>
            </div>
            <div style="margin-top: 16px; text-align: center;">
              <a href="/hoa/units" class="planner-button planner-button-secondary">View All Units</a>
            </div>
          </div>
        </section>
      </main>

      <footer class="planner-footer">
        HOA Synced securely via Supabase (login required).
      </footer>
    </div>
  </div>

  <script src="{% static 'js/utils.js' %}?v=20260108"></script>
  <script src="{% static 'js/supabase-client.js' %}"></script>
  <script>
    const todayDateEl = document.getElementById('today-date');
    if (todayDateEl) {
      todayDateEl.textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
  </script>
  <script>
    const fileInput = document.getElementById('hoa-pdf-input');
    const summaryBox = document.getElementById('hoa-summary-output');
    const summaryMeta = document.getElementById('hoa-summary-meta');
    const STOPWORDS = new Set(['the','and','of','to','in','a','for','on','at','by','with','is','it','as','be','an','or','from','that','this','are','was','were','will','can','may','not','your','you']);

    fileInput?.addEventListener('change', async (evt) => {
      if (!window.pdfjsLib) {
        summaryBox.textContent = 'PDF reader is unavailable right now.';
        return;
      }
      const file = evt.target.files?.[0];
      if (!file) return;
      summaryBox.textContent = 'Processing PDF‚Ä¶';
      summaryMeta.innerHTML = '';
      try {
        const user = await requireSupabaseUser();
        if (!user) {
          summaryBox.textContent = 'Please log in to upload and sync PDFs.';
          return;
        }

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str).join(' ');
          text += ' ' + strings;
          if (text.length > 12000) break;
        }
        const summary = summarizeText(text);
        const wordCount = text.split(/\s+/).filter(Boolean).length;

        const path = `${user.id}/hoa/${Date.now()}-${file.name}`;
        const { error: uploadError } = await window.supabaseClient
          .storage.from('hoa-unit-files')
          .upload(path, file, { upsert: false });
        if (uploadError) throw uploadError;

        const { data: publicUrlData } = window.supabaseClient
          .storage.from('hoa-unit-files')
          .getPublicUrl(path);
        const fileUrl = publicUrlData?.publicUrl || '';

        await window.supabaseClient.from('hoa_units').insert({
          user_id: user.id,
          unit_name: 'HOA Library',
          file_name: file.name,
          file_url: fileUrl,
          summary,
          pages: pdf.numPages,
          words: wordCount
        });

        renderSummary(summary, { name: file.name, pages: pdf.numPages, words: wordCount, url: fileUrl });
      } catch (err) {
        console.error(err);
        summaryBox.textContent = 'Unable to read or upload that PDF. Please try another file.';
      }
    });

    function summarizeText(text) {
      if (!text || !text.trim()) return 'No readable text found in this PDF.';
      const sentences = text.replace(/\s+/g, ' ').split(/(?<=[.?!])\s+/).filter(s => s.length > 20);
      const topSentences = sentences.slice(0, 3).join(' ');
      const freq = {};
      text.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).forEach(word => {
        if (!word || STOPWORDS.has(word)) return;
        freq[word] = (freq[word] || 0) + 1;
      });
      const keywords = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([w]) => w).join(', ');
      return `${topSentences || 'Summary unavailable.'}\n\nTop keywords: ${keywords || 'n/a'}`;
    }

    function renderSummary(summaryText, meta) {
      summaryBox.textContent = summaryText;
      summaryMeta.innerHTML = [
        meta.name ? `<span class="hoa-summary-pill">File: ${meta.name}</span>` : '',
        meta.pages ? `<span class="hoa-summary-pill">Pages: ${meta.pages}</span>` : '',
        meta.words ? `<span class="hoa-summary-pill">Words: ${meta.words}</span>` : '',
        meta.url ? `<span class="hoa-summary-pill"><a href="${meta.url}" target="_blank" rel="noopener">Open</a></span>` : ''
      ].filter(Boolean).join('');
    }
  </script>
<script src="{% static 'js/calendar-embed.js' %}?v=20260108"></script>
</body>
</html>
