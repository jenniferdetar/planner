{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Units - HOA</title>
  <link rel="stylesheet" href="../css/opus-core.css?v=20260108">
  <link rel="stylesheet" href="../css/home.css?v=20260108">
  <style>
    .hoa-units-page {
      background: var(--opus-bg-white);
      border: 2px solid var(--opus-accent);
      border-radius: var(--opus-border-radius);
      padding: var(--opus-spacing-md);
      box-shadow: var(--opus-shadow-sm);
    }

    .hoa-units-title {
      margin: 0 0 var(--opus-spacing-xs);
      font-size: 1.2rem;
      color: var(--opus-primary);
    }

    .hoa-units-subtitle {
      margin: 0 0 var(--opus-spacing-md);
      color: var(--opus-text-secondary);
      font-size: 0.9rem;
    }

    .hoa-units-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px 12px;
    }

    .hoa-unit-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(10, 47, 95, 0.2);
      font-size: 0.8rem;
      color: #0a2f5f;
      line-height: 1;
      white-space: nowrap;
    }

    .unit-upload {
      display: grid;
      gap: 12px;
      margin-bottom: var(--opus-spacing-md);
    }

    .unit-upload .form-row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: center;
    }

    .unit-upload select,
    .unit-upload input[type="file"] {
      padding: 10px;
      border: 2px solid #7f9db3;
      border-radius: 12px;
      background: #f8fafc;
      font-size: 0.95rem;
      color: #0a2f5f;
    }

    .unit-upload input[type="file"] {
      border-style: dashed;
      cursor: pointer;
    }

    .unit-summary {
      background: #ffffff;
      border: 2px solid #dbeafe;
      border-radius: 12px;
      padding: 12px;
      box-shadow: var(--opus-shadow-sm);
      font-size: 0.95rem;
      color: #0f172a;
      min-height: 80px;
      white-space: pre-wrap;
    }

    .unit-summary-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.88rem;
      color: #475569;
    }

    .unit-summary-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #e6eef5;
      border: 1px solid #7f9db3;
      color: #0a2f5f;
      font-weight: 700;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="planner-container">
    <aside class="planner-sidebar">
      <a href="/calendar" class="planner-sidebar-item">Home</a>
      <a href="/csea" class="planner-sidebar-item">CSEA</a>
      <a href="/finance" class="planner-sidebar-item">Finance</a>
      <a href="/health" class="planner-sidebar-item">Health</a>
      <a href="/hoa" class="planner-sidebar-item active">HOA</a>
      <a href="/icaap" class="planner-sidebar-item">iCAAP</a>
      <a href="/planning" class="planner-sidebar-item">Planning</a>
    </aside>

    <div class="planner-content">
      <header class="planner-header">
        <div class="planner-header-left">
          <h1>Units</h1>
          <p>HOA unit directory quick view.</p>
        </div>
        <div class="planner-header-right">
          <div class="planner-header-date" id="today-date"></div>
        </div>
      </header>

      <main class="planner-main">
        <section class="planner-section">
          <div class="planner-section-header">
            <span class="planner-section-icon">ðŸ“„</span>
            <h2 class="planner-section-title">Upload & Summarize Unit PDF</h2>
          </div>
          <div class="planner-section-content">
            <div class="unit-upload">
              <div class="form-row">
                <select id="unit-select" aria-label="Choose unit for this upload"></select>
                <input type="file" id="unit-pdf-input" accept="application/pdf">
              </div>
              <div class="unit-summary-meta" id="unit-summary-meta" aria-live="polite"></div>
              <div class="unit-summary" id="unit-summary-output">Select a unit and choose a PDF to generate a quick summary.</div>
            </div>
          </div>
        </section>

        <section class="hoa-units-page">
          <h2 class="hoa-units-title">Units 001â€“150</h2>
          <p class="hoa-units-subtitle">Select a unit number for quick reference.</p>
          <div class="hoa-units-list">
              <span class="hoa-unit-badge">Unit 001</span>
              <span class="hoa-unit-badge">Unit 002</span>
              <span class="hoa-unit-badge">Unit 003</span>
              <span class="hoa-unit-badge">Unit 004</span>
              <span class="hoa-unit-badge">Unit 005</span>
              <span class="hoa-unit-badge">Unit 006</span>
              <span class="hoa-unit-badge">Unit 007</span>
              <span class="hoa-unit-badge">Unit 008</span>
              <span class="hoa-unit-badge">Unit 009</span>
              <span class="hoa-unit-badge">Unit 010</span>
              <span class="hoa-unit-badge">Unit 011</span>
              <span class="hoa-unit-badge">Unit 012</span>
              <span class="hoa-unit-badge">Unit 013</span>
              <span class="hoa-unit-badge">Unit 014</span>
              <span class="hoa-unit-badge">Unit 015</span>
              <span class="hoa-unit-badge">Unit 016</span>
              <span class="hoa-unit-badge">Unit 017</span>
              <span class="hoa-unit-badge">Unit 018</span>
              <span class="hoa-unit-badge">Unit 019</span>
              <span class="hoa-unit-badge">Unit 020</span>
              <span class="hoa-unit-badge">Unit 021</span>
              <span class="hoa-unit-badge">Unit 022</span>
              <span class="hoa-unit-badge">Unit 023</span>
              <span class="hoa-unit-badge">Unit 024</span>
              <span class="hoa-unit-badge">Unit 025</span>
              <span class="hoa-unit-badge">Unit 026</span>
              <span class="hoa-unit-badge">Unit 027</span>
              <span class="hoa-unit-badge">Unit 028</span>
              <span class="hoa-unit-badge">Unit 029</span>
              <span class="hoa-unit-badge">Unit 030</span>
              <span class="hoa-unit-badge">Unit 031</span>
              <span class="hoa-unit-badge">Unit 032</span>
              <span class="hoa-unit-badge">Unit 033</span>
              <span class="hoa-unit-badge">Unit 034</span>
              <span class="hoa-unit-badge">Unit 035</span>
              <span class="hoa-unit-badge">Unit 036</span>
              <span class="hoa-unit-badge">Unit 037</span>
              <span class="hoa-unit-badge">Unit 038</span>
              <span class="hoa-unit-badge">Unit 039</span>
              <span class="hoa-unit-badge">Unit 040</span>
              <span class="hoa-unit-badge">Unit 041</span>
              <span class="hoa-unit-badge">Unit 042</span>
              <span class="hoa-unit-badge">Unit 043</span>
              <span class="hoa-unit-badge">Unit 044</span>
              <span class="hoa-unit-badge">Unit 045</span>
              <span class="hoa-unit-badge">Unit 046</span>
              <span class="hoa-unit-badge">Unit 047</span>
              <span class="hoa-unit-badge">Unit 048</span>
              <span class="hoa-unit-badge">Unit 049</span>
              <span class="hoa-unit-badge">Unit 050</span>
              <span class="hoa-unit-badge">Unit 051</span>
              <span class="hoa-unit-badge">Unit 052</span>
              <span class="hoa-unit-badge">Unit 053</span>
              <span class="hoa-unit-badge">Unit 054</span>
              <span class="hoa-unit-badge">Unit 055</span>
              <span class="hoa-unit-badge">Unit 056</span>
              <span class="hoa-unit-badge">Unit 057</span>
              <span class="hoa-unit-badge">Unit 058</span>
              <span class="hoa-unit-badge">Unit 059</span>
              <span class="hoa-unit-badge">Unit 060</span>
              <span class="hoa-unit-badge">Unit 061</span>
              <span class="hoa-unit-badge">Unit 062</span>
              <span class="hoa-unit-badge">Unit 063</span>
              <span class="hoa-unit-badge">Unit 064</span>
              <span class="hoa-unit-badge">Unit 065</span>
              <span class="hoa-unit-badge">Unit 066</span>
              <span class="hoa-unit-badge">Unit 067</span>
              <span class="hoa-unit-badge">Unit 068</span>
              <span class="hoa-unit-badge">Unit 069</span>
              <span class="hoa-unit-badge">Unit 070</span>
              <span class="hoa-unit-badge">Unit 071</span>
              <span class="hoa-unit-badge">Unit 072</span>
              <span class="hoa-unit-badge">Unit 073</span>
              <span class="hoa-unit-badge">Unit 074</span>
              <span class="hoa-unit-badge">Unit 075</span>
              <span class="hoa-unit-badge">Unit 076</span>
              <span class="hoa-unit-badge">Unit 077</span>
              <span class="hoa-unit-badge">Unit 078</span>
              <span class="hoa-unit-badge">Unit 079</span>
              <span class="hoa-unit-badge">Unit 080</span>
              <span class="hoa-unit-badge">Unit 081</span>
              <span class="hoa-unit-badge">Unit 082</span>
              <span class="hoa-unit-badge">Unit 083</span>
              <span class="hoa-unit-badge">Unit 084</span>
              <span class="hoa-unit-badge">Unit 085</span>
              <span class="hoa-unit-badge">Unit 086</span>
              <span class="hoa-unit-badge">Unit 087</span>
              <span class="hoa-unit-badge">Unit 088</span>
              <span class="hoa-unit-badge">Unit 089</span>
              <span class="hoa-unit-badge">Unit 090</span>
              <span class="hoa-unit-badge">Unit 091</span>
              <span class="hoa-unit-badge">Unit 092</span>
              <span class="hoa-unit-badge">Unit 093</span>
              <span class="hoa-unit-badge">Unit 094</span>
              <span class="hoa-unit-badge">Unit 095</span>
              <span class="hoa-unit-badge">Unit 096</span>
              <span class="hoa-unit-badge">Unit 097</span>
              <span class="hoa-unit-badge">Unit 098</span>
              <span class="hoa-unit-badge">Unit 099</span>
              <span class="hoa-unit-badge">Unit 100</span>
              <span class="hoa-unit-badge">Unit 101</span>
              <span class="hoa-unit-badge">Unit 102</span>
              <span class="hoa-unit-badge">Unit 103</span>
              <span class="hoa-unit-badge">Unit 104</span>
              <span class="hoa-unit-badge">Unit 105</span>
              <span class="hoa-unit-badge">Unit 106</span>
              <span class="hoa-unit-badge">Unit 107</span>
              <span class="hoa-unit-badge">Unit 108</span>
              <span class="hoa-unit-badge">Unit 109</span>
              <span class="hoa-unit-badge">Unit 110</span>
              <span class="hoa-unit-badge">Unit 111</span>
              <span class="hoa-unit-badge">Unit 112</span>
              <span class="hoa-unit-badge">Unit 113</span>
              <span class="hoa-unit-badge">Unit 114</span>
              <span class="hoa-unit-badge">Unit 115</span>
              <span class="hoa-unit-badge">Unit 116</span>
              <span class="hoa-unit-badge">Unit 117</span>
              <span class="hoa-unit-badge">Unit 118</span>
              <span class="hoa-unit-badge">Unit 119</span>
              <span class="hoa-unit-badge">Unit 120</span>
              <span class="hoa-unit-badge">Unit 121</span>
              <span class="hoa-unit-badge">Unit 122</span>
              <span class="hoa-unit-badge">Unit 123</span>
              <span class="hoa-unit-badge">Unit 124</span>
              <span class="hoa-unit-badge">Unit 125</span>
              <span class="hoa-unit-badge">Unit 126</span>
              <span class="hoa-unit-badge">Unit 127</span>
              <span class="hoa-unit-badge">Unit 128</span>
              <span class="hoa-unit-badge">Unit 129</span>
              <span class="hoa-unit-badge">Unit 130</span>
              <span class="hoa-unit-badge">Unit 131</span>
              <span class="hoa-unit-badge">Unit 132</span>
              <span class="hoa-unit-badge">Unit 133</span>
              <span class="hoa-unit-badge">Unit 134</span>
              <span class="hoa-unit-badge">Unit 135</span>
              <span class="hoa-unit-badge">Unit 136</span>
              <span class="hoa-unit-badge">Unit 137</span>
              <span class="hoa-unit-badge">Unit 138</span>
              <span class="hoa-unit-badge">Unit 139</span>
              <span class="hoa-unit-badge">Unit 140</span>
              <span class="hoa-unit-badge">Unit 141</span>
              <span class="hoa-unit-badge">Unit 142</span>
              <span class="hoa-unit-badge">Unit 143</span>
              <span class="hoa-unit-badge">Unit 144</span>
              <span class="hoa-unit-badge">Unit 145</span>
              <span class="hoa-unit-badge">Unit 146</span>
              <span class="hoa-unit-badge">Unit 147</span>
              <span class="hoa-unit-badge">Unit 148</span>
              <span class="hoa-unit-badge">Unit 149</span>
              <span class="hoa-unit-badge">Unit 150</span>
          </div>
        </section>
      </main>

      <footer class="planner-footer">
        HOA Synced securely via Supabase (login required).
      </footer>
    </div>
  </div>

  <script src="../js/utils.js?v=20260108"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="../js/supabase-client.js"></script>
  <script>
    const todayDateEl = document.getElementById('today-date');
    if (todayDateEl) {
      todayDateEl.textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-UaxU5iHoAKrjdWO9x4vFzUFnprQgGsjbqReb4zLGm03P9pn5SHmUfa/9ziXxFEqJhm8C+N1Am1+jNL56kfcZOQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const unitSelect = document.getElementById('unit-select');
    const unitFile = document.getElementById('unit-pdf-input');
    const unitSummary = document.getElementById('unit-summary-output');
    const unitMeta = document.getElementById('unit-summary-meta');
    const STOPWORDS = new Set(['the','and','of','to','in','a','for','on','at','by','with','is','it','as','be','an','or','from','that','this','are','was','were','will','can','may','not','your','you']);

    // Populate unit select 001-150
    if (unitSelect) {
      const frag = document.createDocumentFragment();
      for (let i = 1; i <= 150; i++) {
        const opt = document.createElement('option');
        opt.value = `Unit ${String(i).padStart(3, '0')}`;
        opt.textContent = opt.value;
        frag.appendChild(opt);
      }
      unitSelect.appendChild(frag);
    }

    unitFile?.addEventListener('change', async (evt) => {
      const file = evt.target.files?.[0];
      if (!file) return;
      unitSummary.textContent = 'Processing PDFâ€¦';
      unitMeta.innerHTML = '';
      try {
        const user = await requireSupabaseUser();
        if (!user) {
          unitSummary.textContent = 'Please log in to upload and sync PDFs.';
          return;
        }

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str).join(' ');
          text += ' ' + strings;
          if (text.length > 12000) break;
        }
        const summary = summarizeText(text);
        const wordCount = text.split(/\s+/).filter(Boolean).length;

        const unitName = unitSelect?.value || 'Unit';
        const path = `${user.id}/units/${unitName}/${Date.now()}-${file.name}`;
        const { error: uploadError } = await window.supabaseClient
          .storage.from('hoa-unit-files')
          .upload(path, file, { upsert: false });
        if (uploadError) throw uploadError;

        const { data: publicUrlData } = window.supabaseClient
          .storage.from('hoa-unit-files')
          .getPublicUrl(path);
        const fileUrl = publicUrlData?.publicUrl || '';

        await window.supabaseClient.from('hoa_units').insert({
          user_id: user.id,
          unit_name: unitName,
          file_name: file.name,
          file_url: fileUrl,
          summary,
          pages: pdf.numPages,
          words: wordCount
        });

        renderSummary(summary, {
          name: file.name,
          pages: pdf.numPages,
          words: wordCount,
          unit: unitName,
          url: fileUrl
        });
      } catch (err) {
        console.error(err);
        unitSummary.textContent = 'Unable to read or upload that PDF. Please try another file.';
      }
    });

    function summarizeText(text) {
      if (!text || !text.trim()) return 'No readable text found in this PDF.';
      const sentences = text.replace(/\s+/g, ' ').split(/(?<=[.?!])\s+/).filter(s => s.length > 20);
      const topSentences = sentences.slice(0, 3).join(' ');
      const freq = {};
      text.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).forEach(word => {
        if (!word || STOPWORDS.has(word)) return;
        freq[word] = (freq[word] || 0) + 1;
      });
      const keywords = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([w]) => w).join(', ');
      return `${topSentences || 'Summary unavailable.'}\n\nTop keywords: ${keywords || 'n/a'}`;
    }

    function renderSummary(summaryText, meta) {
      unitSummary.textContent = summaryText;
      unitMeta.innerHTML = [
        meta.unit ? `<span class="unit-summary-pill">${meta.unit}</span>` : '',
        meta.name ? `<span class="unit-summary-pill">File: ${meta.name}</span>` : '',
        meta.pages ? `<span class="unit-summary-pill">Pages: ${meta.pages}</span>` : '',
        meta.words ? `<span class="unit-summary-pill">Words: ${meta.words}</span>` : '',
        meta.url ? `<span class="unit-summary-pill"><a href="${meta.url}" target="_blank" rel="noopener">Open</a></span>` : ''
      ].filter(Boolean).join('');
    }
  </script>
</body>
</html>
