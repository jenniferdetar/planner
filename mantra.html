<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mantra - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Indie+Flower&family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --header-blue: #00326b;
            --mantra-green: #4f7942;
            --soft-bg: #fdfcf0;
            --border-color: #ddd;
            --sidebar-width: 250px;
            --section-sidebar-width: 60px;
        }

        body {
            background-color: #f3f2f1;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notebook-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background: #fff;
        }

        /* Multi-level Sidebar */
        .section-sidebar {
            width: var(--section-sidebar-width);
            background: #1e3a63;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: inset -1px 0 0 rgba(0,0,0,0.1);
        }

        .section-icon {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.2s ease;
            text-decoration: none;
            opacity: 0.7;
        }

        .section-icon:hover {
            background: rgba(255,255,255,0.1);
            opacity: 1;
            transform: scale(1.05);
        }

        .section-icon.active {
            background: rgba(255,255,255,0.15);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 1;
        }

        .section-icon.logout-icon {
            margin-top: auto;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .section-icon.logout-icon:hover {
            opacity: 1;
            color: #ffcdd2;
        }

        .notebook-main {
            flex-grow: 1;
            background: #fff;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
        }

        .notebook-page {
            width: 100%;
            padding: 10px 20px !important;
            background: #fff;
            position: relative;
            box-sizing: border-box;
            min-height: 100%;
            border-radius: 0;
            background-image: linear-gradient(#f1f1f1 1px, transparent 1px);
            background-size: 100% 30px;
        }

        .notebook-page::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50px;
            width: 2px;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.1);
        }

        .page-title {
            color: var(--mantra-green);
            font-family: 'Indie Flower', cursive;
            font-size: 3.5rem;
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: none;
        }
        .section-title {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .manifesto-section {
            margin-top: 10px;
        }
        .manifesto-item {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        .checkbox-box {
            width: 25px;
            height: 25px;
            border: 2px solid #f6d2a2;
            flex-shrink: 0;
            margin-top: 5px;
            background-color: #fff9f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--mantra-green);
        }
        .checkbox-box.checked::after {
            content: "‚úì";
        }
        .manifesto-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
            margin: 0;
        }
        .floral-corner {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            opacity: 0.6;
            pointer-events: none;
            z-index: 1;
            background-image: url('https://www.transparenttextures.com/patterns/floral-paper.png');
        }
        .input-group {
            margin-bottom: 30px;
            background: #fff;
            padding: 10px 10px 10px 60px;
        }
        .mantra-input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ccc;
            font-family: 'Coming Soon', cursive;
            font-size: 1.2rem;
            padding: 10px 0;
            outline: none;
            background: transparent;
        }
        .add-btn {
            background-color: var(--mantra-green);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Coming Soon', cursive;
            margin-top: 10px;
            float: right;
        }
        .mantras-list {
            margin-top: 40px;
            padding-left: 60px;
        }
        .mantra-item {
            margin-bottom: 20px;
            position: relative;
            padding-right: 40px;
        }
        .mantra-text {
            font-size: 1.3rem;
            line-height: 30px; /* Match background-size */
            color: #444;
        }
        .mantra-date {
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .delete-btn {
            position: absolute;
            right: 0;
            top: 5px;
            cursor: pointer;
            color: #ccc;
            font-size: 0.8rem;
        }
        .delete-btn:hover {
            color: #cc0000;
        }
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: #666;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div class="notebook-container">
        <aside class="section-sidebar">
            <a href="index.html" class="section-icon" title="Home">üè†</a>
            <a href="notebook.html?category=Work-Planner" class="section-icon" title="Work">üíº</a>
            <a href="notebook.html?category=Personal-Planner" class="section-icon active" title="Personal">üë§</a>
            <a href="notebook.html?category=Monthly-Review" class="section-icon" title="Planning">üìÖ</a>
            <a href="notebook.html?category=Budget" class="section-icon" title="Financial">üí∞</a>
            <div class="section-icon logout-icon" onclick="logout()" title="Logout">üö™</div>
        </aside>

        <main class="notebook-main">
            <div class="notebook-page">
                <div class="floral-corner"></div>
                <h1 class="page-title">Daily Mantras</h1>
                <div style="text-align: center; margin-bottom: 20px;">
                    <a href="notebook.html?category=Mantra" class="nav-link" style="display: inline-flex; border-color: var(--mantra-green); color: var(--mantra-green);">View Mantra Notebook</a>
                </div>

                <div class="section-title" id="manifesto-title">Manifesto</div>
                <script>
                    const mUrlParams = new URLSearchParams(window.location.search);
                    const mDateParam = mUrlParams.get('date');
                    const mYear = mDateParam ? new Date(mDateParam).getFullYear() : new Date().getFullYear();
                    document.getElementById('manifesto-title').innerText = `${mYear} Manifesto`;
                </script>
                <div class="manifesto-section">
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I am choosing depth over noise. I no longer confuse being needed with being called, and I understand that silence is not avoidance‚Äîit is where I hear God, my intuition, and my own wisdom most clearly. I will schedule solitude the way others schedule meetings, because if my calendar has no white space, something is out of alignment. Rest is not a reward for productivity; it is a responsibility I owe to my body, my mind, and my spirit.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I lead without shrinking. I have earned my seat at the table, and when necessary, I am capable of building the table myself. I will speak when I know something and step forward when I am ready, not when I am pressured. Visibility does not require apology, and leadership does not require loudness. It requires clarity, consistency, and the courage to stand steady even when it would be easier to disappear.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I build what grounds me. I value practical skills that feed people, calm homes, and create stability. There is dignity in old ways done well, and in returning to work that uses my hands and steadies my nervous system. When life feels chaotic, I come back to the tangible and the orderly. Creating structure is how I restore peace.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I serve with boundaries. I help people who are willing to participate in their own growth, and I release the need to rescue, overextend, or prove my worth through exhaustion. My generosity is intentional, not reactive, and my compassion does not require self-abandonment. I am allowed to care deeply without carrying everything.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I protect joy as a non-negotiable. Not every moment must be productive to be valuable. Some moments exist simply to be remembered‚Äîshared meals, laughter, road trips, quiet conversations, and ordinary days that become sacred because I was fully present. Joy is not a distraction from my purpose; it is evidence that I am living it.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I trust the pace of my life. I am not late, not behind, and not missing anything meant for me. I am becoming. I will not rush what is meant to mature, and I will not carry what was never mine to hold. Consistency matters more than urgency, and faith steadies me when fear tries to speak louder.</p>
                    </div>
                    <div class="manifesto-item">
                        <div class="checkbox-box"></div>
                        <p class="manifesto-text">I am building a life where work is meaningful but not consuming, leadership is steady rather than frantic, service is impactful without being depleting, and home is calm instead of chaotic. My faith remains central, my values guide my choices, and my peace is protected on purpose. I move forward with intention, rooted rather than rushed, trusting that this way of living is not only sustainable‚Äîit is right.</p>
                    </div>
                </div>

                <div class="section-title">Collection</div>
                
                <div class="input-group">
                    <input type="text" id="new-mantra" class="mantra-input" placeholder="Enter a new mantra..." onkeypress="if(event.key==='Enter')handleAddMantra()">
                    <button class="add-btn" onclick="handleAddMantra()">Add to Collection</button>
                </div>

                <div id="mantras-list" class="mantras-list">
                    <!-- Mantras will load here -->
                </div>
            </div>
        </main>
    </div>
    <div id="save-status" class="save-status">All changes saved</div>

    <script>
        const urlParams_main = new URLSearchParams(window.location.search);
        const dateParam_main = urlParams_main.get('date');
        const currentYear = dateParam_main ? new Date(dateParam_main).getFullYear() : new Date().getFullYear();
        const CATEGORY = `Mantra-${currentYear}`;
        
        const FEATURED_KEY = `featured-mantra-${currentYear}`;
        const PERSISTENCE_KEY = `mantra-data-${currentYear}`;
        const DRAFT_KEY = `draft-mantra-${currentYear}`;
        let saveTimeout;

        async function init() {
            loadManifestoState();
            loadMantras();
            setupManifestoListeners();
            setupDraftPersistence();
        }

        async function setupDraftPersistence() {
            const input = document.getElementById('new-mantra');
            // Load draft
            const data = await fetchPlannerData(DRAFT_KEY, 1);
            if (data && data.length > 0) {
                input.value = data[0].content;
            }

            // Save draft with debounce
            let draftTimeout;
            input.addEventListener('input', () => {
                clearTimeout(draftTimeout);
                draftTimeout = setTimeout(async () => {
                    await savePlannerData(DRAFT_KEY, 'draft', input.value);
                }, 1000);
            });
        }

        async function loadManifestoState() {
            const data = await fetchPlannerData(PERSISTENCE_KEY);
            document.querySelectorAll('.manifesto-item').forEach((item, idx) => {
                const state = data.find(d => d.field_id === `manifesto-${idx}`);
                if (state && state.content === 'true') {
                    item.querySelector('.checkbox-box').classList.add('checked');
                }
            });
        }

        function setupManifestoListeners() {
            document.querySelectorAll('.manifesto-item').forEach((item, idx) => {
                const checkbox = item.querySelector('.checkbox-box');
                checkbox.addEventListener('click', async () => {
                    checkbox.classList.toggle('checked');
                    const isChecked = checkbox.classList.contains('checked');
                    const status = document.getElementById('save-status');
                    status.innerText = 'Saving...';
                    const success = await savePlannerData(PERSISTENCE_KEY, `manifesto-${idx}`, isChecked.toString());
                    status.innerText = success ? 'All changes saved' : 'Error saving';
                });
            });
        }

        async function loadMantras() {
            const entries = await fetchCategoryEntries(CATEGORY);
            const list = document.getElementById('mantras-list');
            list.innerHTML = '';
            entries.forEach(entry => {
                list.appendChild(createMantraElement(entry));
            });
        }

        function createMantraElement(entry) {
            const div = document.createElement('div');
            div.className = 'mantra-item';
            div.id = `mantra-${entry.id}`;
            div.innerHTML = `
                <div class="mantra-date">${formatDate(entry.created_at)}</div>
                <div class="mantra-text" contenteditable="true">${entry.content}</div>
                <span class="delete-btn" onclick="handleDeleteMantra(${entry.id})">Delete</span>
            `;

            // Add auto-save for edited mantra
            const textEl = div.querySelector('.mantra-text');
            let editTimeout;
            textEl.addEventListener('input', () => {
                clearTimeout(editTimeout);
                const status = document.getElementById('save-status');
                status.innerText = 'Saving...';
                editTimeout = setTimeout(async () => {
                    const success = await updateCategoryEntry(entry.id, textEl.innerText);
                    status.innerText = success ? 'All changes saved' : 'Error saving';
                }, 1000);
            });

            return div;
        }

        async function handleAddMantra() {
            const input = document.getElementById('new-mantra');
            const content = input.value.trim();
            if (!content) return;

            const status = document.getElementById('save-status');
            status.innerText = 'Saving...';
            const newEntry = await saveCategoryEntry(CATEGORY, content);
            if (newEntry) {
                input.value = '';
                // Clear draft from DB
                await savePlannerData(DRAFT_KEY, 'draft', '');
                status.innerText = 'Saved';
                document.getElementById('mantras-list').prepend(createMantraElement(newEntry));
                setTimeout(() => { status.innerText = 'All changes saved'; }, 2000);
            }
        }

        async function handleDeleteMantra(id) {
            if (confirm('Delete this mantra?')) {
                const success = await deleteCategoryEntry(id);
                if (success) {
                    document.getElementById(`mantra-${id}`).remove();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
