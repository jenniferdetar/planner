<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Goals - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Coming Soon', cursive; background: #fff; }
        
        .content-area { padding: 0 !important; width: 100vw; overflow: hidden !important; }
        
        .page-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #00326b; padding-bottom: 5px; }
        .page-title { font-size: 14pt; font-weight: 700; letter-spacing: 5px; text-transform: uppercase; color: #00326b; margin: 0; }
        
        .view-section { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e1dfdd; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .section-header { font-size: 10pt; font-weight: 700; text-transform: uppercase; color: #666; margin-bottom: 15px; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .handwriting { font-family: 'Coming Soon', cursive; font-size: 10pt; color: #2c3e50; line-height: 1.6; }
        .editable-area { outline: none; width: 100%; min-height: 20px; }
        .ruled-line { border-bottom: 1px solid #eee; min-height: 30px; margin-bottom: 5px; }
        
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; font-size: 10pt; cursor: pointer; color: #333; }
        .checkbox { width: 18px; height: 18px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #fff; flex-shrink: 0; }
        .checkbox.checked { background: #00326b; border-color: #00326b; }
        .checkbox.checked::after { content: 'âœ“'; color: #fff; font-size: 10pt; }

        .vision-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px; }
        .vision-card { background: #fffcf0; padding: 20px; border-radius: 8px; border: 1px solid #f0ead6; }
        .vision-label { font-size: 10pt; font-weight: 700; text-transform: uppercase; color: #8b7355; margin-bottom: 10px; letter-spacing: 1px; }

        .save-status { font-size: 10pt; color: #888; text-align: right; margin-top: 10px; }
        
        .label-row { font-size: 10pt; margin-bottom: 8px; display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
        .input-line { 
            font-family: 'Coming Soon', cursive; 
            font-size: 11pt; 
            border-bottom: 1px solid #eee; 
            min-height: 24px; 
            outline: none; 
            padding: 2px 4px;
            line-height: 1.6;
            flex-grow: 1;
            min-width: 150px;
        }
    </style>
</head>
<body>
    <div class="content-area">
        <div class="page-header">
            <h1 class="page-title" id="page-title">Personal Goals</h1>
        </div>

        <!-- MISSION SECTION -->
        <div class="view-section">
            <div class="section-header">MISSION</div>
            <p style="font-size: 10pt; color: #666; margin-bottom: 20px;">When thinking of your work, what do you consider to be your mission?</p>
            <div class="handwriting">
                <div class="label-row">My mission in my work is <div class="input-line" contenteditable="true" id="mission-work"></div></div>
                <div class="label-row">My goal is to <div class="input-line" contenteditable="true" id="mission-goal"></div> each day,</div>
                <div class="label-row">and I strive to <div class="input-line" contenteditable="true" id="mission-strive"></div></div>
                <div class="ruled-line" style="margin-top: 10px;"><div class="editable-area" contenteditable="true" id="mission-notes"></div></div>
            </div>
        </div>

        <!-- VALUE SECTION -->
        <div class="view-section">
            <div class="section-header">VALUE</div>
            <p style="font-size: 10pt; color: #666; margin-bottom: 15px;">What lights you up when you wake up each day? I value ...</p>
            <div class="checkbox-grid" id="values-container">
                <!-- Value items generated via script -->
            </div>
        </div>

        <!-- VISION SECTION -->
        <div class="view-section">
            <div class="section-header">VISION</div>
            <p style="font-size: 10pt; color: #666; margin-bottom: 15px;">Think BIG. Dream WILDLY. Where would you love to go one day?</p>
            <div class="vision-grid">
                <div class="vision-card">
                    <div class="vision-label">The Year Ahead</div>
                    <p style="font-size: 9pt; color: #8b7355; margin-top: -5px; margin-bottom: 10px;">I'd love to ...</p>
                    <div class="handwriting editable-area" contenteditable="true" id="vision-year" style="min-height: 100px;"></div>
                </div>
                <div class="vision-card">
                    <div class="vision-label">The Next Five Years</div>
                    <p style="font-size: 9pt; color: #8b7355; margin-top: -5px; margin-bottom: 10px;">I hope to ...</p>
                    <div class="handwriting editable-area" contenteditable="true" id="vision-5year" style="min-height: 100px;"></div>
                </div>
            </div>
        </div>

        <!-- PURPOSE SECTION -->
        <div class="view-section">
            <div class="section-header">PURPOSE</div>
            <p style="font-size: 10pt; color: #666; margin-bottom: 15px;">What is your purpose? What are you gifted in that serves those around you each day?</p>
            <div class="handwriting">
                <div class="ruled-line"><div class="editable-area" contenteditable="true" id="purpose-content" style="min-height: 150px;"></div></div>
            </div>
        </div>

    </div>

    <div id="save-status" class="save-status">All changes saved</div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const displayDate = parseLocalDate(dateParam) || new Date();
        const currentYear = displayDate.getFullYear();
        const PERSISTENCE_KEY = `personal-goals-${currentYear}`;
        let saveTimeout;

        const VALUES = ['Community', 'My family', 'Integrity', 'Determination', 'Grit', 'My health', 'Confidence', 'My faith', 'Gratitude', 'Humility', 'Innovation', 'Organization', 'Resourcefulness', 'Frugality'];

        async function init() {
            document.getElementById('page-title').innerText = `Personal Goals ${currentYear}`;
            if (typeof setGlobalHeaderTitle === 'function') {
                setGlobalHeaderTitle(`PERSONAL GOALS ${currentYear}`);
            }

            const container = document.getElementById('values-container');
            
            // Add fixed values
            VALUES.forEach(val => {
                const id = `val-cb-${val.replace(/\s+/g, '-').toLowerCase()}`;
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `<div class="checkbox" id="${id}"></div> <span>${val}</span>`;
                div.onclick = () => toggleCheckbox(id);
                container.appendChild(div);
            });

            // Add some empty slots for custom values
            for (let i = 1; i <= 3; i++) {
                const chkId = `val-chk-custom-${i}`;
                const txtId = `val-txt-custom-${i}`;
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <div class="checkbox" id="${chkId}"></div>
                    <div class="input-line" style="min-height: 18px; font-size: 10pt;" contenteditable="true" id="${txtId}"></div>
                `;
                div.querySelector('.checkbox').onclick = (e) => {
                    e.stopPropagation();
                    toggleCheckbox(chkId);
                };
                container.appendChild(div);
            }

            if (typeof fetchPlannerData === 'function') {
                const data = await fetchPlannerData(PERSISTENCE_KEY, 100);
                data.forEach(d => {
                    const el = document.getElementById(d.field_id);
                    if (el) {
                        if (el.classList.contains('checkbox')) {
                            if (d.content === 'true') el.classList.add('checked');
                        } else {
                            el.innerText = d.content;
                        }
                    }
                });
            }

            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.oninput = () => handleSave(el.id, el.innerText);
            });
        }

        function toggleCheckbox(id) {
            const el = document.getElementById(id);
            el.classList.toggle('checked');
            handleSave(id, el.classList.contains('checked') ? 'true' : 'false');
        }

        async function handleSave(fieldId, content) {
            const status = document.getElementById('save-status');
            status.innerText = 'Saving...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (typeof savePlannerData === 'function') {
                    const result = await savePlannerData(PERSISTENCE_KEY, fieldId, content);
                    if (result !== null) {
                        status.innerText = 'All changes saved';
                    } else {
                        status.innerText = 'Error saving - check console';
                        status.style.color = '#a4262c';
                        setTimeout(() => { status.style.color = '#888'; }, 3000);
                    }
                }
            }, 1000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>