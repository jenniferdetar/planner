<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root { --binder-leather: #4a3427; --paper-color: #fdfdfd; }
        body { background-color: #2b1d14; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .binder-shell { display: flex; width: 98vw; height: 96vh; background: var(--binder-leather); background-image: radial-gradient(circle at 2px 2px, rgba(0,0,0,0.15) 1px, transparent 0), linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05) 75%, transparent 75%, transparent); background-size: 4px 4px, 20px 20px; border-radius: 20px; padding: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 100px rgba(0,0,0,0.3); position: relative; margin: 2vh auto; border: 4px solid #3d2b21; }
        .spine { width: 60px; background: linear-gradient(to right, #3d2b21, #5d4335, #3d2b21); position: relative; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 40px 0; z-index: 10; }
        .ring { width: 45px; height: 12px; background: linear-gradient(to bottom, #d1d5db, #9ca3af, #d1d5db); border-radius: 6px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .left-page, .right-page { flex: 1; background: var(--paper-color); padding: 25px; overflow-y: auto; position: relative; box-shadow: inset 0 0 15px rgba(0,0,0,0.05); }
        .left-page { border-radius: 5px 0 0 5px; border-right: 1px solid #ddd; }
        .right-page { border-radius: 0 5px 5px 0; border-left: 1px solid #ddd; }
        .tabs-container { position: absolute; right: -45px; top: 50px; display: flex; flex-direction: column; gap: 5px; z-index: 100; }
        .tab { width: 80px; padding: 12px 10px; background: #eee; color: #555; font-size: 10pt; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border-radius: 0 8px 8px 0; cursor: pointer; transition: all 0.2s; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border: 1px solid #ccc; border-left: none; writing-mode: vertical-rl; text-orientation: mixed; }
        .tab:hover { padding-left: 15px; background: #f5f5f5; }
        .tab.active { background: #fff; color: var(--binder-leather); padding-left: 20px; width: 90px; border-color: var(--binder-leather); }
        .page-title { font-size: 10pt; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: #4a3427; margin-bottom: 5px; border-bottom: 2px solid #4a3427; padding-bottom: 5px; text-align: center; }
        .page-meta { font-size: 8pt; color: #888; text-align: center; margin-bottom: 15px; font-style: italic; }
        .handwriting, textarea, .editable-cell, .slot-content, .editable-area { font-family: 'Coming Soon', cursive; font-size: 1.1rem; color: #2c3e50; }
        .text-wrap-clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; max-height: 2.4em; }
        .special-table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        .special-table { border-collapse: collapse; width: 100%; font-size: 10pt; }
        .special-table th, .special-table td { border: 1px solid #eee; padding: 5px; text-align: center; }
        .special-table th { background: #f8f9fa; font-weight: 700; position: sticky; top: 0; z-index: 10; font-size: 9pt; text-transform: uppercase; }
        .special-table .sticky-col { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #eee; }
        .text-left { text-align: left !important; }
        .daily-columns { display: grid; gap: 0; border: 1px solid #eee; border-radius: 5px; overflow: hidden; }
        .day-col { border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fff; }
        .day-header { text-align: center; padding: 5px; font-weight: 700; font-size: 8pt; color: #fff; text-transform: uppercase; }
        .sun-header { background: #f59e9e; } .mon-header { background: #ffca38; } .tue-header { background: #a2d9d9; }
        .wed-header { background: #5d9cec; } .thu-header { background: #f59e9e; } .fri-header { background: #ffca38; } .sat-header { background: #a2d9d9; }
        .time-slot { height: 35px; border-bottom: 1px dotted #ccc; display: flex; align-items: center; padding: 2px 5px; font-size: 8pt; }
        .time-label { width: 25px; color: #888; font-size: 7pt; flex-shrink: 0; }
        .check-box { width: 14px; height: 14px; border: 1px solid #ccc; flex-shrink: 0; cursor: pointer; margin-right: 5px; }
        .check-box.checked { background: #4a3427; position: relative; }
        .check-box.checked::after { content: '‚úì'; color: #fff; font-size: 10px; position: absolute; top: -1px; left: 2px; }
        .slot-content { flex-grow: 1; outline: none; min-height: 100%; display: flex; align-items: center; padding-left: 2px; }
        .event-pill { font-size: 8pt; padding: 2px 4px; border-radius: 4px; margin-bottom: 1px; display: block; width: 100%; }
        .logout-btn { position: absolute; bottom: 20px; left: 20px; font-size: 8pt; color: #fff; cursor: pointer; opacity: 0.6; z-index: 100; }
        .logout-btn:hover { opacity: 1; }
    </style>
</head>
<body>
    <div class="binder-shell">
        <div class="left-page" id="left-page-content"></div>
        <div class="spine">
            <div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div>
        </div>
        <div class="right-page" id="right-page-content"></div>
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('Home')">Home</div>
            <div class="tab" onclick="switchTab('HOA')">HOA</div>
            <div class="tab" onclick="switchTab('CSEA')">CSEA</div>
            <div class="tab" onclick="switchTab('iCAAP')">iCAAP</div>
            <div class="tab" onclick="switchTab('Finance')">Finance</div>
            <div class="tab" onclick="switchTab('Planning')">Plan</div>
        </div>
        <div class="logout-btn" onclick="logout()">üö™ Logout</div>
    </div>

    <script>
        const sections = {
            Home: { title: 'Home Page', leftView: 'Calendar', rightView: 'PlannerLinks' },
            WorkPlanner: { title: 'Work Planner', leftView: 'WorkPlannerLeft', rightView: 'WorkPlannerRight' },
            PersonalPlanner: { title: 'Personal Planner', leftView: 'PersonalPlannerLeft', rightView: 'PersonalPlannerRight' },
            HOA: { title: 'HOA Notes', leftView: 'Notes', rightView: 'Empty' },
            CSEA: { title: 'CSEA Hub', leftView: 'Notes', rightView: 'InteractionLog' },
            iCAAP: { title: 'iCAAP Tracking', leftView: 'Notes', rightView: 'iCAAPLinks' },
            iCAAPAttendance: { title: 'Attendance Tracking', leftView: 'Attendance', rightView: 'Empty' },
            iCAAPTracking: { title: 'iCAAP Tracking Log', leftView: 'TrackingLog', rightView: 'Empty' },
            Finance: { title: 'Financial Planning', leftView: 'Budget', rightView: 'FinanceLinks' },
            CheckBreakdown: { title: 'Check Breakdown', leftView: 'CheckBreakdown', rightView: 'Empty' },
            FinancialReview: { title: 'Financial Review', leftView: 'FinancialReview', rightView: 'Empty' },
            Planning: { title: 'Planning & Review', leftView: 'Notes', rightView: 'Empty' }
        };

        let employees = [];
        let financialBills = [];
        const attnOptions = ["", "Cochren", "Beaudry", "Illness", "Kin Care", "Personal Necessity", "Vacation", "Bereavement"];
        const monthNames = ['July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June'];

        async function refreshGlobalData() {
            const [empData, billData] = await Promise.all([ fetchCseaMembers(), fetchFinancialBills() ]);
            const nameSet = new Set(DEFAULT_EMPLOYEES.map(toTitleCase));
            empData.forEach(m => { const name = m.full_name || m.name; if (name) nameSet.add(toTitleCase(name)); });
            employees = [...nameSet].sort();
            const billMap = new Map();
            DEFAULT_BILLS.forEach(b => billMap.set(b.item, b));
            billData.forEach(b => billMap.set(b.item, b));
            financialBills = [...billMap.values()].sort((a, b) => a.id - b.id);
        }

        let currentCategory = 'Home';
        const leftPage = document.getElementById('left-page-content');
        const rightPage = document.getElementById('right-page-content');
        let saveTimeout = null;
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        let displayDate = dateParam ? new Date(dateParam) : new Date();
        if (dateParam && dateParam.includes('-')) {
            const [y, m, d] = dateParam.split('-').map(Number);
            displayDate = new Date(y, m - 1, d);
        }
        let currentYear = displayDate.getFullYear();
        let fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();

        function updateGlobalDate(newDate) {
            displayDate = newDate;
            currentYear = displayDate.getFullYear();
            fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();
            switchTab(currentCategory);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshGlobalData();
            const catParam = urlParams.get('category');
            if (catParam && sections[catParam]) currentCategory = catParam;
            switchTab(currentCategory);
        });

        async function switchTab(tabId) {
            currentCategory = tabId;
            const dateStr = displayDate.toISOString().split('T')[0];
            const newUrl = `notebook.html?category=${tabId}&date=${dateStr}`;
            window.history.pushState({ category: tabId, date: dateStr }, '', newUrl);
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.innerText.toLowerCase() === tabId.toLowerCase() || (t.innerText === 'Plan' && tabId === 'Planning'));
            });
            const config = sections[tabId];
            leftPage.innerHTML = '<div class="handwriting" style="text-align: center; margin-top: 50%;">Loading...</div>';
            rightPage.innerHTML = '';
            await renderView(config.leftView, leftPage);
            await renderView(config.rightView, rightPage);
        }

        async function renderView(viewType, container) {
            container.innerHTML = '';
            if (viewType === 'Calendar') await renderCalendar(container);
            else if (viewType === 'PlannerLinks') renderPlannerLinks(container);
            else if (viewType === 'Notes') await renderNotes(container);
            else if (viewType === 'InteractionLog') await renderCseaLog(container);
            else if (viewType === 'iCAAPLinks') renderIcaapLinks(container);
            else if (viewType === 'Budget') await renderBudget(container);
            else if (viewType === 'FinanceLinks') renderFinanceLinks(container);
            else if (viewType === 'WorkPlannerLeft') await renderWorkPlanner(container, 'left');
            else if (viewType === 'WorkPlannerRight') await renderWorkPlanner(container, 'right');
            else if (viewType === 'PersonalPlannerLeft') await renderPersonalPlanner(container, 'left');
            else if (viewType === 'PersonalPlannerRight') await renderPersonalPlanner(container, 'right');
            else if (viewType === 'Attendance') await renderIcaapAttendance(container);
            else if (viewType === 'TrackingLog') await renderIcaapTracking(container);
            else if (viewType === 'CheckBreakdown') await renderCheckBreakdown(container);
            else if (viewType === 'FinancialReview') await renderFinancialReview(container);
            else if (viewType === 'Empty') container.innerHTML = '<div class="handwriting" style="opacity: 0.1; text-align: center; margin-top: 50%;">Notes & Thoughts</div>';
        }

        function renderWorkPlannerView() { switchTab('WorkPlanner'); }
        function renderPersonalPlannerView() { switchTab('PersonalPlanner'); }
        function renderIcaapAttendanceView() { switchTab('iCAAPAttendance'); }
        function renderIcaapTrackingView() { switchTab('iCAAPTracking'); }
        function renderCheckBreakdownView() { switchTab('CheckBreakdown'); }
        function renderFinancialReviewView() { switchTab('FinancialReview'); }

        async function renderWorkPlanner(container, side) {
            const startDay = displayDate.getDay();
            const weekStart = new Date(displayDate);
            weekStart.setDate(weekStart.getDate() - startDay);
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(weekStart), fetchPlannerData(weekStart) ]);
            const timeSlots = []; for (let h = 6; h <= 21; h++) { timeSlots.push(`${h}:00`, `${h}:30`); } timeSlots.push('22:00');
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            if (side === 'left') {
                container.innerHTML = `<div class="page-title">WORK PLANNER - SUN-TUE</div><div class="top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;"><div class="top-section"><div class="section-title">Priority #1</div><div class="editable-area planner-edit handwriting" contenteditable="true" id="priority-1" data-field="priority-1"></div></div><div class="top-section"><div class="section-title">Priority #2</div><div class="editable-area planner-edit handwriting" contenteditable="true" id="priority-2" data-field="priority-2"></div></div></div><div id="planner-cols-left" class="daily-columns" style="grid-template-columns: repeat(3, 1fr);"></div>`;
                const startStr = weekStart.toISOString().split('T')[0];
                plannerData.forEach(item => { if (item.date === startStr) { const el = container.querySelector('#' + item.field_id); if (el) el.innerText = item.content; } });
                const cols = container.querySelector('#planner-cols-left');
                for (let i = 0; i < 3; i++) renderDayCol(cols, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses);
            } else {
                container.innerHTML = `<div class="page-title">WORK PLANNER - WED-SAT</div><div id="planner-cols-right" class="daily-columns" style="grid-template-columns: repeat(4, 1fr);"></div>`;
                const cols = container.querySelector('#planner-cols-right');
                for (let i = 3; i < 7; i++) renderDayCol(cols, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses);
            }
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
        }

        function renderDayCol(container, i, weekStart, events, plannerData, timeSlots, dayNames, dayClasses) {
            const dayDate = new Date(weekStart); dayDate.setDate(dayDate.getDate() + i); const dayStr = dayDate.toISOString().split('T')[0];
            const dayEvents = events.filter(e => e.date === dayStr);
            const dayCol = document.createElement('div'); dayCol.className = 'day-col';
            dayCol.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()} ${formatDateMMM(dayStr).toUpperCase()}</div>`;
            timeSlots.forEach(slot => {
                const isChecked = plannerData.some(d => d.date === dayStr && d.field_id === `check-slot-${slot}` && d.content === 'true');
                const saved = plannerData.find(d => d.date === dayStr && d.field_id === `slot-${slot}`);
                const eventTitle = getEventForSlot(dayEvents, slot, i);
                const slotDiv = document.createElement('div'); slotDiv.className = 'time-slot';
                slotDiv.innerHTML = `<div class="time-label">${formatTime(slot, true)}</div><div class="check-box${isChecked ? ' checked' : ''}" onclick="togglePlannerCheck(this, '${dayStr}', 'check-slot-${slot}')"></div><div class="slot-content ${eventTitle ? '' : 'planner-edit'} text-wrap-clamp" ${eventTitle ? '' : 'contenteditable="true"'} data-field="slot-${slot}" data-date="${dayStr}" style="font-size: 0.9rem;">${eventTitle ? `<div class="${getEventClass(eventTitle)}">${eventTitle}</div>` : (saved ? saved.content : '')}</div>`;
                dayCol.appendChild(slotDiv);
            });
            container.appendChild(dayCol);
        }

        async function renderCalendar(container) {
            const month = displayDate.getMonth(); const year = displayDate.getFullYear();
            const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay();
            const monthName = displayDate.toLocaleString('default', { month: 'long' });
            container.innerHTML = `<div class="page-title">${monthName.toUpperCase()} ${year}</div><div class="calendar-grid">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="calendar-header">${d}</div>`).join('')}${Array(startingDay).fill('').map(() => `<div class="calendar-day"></div>`).join('')}${Array(daysInMonth).fill(0).map((_, i) => { const d = i + 1; const dateStr = \`\${year}-\${String(month+1).padStart(2,'0')}-\${String(d).padStart(2,'0')}\`; return \`<div class="calendar-day" style="cursor: pointer;" onclick="updateGlobalDate(new Date(\${year}, \${month}, \${d}))"><div style="font-weight: 700; border-bottom: 1px solid #eee; margin-bottom: 5px; font-size: 8pt;">\${d}</div><div id="events-\${dateStr}"></div></div>\`; }).join('')}</div>`;
            const events = await fetchCalendarEvents(firstDay, daysInMonth);
            events.forEach(e => { const dc = container.querySelector('#events-' + e.date); if (dc) { const p = document.createElement('div'); p.className = 'event-link text-wrap-clamp'; p.innerText = e.title; dc.appendChild(p); } });
        }

        function renderPlannerLinks(container) {
            container.innerHTML = `<div class="page-title">PLANNER DIRECTORY</div><div class="page-meta">\${displayDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div><div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;"><div class="tab home active" style="width: 100%; border-radius: 8px; padding: 25px; border: 1px solid #ccc; cursor: pointer; height: auto; display: block; text-align: center; writing-mode: horizontal-tb;" onclick="renderWorkPlannerView()">üíº OPEN WORK PLANNER</div><div class="tab active" style="width: 100%; border-radius: 8px; padding: 25px; border: 1px solid #ccc; cursor: pointer; height: auto; display: block; text-align: center; writing-mode: horizontal-tb;" onclick="renderPersonalPlannerView()">üë§ OPEN PERSONAL PLANNER</div><div class="handwriting" style="margin-top: 40px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">"Success is the sum of small efforts, repeated day in and day out."</div></div>`;
        }

        async function renderNotes(container) {
            container.innerHTML = `<div class="page-title">\${currentCategory.toUpperCase()} NOTES</div><div class="page-meta">\${displayDate.toLocaleDateString()}</div><div class="new-note-area"><textarea id="new-note-content" class="handwriting" placeholder="Start typing your notes here..." style="width: 100%; min-height: 200px; border: none; outline: none; background: transparent; resize: none;"></textarea><div style="display: flex; justify-content: space-between; align-items: center;"><button class="save-btn" onclick="handleAddNote()">Add Entry</button><div id="save-status" class="save-status">All changes saved</div></div></div><div id="entries-list" style="margin-top: 20px;"></div>`;
            await loadEntries(container.querySelector('#entries-list'));
        }

        async function renderPersonalPlanner(container, side) {
            const [events, plannerData] = await Promise.all([ fetchCalendarEvents(displayDate), fetchPlannerData(displayDate) ]);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            if (side === 'left') {
                container.innerHTML = `<div class="page-title">PERSONAL PLANNER - SUN-TUE</div><div class="habit-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">\${renderHabitSection('Self Care', ['Shower', 'Read', 'Bible App'])}\${renderHabitSection('Home Care', ['Make beds', 'Laundry', 'Meals'])}</div><div id="personal-cols-left" class="daily-columns" style="grid-template-columns: repeat(3, 1fr);"></div>`;
                const cols = container.querySelector('#personal-cols-left');
                for (let i = 0; i < 3; i++) renderPersonalDay(cols, i, displayDate, plannerData, dayNames, dayClasses);
            } else {
                container.innerHTML = `<div class="page-title">PERSONAL PLANNER - WED-SAT</div><div class="enjoy-banner" style="margin-bottom: 15px;">üè† ‚ù§ ENJOY YOUR FAMILY ‚ù§ üè†</div><div id="personal-cols-right" class="daily-columns" style="grid-template-columns: repeat(4, 1fr);"></div>`;
                const cols = container.querySelector('#personal-cols-right');
                for (let i = 3; i < 7; i++) renderPersonalDay(cols, i, displayDate, plannerData, dayNames, dayClasses);
            }
            container.querySelectorAll('.planner-edit').forEach(el => { el.oninput = (e) => handlePlannerInput(e.target); });
            container.querySelectorAll('.mini-day-box').forEach(box => { const { field, date } = box.dataset; if (plannerData.some(d => d.date === date && d.field_id === field && d.content === 'true')) box.classList.add('checked'); });
        }

        function renderPersonalDay(container, i, startDate, plannerData, dayNames, dayClasses) {
            const d = new Date(startDate); d.setDate(d.getDate() + i); const ds = d.toISOString().split('T')[0];
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header \${dayClasses[i]}">\${dayNames[i].substring(0,3).toUpperCase()} \${formatDateMMM(ds).toUpperCase()}</div><div style="padding: 5px;"><div class="section-title" style="font-size: 7pt;">Focus</div><div class="planner-edit handwriting" contenteditable="true" data-field="focus" data-date="\${ds}" style="min-height: 40px; border-bottom: 1px solid #eee; margin-bottom: 5px;">\${plannerData.find(d => d.date === ds && d.field_id === 'focus')?.content || ''}</div><div class="section-title" style="font-size: 7pt;">Notes</div><div class="planner-edit handwriting" contenteditable="true" data-field="notes" data-date="\${ds}" style="min-height: 250px; font-size: 0.9rem;">\${plannerData.find(d => d.date === ds && d.field_id === 'notes')?.content || ''}</div></div>`;
            container.appendChild(col);
        }

        function renderHabitSection(title, habits) {
            return `<div class="habit-section" style="padding: 5px; border: 1px solid #eee; border-radius: 5px;"><div class="section-title" style="font-size: 8pt; margin-bottom: 5px;">\${title}</div>\${habits.map(h => \`<div class="habit-row" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px;"><span style="font-size: 7pt; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60px;">\${h}</span><div style="display: flex; gap: 2px;">\${[0,1,2,3,4,5,6].map(d => { const date = new Date(displayDate); date.setDate(date.getDate() - date.getDay() + d); const ds = date.toISOString().split('T')[0]; return \`<div class="mini-day-box" data-field="habit-\${h}" data-date="\${ds}" onclick="toggleHabitCheck(this)"></div>\`; }).join('')}</div></div>\`).join('')}</div>`;
        }

        async function renderCseaLog(container) {
            container.innerHTML = `<div class="page-title">MEMBER INTERACTION LOG</div><div class="special-table-container"><table class="log-table"><thead><tr><th>Date</th><th>Member</th><th>Location</th><th>Discussion</th><th>Outcome</th><th></th></tr></thead><tbody id="interaction-log-body"></tbody><tfoot><tr class="log-input-row"><td><input type="date" id="log-date" class="log-input" style="font-size: 8pt;"></td><td><input type="text" id="log-member" class="log-input" placeholder="Name" list="members-list" style="font-size: 8pt;"></td><td><input type="text" id="log-location" class="log-input" placeholder="Loc" list="schools-list" style="font-size: 8pt;"></td><td><input type="text" id="log-discussion" class="log-input" placeholder="Issue" list="issues-list" style="font-size: 8pt;"></td><td><input type="text" id="log-outcome" class="log-input" placeholder="Result" style="font-size: 8pt;"></td><td><button class="add-log-btn" onclick="handleAddInteraction()">Add</button></td></tr></tfoot></table></div><datalist id="members-list"></datalist><datalist id="schools-list"></datalist><datalist id="issues-list"></datalist>`;
            const interactions = await fetchInteractions('CSEA'); const tbody = container.querySelector('#interaction-log-body');
            interactions.forEach(inter => { const tr = document.createElement('tr'); tr.innerHTML = \`<td style="font-size: 8pt;">\${formatDateMMM(inter.date_spoke)}</td><td style="font-size: 8pt;">\${inter.member_name}</td><td style="font-size: 8pt;">\${inter.work_location}</td><td style="font-size: 8pt;" class="text-wrap-clamp">\${inter.discussion}</td><td style="font-size: 8pt;" class="text-wrap-clamp">\${inter.outcome || ''}</td><td><span class="delete-btn" onclick="handleDeleteInteraction(\${inter.id})">Del</span></td>\`; tbody.appendChild(tr); });
            const [members, issues, schools] = await Promise.all([ fetchCseaMembers(), fetchCseaIssues(), fetchSchoolDirectory() ]);
            container.querySelector('#members-list').innerHTML = members.map(m => \`<option value="\${m.name}">\`).join('');
            container.querySelector('#issues-list').innerHTML = issues.map(i => \`<option value="\${i.issue_name}">\`).join('');
            container.querySelector('#schools-list').innerHTML = schools.map(s => \`<option value="\${s.site_name}">\`).join('');
            container.querySelector('#log-member').oninput = (e) => { const member = members.find(m => m.name === e.target.value); if (member) container.querySelector('#log-location').value = member.work_location; };
        }

        async function handleAddInteraction() {
            const interaction = { date_spoke: document.getElementById('log-date').value, member_name: document.getElementById('log-member').value, work_location: document.getElementById('log-location').value, discussion: document.getElementById('log-discussion').value, outcome: document.getElementById('log-outcome').value };
            if (!interaction.date_spoke || !interaction.member_name) return;
            if (await saveInteraction('CSEA', interaction)) switchTab('CSEA');
        }

        async function handleDeleteInteraction(id) { if (confirm('Delete?')) { if (await deleteInteraction(id)) switchTab('CSEA'); } }

        function toggleHabitCheck(el) { el.classList.toggle('checked'); const { field, date } = el.dataset; savePlannerData(displayDate.toISOString().split('T')[0], field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function handleAttendanceSave(select) { await savePlannerData(\`icaap-attendance-data-\${fiscalYear}\`, select.dataset.field, select.value); }

        async function handleTrackingSave(el) { const fieldId = el.dataset.field; const content = el.innerText; clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { savePlannerData(\`icaap-tracking-data-\${fiscalYear}\`, fieldId, content); }, 1000); }

        async function changeAttendanceWeek(delta) { displayDate.setDate(displayDate.getDate() + (delta * 7)); switchTab('iCAAPAttendance'); }

        async function handlePlannerInput(el) {
            const fieldId = el.dataset.field || el.id; const content = el.innerText; const dateStr = el.dataset.date || displayDate.toISOString().split('T')[0];
            clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { await savePlannerData(dateStr, fieldId, content); }, 1000);
        }

        async function togglePlannerCheck(el, date, fieldId) { el.classList.toggle('checked'); await savePlannerData(date, fieldId, el.classList.contains('checked') ? 'true' : 'false'); }

        function renderIcaapLinks(container) { container.innerHTML = \`<div class="page-title">ICAAP LOGS</div><div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"><button class="save-btn" style="width: 100%; text-align: left; padding: 15px;" onclick="renderIcaapAttendanceView()">üë§ Attendance Tracking</button><button class="save-btn" style="width: 100%; text-align: left; padding: 15px;" onclick="renderIcaapTrackingView()">üìà iCAAP Tracking Log</button></div>\`; }
        function renderFinanceLinks(container) { container.innerHTML = \`<div class="page-title">FINANCIAL TOOLS</div><div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"><button class="save-btn" style="width: 100%; text-align: left; padding: 15px;" onclick="renderCheckBreakdownView()">üìä Check Breakdown</button><button class="save-btn" style="width: 100%; text-align: left; padding: 15px;" onclick="renderFinancialReviewView()">üí∏ Financial Review</button></div>\`; }

        async function renderBudget(container) {
            container.innerHTML = `<div class="page-title">BUDGET PLANNING ${currentYear}</div><div class="special-table-container"><table class="special-table bill-table"><thead><tr><th>Cat</th><th>Item</th><th>Amt</th>\${['J','F','M','A','M','J','J','A','S','O','N','D'].map(m => \`<th>\${m}</th>\`).join('')}</tr></thead><tbody id="budget-body"></tbody></table></div>`;
            const tbody = container.querySelector('#budget-body');
            financialBills.forEach(bill => { const tr = document.createElement('tr'); tr.innerHTML = \`<td>\${bill.cat}</td><td class="text-left">\${bill.item}</td><td>\${bill.amt}</td>\${Array(12).fill(0).map((_, i) => \`<td><div class="check-box" data-field="chk-\${bill.id}-\${i+1}" onclick="toggleBudgetCheck(this)"></div></td>\`).join('')}\`; tbody.appendChild(tr); });
            const data = await fetchPlannerData(\`\${currentYear}-financial\`, 366);
            data.forEach(item => { const el = container.querySelector(\`[data-field="\${item.field_id}"]\`); if (el && item.content === 'true') el.classList.add('checked'); });
        }

        function toggleBudgetCheck(el) { el.classList.toggle('checked'); savePlannerData(\`\${currentYear}-financial\`, el.dataset.field, el.classList.contains('checked') ? 'true' : 'false'); }

        async function loadEntries(container) {
            const dateStr = displayDate.toISOString().split('T')[0];
            const entries = await fetchEntries(currentCategory, dateStr);
            container.innerHTML = entries.map(e => \`<div class="note-entry handwriting" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\${e.content}</div>\`).join('');
        }

        async function handleAddNote() {
            const content = document.getElementById('new-note-content').value;
            if (!content) return;
            const dateStr = displayDate.toISOString().split('T')[0];
            if (await saveEntry(currentCategory, dateStr, content)) { document.getElementById('new-note-content').value = ''; switchTab(currentCategory); }
        }

        async function renderIcaapAttendance(container) {
            const weekStart = new Date(displayDate); weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            const weekdays = []; for (let i = 0; i < 5; i++) { const d = new Date(weekStart); d.setDate(d.getDate() + i); weekdays.push(d); }
            container.innerHTML = \`<div class="page-title">ATTENDANCE</div><div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;"><button class="save-btn" onclick="changeAttendanceWeek(-1)">Prev</button><button class="save-btn" onclick="changeAttendanceWeek(1)">Next</button></div><div class="special-table-container"><table class="special-table"><thead><tr><th class="sticky-col">Name</th>\${weekdays.map(d => \`<th>\${d.toLocaleDateString('en-US', { weekday: 'short' })}<br>\${formatDateMMM(d.toISOString().split('T')[0])}</th>\`).join('')}</tr></thead><tbody id="attn-body"></tbody></table></div>\`;
            const tbody = container.querySelector('#attn-body');
            ["Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin", "Rene Gaudet", "Steve Maccarone", "Zina Dixon"].forEach(emp => {
                const tr = document.createElement('tr'); tr.innerHTML = \`<td class="sticky-col text-left">\${emp}</td>\${weekdays.map(d => \`<td><select class="attendance-select" data-field="attn-\${emp}-\${d.toISOString().split('T')[0]}" onchange="handleAttendanceSave(this)">\${attnOptions.map(o => \`<option value="\${o}">\${o}</option>\`).join('')}</select></td>\`).join('')}\`; tbody.appendChild(tr);
            });
            const data = await fetchPlannerData(\`icaap-attendance-data-\${fiscalYear}\`, 366);
            data.forEach(item => { const el = container.querySelector(\`[data-field="\${item.field_id}"]\`); if (el) el.value = item.content; });
        }

        async function renderIcaapTracking(container) {
            container.innerHTML = \`<div class="page-title">ICAAP TRACKING</div><div class="special-table-container" style="overflow: auto;"><table class="special-table" style="min-width: 1200px;"><thead><tr><th class="sticky-col">Name</th>\${monthNames.map(m => \`<th colspan="3">\${m}</th>\`).join('')}</tr></thead><tbody id="track-body"></tbody></table></div>\`;
            const tbody = container.querySelector('#track-body');
            employees.forEach((emp, ei) => {
                const tr = document.createElement('tr'); tr.innerHTML = \`<td class="sticky-col text-left">\${emp}</td>\${monthNames.map((m, mi) => \`<td contenteditable="true" class="editable-cell" data-field="m\${mi}-\${ei}-paylog" oninput="handleTrackingSave(this)"></td><td contenteditable="true" class="editable-cell" data-field="m\${mi}-\${ei}-hours" oninput="handleTrackingSave(this)"></td><td contenteditable="true" class="editable-cell" data-field="m\${mi}-\${ei}-appr" oninput="handleTrackingSave(this)"></td>\`).join('')}\`; tbody.appendChild(tr);
            });
            const data = await fetchPlannerData(\`icaap-tracking-data-\${fiscalYear}\`, 366);
            data.forEach(item => { const el = container.querySelector(\`[data-field="\${item.field_id}"]\`); if (el) el.innerText = item.content; });
        }

        async function renderCheckBreakdown(container) {
            container.innerHTML = \`<div class="page-title">CHECK BREAKDOWN</div><div class="special-table-container"><table class="special-table"><thead><tr id="check-header"><th class="sticky-col">Account</th></tr></thead><tbody id="check-body"><tr><td class="sticky-col text-left">Checking</td></tr><tr><td class="sticky-col text-left">Check</td></tr><tr><td class="sticky-col text-left">Tithe</td></tr><tr><td class="sticky-col text-left">Left Over</td></tr></tbody></table></div>\`;
            const header = container.querySelector('#check-header'); const tbody = container.querySelector('#check-body');
            for (let i = 0; i < 24; i++) {
                const th = document.createElement('th'); th.innerText = \`Pay \${i+1}\`; header.appendChild(th);
                tbody.querySelectorAll('tr').forEach((tr, ri) => { const td = document.createElement('td'); td.contentEditable = true; td.className = 'editable-cell'; td.dataset.field = \`chk-\${i}-\${ri}\`; td.oninput = (e) => handleModuleEdit(e.target, \`check-breakdown-\${currentYear}\`); tr.appendChild(td); });
            }
            const data = await fetchPlannerData(\`check-breakdown-\${currentYear}\`, 100);
            data.forEach(item => { const el = container.querySelector(\`[data-field="\${item.field_id}"]\`); if (el) el.innerText = item.content; });
        }

        async function handleModuleEdit(el, pk) { const fieldId = el.dataset.field || el.id; const content = el.innerText || el.value; clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { savePlannerData(pk, fieldId, content); }, 1000); }

        async function renderFinancialReview(container) {
            container.innerHTML = \`<div class="page-title">FINANCIAL REVIEW</div><div class="review-grid">\${['Goals', 'Expenses', 'Savings'].map(t => \`<div class="review-box"><div class="box-title">\${t}</div><textarea class="handwriting module-edit" data-field="fin-\${t.toLowerCase()}" oninput="handleModuleEdit(this, 'fin-review-\${currentYear}')" style="width: 100%; min-height: 100px; border: none; background: transparent;"></textarea></div>\`).join('')}</div>\`;
            const data = await fetchPlannerData(\`fin-review-\${currentYear}\`, 10);
            data.forEach(item => { const el = container.querySelector(\`[data-field="\${item.field_id}"]\`); if (el) el.value = item.content; });
        }
    </script>
</body>
</html>
