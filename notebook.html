<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook - Home Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Indie+Flower&family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="shared.js"></script>
    <style>
        :root {
            --onenote-purple: #71338a;
            --onenote-bg: #f3f2f1;
            --line-height: 30px;
            --sidebar-width: 250px;
            --section-sidebar-width: 60px;
        }

        body {
            background-color: var(--onenote-bg);
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notebook-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background: #fff;
        }

        /* Multi-level Sidebar */
        .section-sidebar {
            width: var(--section-sidebar-width);
            background: #1e3a63;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: inset -1px 0 0 rgba(0,0,0,0.1);
        }

        .section-icon {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.2s ease;
            text-decoration: none;
            opacity: 0.7;
        }

        .section-icon:hover {
            background: rgba(255,255,255,0.1);
            opacity: 1;
            transform: scale(1.05);
        }

        .section-icon.active {
            background: rgba(255,255,255,0.15);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 1;
        }

        .section-icon.logout-icon {
            margin-top: auto;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .section-icon.logout-icon:hover {
            opacity: 1;
            color: #ffcdd2;
        }

        .pages-sidebar {
            width: var(--sidebar-width);
            background: #fdfdfd;
            border-right: 1px solid #e1dfdd;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-title {
            padding: 15px 20px;
            font-weight: 700;
            font-size: 0.75rem;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #edebe9;
        }

        .page-tab {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #323130;
            border-left: 3px solid transparent;
            line-height: 1.2;
            white-space: normal;
            word-wrap: break-word;
        }

        .page-tab:hover {
            background: #f3f2f1;
            color: #000;
        }

        .page-tab.active {
            background: #fff;
            border-left: 3px solid #2b579a;
            font-weight: 600;
            color: #2b579a;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
        }

        /* Notepaper Content Area */
        .notebook-main {
            flex-grow: 1;
            background: #fff;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
        }

        .notepaper {
            background-color: #fff;
            padding: 10px 20px !important;
            min-height: 100%;
            line-height: var(--line-height);
            position: relative;
            box-sizing: border-box;
        }

        .notepaper-content {
            font-family: 'Coming Soon', cursive;
            font-size: 1.1rem;
            color: #333;
            width: 100%;
            margin: 0 auto;
            transition: width 0.3s ease;
        }

        .notepaper-content.width-80 {
            width: 80%;
        }

        .page-header-container {
            margin-bottom: 10px;
            height: auto;
            min-height: calc(var(--line-height) * 2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid #e1dfdd;
            box-sizing: border-box;
            padding: 10px 0;
        }

        .page-title {
            margin: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.2rem;
            color: #333;
            line-height: calc(var(--line-height) * 1.5);
            font-weight: 400;
            outline: none;
        }

        .page-meta {
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.85rem;
            color: #605e5c;
            line-height: var(--line-height);
        }

        /* Note Entry Styles */
        .new-note-area {
            margin-bottom: var(--line-height);
        }

        textarea#new-note-content {
            width: 100%;
            min-height: calc(var(--line-height) * 3);
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Coming Soon', cursive;
            font-size: 1.1rem;
            line-height: var(--line-height);
            resize: none;
            padding: 0;
            display: block;
        }

        .save-btn {
            background: var(--onenote-purple);
            color: white;
            border: none;
            padding: 6px 20px;
            border-radius: 2px;
            cursor: pointer;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .save-btn:hover {
            filter: brightness(1.1);
        }

        .save-status {
            font-size: 0.8rem;
            color: #a19f9d;
            margin-top: 5px;
            font-family: 'Segoe UI', sans-serif;
        }

        .entries-list {
            margin-top: var(--line-height);
        }

        .note-entry {
            margin-bottom: var(--line-height);
            position: relative;
        }

        .entry-header {
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.8rem;
            color: #a19f9d;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 2px;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .note-entry:hover .entry-header {
            opacity: 1;
        }

        .entry-content {
            outline: none;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .delete-btn {
            color: #a19f9d;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .delete-btn:hover {
            color: #d83b01;
        }

        .tracking-links {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tracking-link {
            text-decoration: none;
            color: #605e5c;
            font-size: 0.75rem;
            background: #f3f2f1;
            padding: 4px 12px;
            border-radius: 15px;
            border: 1px solid #e1dfdd;
            transition: all 0.2s;
            font-weight: 600;
        }

        .tracking-link:hover {
            background: #edebe9;
            color: #323130;
        }

        .tracking-link.active {
            background: #2b579a;
            color: #fff;
            border-color: #2b579a;
        }

    </style>
</head>
<body>
    <div class="notebook-container">
        <aside class="section-sidebar">
            <a href="index.html" class="section-icon" title="Home">üè†</a>
            <div class="section-icon active" onclick="switchSection('work')" title="Work">üíº</div>
            <div class="section-icon" onclick="switchSection('personal')" title="Personal">üë§</div>
            <div class="section-icon" onclick="switchSection('planning')" title="Planning">üìÖ</div>
            <div class="section-icon" onclick="switchSection('financial')" title="Financial">üí∞</div>
            <div class="section-icon logout-icon" onclick="logout()" title="Logout">üö™</div>
        </aside>

        <aside class="pages-sidebar">
            <div id="sidebar-title" class="sidebar-title">Work Notes</div>
            <div id="pages-list">
                <!-- Pages will be injected here -->
            </div>
        </aside>

        <main class="notebook-main">
            <div class="notepaper">
                <div class="notepaper-content">
                    <div class="page-header-container">
                        <h1 id="page-title" class="page-title">Page Title</h1>
                        <div id="page-meta" class="page-meta">Tuesday, January 27, 2026</div>
                    </div>
                    
                    <div id="category-links" class="tracking-links" style="display: none;">
                        <!-- Contextual links like ICAAP tracking -->
                    </div>

                    <div class="notes-section" id="standard-notes-view">
                        <div class="new-note-area">
                            <textarea id="new-note-content" placeholder="Type a new note here..." oninput="handleDraftInput()"></textarea>
                            <button class="save-btn" onclick="handleAddNote()">Add Note</button>
                            <div id="save-status" class="save-status">All changes saved</div>
                        </div>
                        <div id="entries-list" class="entries-list">
                            <!-- Entries will be loaded here -->
                        </div>
                    </div>

                    <div id="special-content-view" style="display: none;">
                        <!-- Specialized content like tables will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        /* Table styles for specialized views */
        .special-table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
            border: 1px solid #e1dfdd;
            border-radius: 4px;
        }
        .special-table {
            border-collapse: collapse;
            width: 100%;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .special-table th, .special-table td {
            border: 1px solid #eee;
            padding: 5px 8px;
            text-align: center;
            box-sizing: border-box;
        }
        .special-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #323130;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #e1dfdd;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .special-table td {
            font-family: 'Coming Soon', cursive;
            font-size: 0.85rem;
        }
        .special-table .text-left { text-align: left; }
        .special-table .sticky-col {
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 5;
            border-right: 2px solid #e1dfdd;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
            font-size: 0.75rem;
        }
        .special-table tr:hover { background: #fdfdfd; }
        .special-table tr:nth-child(even) { background: #fafafa; }
        
        .special-table input, .special-table select {
            width: 100%;
            height: 100%;
            border: none;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            text-align: inherit;
            padding: 0;
            outline: none;
        }
        .special-table input:focus, .special-table select:focus {
            background: #fffde7;
        }

        /* Checkbox styles for budget */
        .checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 50%;
            vertical-align: middle;
        }
        .checkbox.checked {
            background-color: #333 !important;
            position: relative;
        }
        .checkbox.checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
        }

        /* Row colors for budget */
        .row-auto { color: #2d8a2d; }
        .row-bill { color: #00326b; }
        .row-cash { color: #d14d9c; }
        .row-cc { color: #d68100; }
        .row-housing { color: #a33b3b; }
        .row-savings { color: #7a4da3; }

        /* Monthly Review Styles */
        .review-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        .review-box {
            background-color: #fffcf0;
            border: 1px solid #eee;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.02);
        }
        .review-box.wide {
            grid-column: span 2;
        }
        .box-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            font-family: 'Segoe UI', sans-serif;
        }
        .editable-area {
            min-height: 100px;
            font-size: 1.1rem;
            outline: none;
            line-height: 1.5;
            flex-grow: 1;
            font-family: 'Coming Soon', cursive;
        }
        .month-selector {
            font-family: 'Segoe UI', sans-serif;
            font-size: 1rem;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* Planner Shared Styles */
        :root {
            --sun-bg: #f59e9e;
            --mon-bg: #f6d2a2;
            --tue-bg: #a2d9d9;
            --wed-bg: #5a8ca0;
            --thu-bg: #f59e9e;
            --fri-bg: #f6d2a2;
            --sat-bg: #a2d9d9;
            --header-blue: #00326b;
        }

        .planner-container {
            width: 100%;
            font-family: 'Coming Soon', cursive;
        }

        .planner-header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #333;
        }

        .top-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }

        .top-section {
            border: 1px solid #eee;
            padding: 10px;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            background: #f9f9f9;
            padding: 2px 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .daily-columns {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #333;
        }

        .day-col {
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .day-col:last-child {
            border-right: none;
        }

        .day-header {
            text-align: center;
            padding: 5px;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 1px solid #333;
            color: #fff;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-slot {
            height: 40px;
            border-bottom: 1px dotted #ccc;
            display: flex;
            align-items: center;
            padding: 2px 5px;
            font-size: 0.65rem;
            position: relative;
            box-sizing: border-box;
        }

        .time-label {
            width: 40px;
            color: #888;
            font-size: 0.55rem;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .check-box {
            width: 14px;
            height: 14px;
            border: 1px solid #f59e9e;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }

        .check-box.checked::after {
            content: "‚úì";
            color: #f59e9e;
            font-size: 12px;
            font-weight: 600;
        }

        .slot-content {
            flex-grow: 1;
            outline: none;
            word-break: break-word;
            height: 100%;
            display: flex;
            align-items: center;
            overflow: hidden;
            padding-left: 2px;
        }

        .event-pill {
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 1px 3px;
            font-size: 0.7rem;
            line-height: 1;
            border: 1px solid #ccc;
            text-align: left;
            display: block;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .event-pill.csea, .event-pill.la-fed { 
            background-color: #00326b; 
            color: #ffca38; 
            border: 1px solid #ffca38; 
        }

        .event-pill.due { background-color: #ff0000; color: #fff; border: none; }
        .event-pill.meeting { border-left: 5px solid #a2d9d9; }
        .event-pill.pay-day { background-color: #1b5e20; color: #fff; font-weight: 600; text-transform: uppercase; border-radius: 4px; }
        .event-pill.budget { background-color: #408686; color: white; font-weight: 600; text-transform: uppercase; border-left: 10px solid #d4af37; border-radius: 4px; }

        /* Personal Planner Specific Styles */
        .habit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .habit-section {
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .habit-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .mini-week-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .mini-week-days {
            display: grid;
            grid-template-columns: repeat(7, 12px);
            gap: 5px;
        }

        .mini-day-box {
            width: 12px;
            height: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .mini-day-box.checked { background-color: #333 !important; position: relative; }
        .mini-day-box.checked::after { content: "‚úì"; color: white; font-size: 8px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .habit-label { font-size: 0.75rem; }
        .enjoy-banner { background-color: #f59e9e; color: white; text-align: center; font-size: 0.7rem; padding: 3px; margin: 10px 0; letter-spacing: 2px; }

        .sidebar-icon-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 2px;
            height: 25px;
        }
        .sidebar-icon {
            font-size: 0.9rem;
            width: 14px;
            height: 14px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .sidebar-line {
            flex-grow: 1;
            min-height: 20px;
            outline: none;
            display: flex;
            align-items: center;
        }

        /* Interaction Log Table Styles */
        .log-section {
            margin-top: 40px;
            overflow-x: auto;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Coming Soon', cursive;
            font-size: 0.8rem;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .log-table th {
            background-color: #2b579a;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }
        .log-table td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        .log-table tr:nth-child(even) { background-color: #f9f9f9; }
        .log-input-row td { background-color: #fffde7; }
        .log-input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 4px;
            box-sizing: border-box;
            font-family: 'Coming Soon', cursive;
            font-size: 0.8rem;
        }
        .add-log-btn {
            background-color: #2b579a;
            color: white;
            border: none;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 2px;
        }

        .sun-header, .sun { background: var(--sun-bg); }
        .mon-header, .mon { background: var(--mon-bg); }
        .tue-header, .tue { background: var(--tue-bg); }
        .wed-header, .wed { background: var(--wed-bg); }
        .thu-header, .thu { background: var(--thu-bg); }
        .fri-header, .fri { background: var(--fri-bg); }
        .sat-header, .sat { background: var(--sat-bg); }
    </style>

    <script>
        const sections = {
            work: {
                title: 'Work Notes',
                icon: 'üíº',
                pages: [
                    { id: 'Work-Planner', name: 'Work Planner', icon: 'üóìÔ∏è' },
                    { id: 'CSEA', name: 'CSEA', icon: 'üìí' },
                    { id: 'iCAAP', name: 'iCAAP', icon: 'üìã' },
                    { id: 'HOA', name: 'HOA', icon: 'üè†' }
                ]
            },
            personal: {
                title: 'Personal Notes',
                icon: 'üë§',
                pages: [
                    { id: 'Personal-Planner', name: 'Personal Planner', icon: 'üóìÔ∏è' },
                    { id: 'Goals', name: 'Goals', icon: 'üéØ' },
                    { id: 'Mantra', name: 'Mantra', icon: '‚ú®' }
                ]
            },
            planning: {
                title: 'Planning Notes',
                icon: 'üìÖ',
                pages: [
                    { id: 'Monthly-Review', name: 'Monthly Review', icon: 'üìä' },
                    { id: 'Intentions', name: 'Intentions & Dreams', icon: 'üí≠' }
                ]
            },
            financial: {
                title: 'Financial Notes',
                icon: 'üí∞',
                pages: [
                    { id: 'Budget', name: 'Budget Planning', icon: 'üè¶' },
                    { id: 'Check-Breakdown', name: 'Check Breakdown', icon: 'üìä' },
                    { id: 'Financial-Review', name: 'Financial Review', icon: 'üí∏' }
                ]
            }
        };

        const employees = [
            "Adalid Sanchez Rodriguez", "Adan Saucedo", "Adrian Irvine", "Adriana Gomez",
            "Adriana Ojeda", "Agnes Lewis", "Alberto Solorzano", "Alexander Aston",
            "Alexis Contreras", "Alice Hilal", "Alicia Cerna", "Aline Millan",
            "Alyson Han", "Amber Mastroianni", "Amber Trudgeon", "Amber Wilton",
            "Ameel Noos", "Amparo Martin", "Ana Guevara", "Ancelmo Ramos",
            "Andrea Chagoya", "Andrea Douglas", "Andreina Morales", "Angel Gamino",
            "Angela Lopez", "Anna Quezada", "Anthony Bernard", "Anthony Morales",
            "Anthony Zarate", "Antoinette Matiga", "Araksya Manukyan", "Avia Greene-Vanburen",
            "Aya Shigenaga", "Baharak Saadat Beheshti", "Barbara Stoliker", "Barry Blisten",
            "Beatris Segura", "Bennett Winter", "Bernice Grewell-Godinez", "Beverly Junio-Magee",
            "Bienvenido Pineda", "Brigette Pena", "Carmen Fuentes", "Cassondra Holt Hightower",
            "Cecille Basilio", "Charles Izuakor", "Cherie Lebron", "Chevon Booker",
            "Chinedu Ezeh", "Christa Mcmullin", "Christina Clark", "Christina Silva",
            "Christina Sithole", "Christine Choi", "Christopher Linares", "Claire Daigle",
            "Claudia Franco", "Connie Gracia-Barraza", "Crystal Cohen", "Crystal Mendez",
            "Crystal Rivera", "Cynthia Barrilleaux", "Cynthia Bitterman", "Cynthia Timm",
            "D.M. Grant", "Dalese Hardin", "Dana Fikes", "Daniel Saldana",
            "Danielle O'Connor", "David Hadjichristodoulou", "Dawn Sebastian", "Dawnise Francisco",
            "Deanna Baldwin", "Debora Wechsler", "Deborah Francois", "Diana Olivas",
            "Dominique Harris", "Dora Marquez", "Douglas Klaif", "Douglas Reisgen",
            "Dulce Bacon", "Eberardo Rodriguez", "Edith Braswell-Grant", "Edith Janec",
            "Efren Rodriguez", "Eileen Alcorn", "Eimi Miller", "Elisabeth Mullins Medina",
            "Elizabeth Chavez", "Elizabeth Elizalde", "Elizabeth Romero", "Emilee Velazco Franco",
            "Emily Wassler", "Emir Gonzalez", "Enas Makar", "Eric Hopson",
            "Erica Pan", "Erica Sanchez", "Erika Paz", "Erin Mettlen",
            "Ester Yang", "Evelyn Mcfarlane", "Farhad Mahmud", "Frances Morales",
            "Freshta Sidiqi", "Gavriela Trujillo", "Gene Dean", "Genesis Aguirre",
            "Gina Go", "Gladys Barbosa", "Glenda Tamay", "Guillermo Diaz",
            "Gustavo Lopez", "Hamilton Gernon-Wyatt", "Hector Martinez", "Hina Ahmad",
            "Ida Quijada", "Iliana Quintero", "Indira Ortiz", "Irma Griffiths",
            "Irma Salas", "Irma Torres", "Isidro Castillo", "Ivy Grace Thorne",
            "Jacqueline Cruz", "Jacqueline Palacios", "Jakeisha Sanders", "Jamall Farr",
            "Janet Frnzyan", "Janet Ledesma", "Jasmin Segovia", "Javier Ponce Garcia",
            "Jeanine Flier", "Jeanne Garcia-Armstrong", "Jeen Yu", "Jehisol Urbina",
            "Jennifer Lopez", "Jennifer Washington", "Jenny Peterson", "Jereme Stark",
            "Jhun De Guzman", "Jiabei Li", "Jittima Bouillot", "John Kuykendall",
            "Jordan Baldry", "Jordan Gonzalez", "Jorge Torres", "Jose Alvarenga",
            "Jose Hernandez", "Jose Romero", "Joseph Thomas", "Joseph Zeccola",
            "Joshua Griffiths", "Joy Kasper", "Juan Catalan", "Juan Pina",
            "Julia Calamandrei", "Julian Mendez", "Julianne Fassett", "Julie Ann Resurreccion",
            "Julie Sornberger", "Karen Caruso", "Karen Siercke Noriega", "Karina Maravilla",
            "Karsina Gaither", "Kelsie Hogen", "Kelvin Means", "Kerry Shimizu",
            "Kevin Seegan", "Kimberly Rabas", "Kionna Hawkins", "Kristalyn Smith",
            "Kristine Adams", "Kristy Beaudry", "La Tresha Glasco", "Ladan Dejam",
            "Lailani Joy Gonzaga", "Lanette Black", "Laura Incelli", "Laveda Harris",
            "Lawrence Ramos", "Leslie Anderson", "Leslie Black", "Leslie Perez",
            "Leslie Zamora", "Leticia Gudino", "Leticia Martinez", "Liberty Amos",
            "Lila Rosas Madrigal", "Liliana Amezcua", "Liliana Jauregui-George", "Liliana Martinez",
            "Lilit Akilian", "Linda Hoang", "Linda Santana", "Linda Taylor",
            "Lisa Darbidian", "Lisa Harvey", "Lisa Marks", "Louise Cummings",
            "Luciano Latini", "Lucrecia Yescas Luna", "Ma Joanna Razon", "Ma Teresa Aki",
            "Maeli Montecinos", "Maikai Finnell", "Malika Ferrell", "Malina Rios",
            "Mandana Saidi", "Maria Aldave Cabrera", "Maria Hernandez", "Maria Pinto",
            "Maria Zamora", "Marianne Valencia", "Marie Bennett", "Marissa Gilmore",
            "Marites Felicilda", "Mark Todd", "Marla Pizzuto", "Marlene Yu",
            "Marta Martin", "Mary Jane Opoku", "Matthew Miller", "Mayra Alcantar",
            "Mayra Rodarte-Nava", "Melanie Ronning", "Melinda Duran", "Michael Juarez",
            "Michelle Lopez", "Miguel Agredano", "Miisha Davis", "Miriam Oguejiofor",
            "Nancy Madrid", "Naomi Kaidin", "Nayeli Meza Amaral", "Neta Markusfeld",
            "Nicole Douglass", "Nicoli Ueda", "Nora Watanabe", "Nune Mc Combs",
            "Oscar Montenegro", "Palma Scirone", "Paola Martinez", "Patricia Castillo",
            "Patricia Chavez", "Patrick Navas", "Paula Dominguez", "Paulette Duarte",
            "Paulette Shelley", "Pedro Aguilar", "Praveen Ray", "Ralph Bravo",
            "Rana Khan", "Raquel Huerta", "Rebeca Chaidez", "Rene Gaudet",
            "Rhory Rebellon", "Richard Lee", "Rick Swanson", "Robert Jones",
            "Robert Moose", "Robin Aaron", "Rodolfo Gutierrez", "Rosalina Pacheco",
            "Rosalyn Lee", "Rosanna Davisson", "Rosemarie Fagfoomsintu", "Ross Kramer",
            "Ruth Rendon", "Ryan Boyes", "Sabrina Sheikh", "Sabrina Sullivan",
            "Sallyann Tejeda", "Salvador Magana-Arriola", "Sandra Canela", "Sandra Hernandez",
            "Sandra Meredith", "Sandra Mijarez", "Sandra Valdivia", "Sandy Estrada",
            "Sandy Walker", "Sara Goico Alcantar", "Scott Cody", "Senisa Austin",
            "Shannon Moultrie", "Shannon Sayer", "Sharon Maculada", "Shawn Hall",
            "Sherita Rogers", "Sheveeta Jackson", "Silvia Ramos", "Silvia Sanchez",
            "Sofia Manzo-Reyes", "Sofia Vasserman", "Stacey Byham", "Stacey Williams",
            "Staci Holmes", "Stacy Orosco", "Stephanie Harlow", "Stephen Maccarone",
            "Steven Vitela", "Suhjung Ko", "Susan Deloach", "Susan Nolan",
            "Susana Mislang", "Susana Santa Cruz", "Susanna Garcia", "Tacy Schull",
            "Tamryn Wilkins", "Tanya Acosta", "Tarah Bagadiong-Trice", "Tatianika Montalbo",
            "Tiffanie Griffin", "Tiffany Vojkovich", "Toby Sperber", "Tonya Boyd",
            "Tonya Thompson", "Troy Poe", "Valerie De La Rosa", "Valerie Hoggard",
            "Vanessa Sandoval", "Veganush Frnzyan", "Veronica Arevalo", "Veronica Rodriguez Sifontes",
            "Veronica Viramontes", "Victor Castaneda", "Victoria Maldonado", "Wendy Jasso",
            "Wendy Marrero", "Wendy Mora", "Xiaowei Wei", "Yasmin Lilly",
            "Yesenia Duran", "Yesenia Enriquez", "Yolanda Hashimoto", "Young Choy",
            "Yuriko Jung", "Zarui Grigoryan", "Zina Dixon"
        ];
        const attnOptions = ["", "Cochren", "Beaudry", "Illness", "Kin Care", "Personal Necessity", "Vacation", "Bereavement"];
        const monthNames = ['July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June'];

        const financialBills = [
            { id: 1, cat: 'Auto', item: 'Auto Maintenance', amt: '$100', class: 'row-auto' },
            { id: 2, cat: 'Auto', item: 'Mercury Auto Insurance', amt: '$388', class: 'row-auto' },
            { id: 3, cat: 'Auto', item: 'Tahoe Registration', amt: '$15', class: 'row-auto' },
            { id: 4, cat: 'Auto', item: 'Trailblazer Registration', amt: '$28', class: 'row-auto' },
            { id: 5, cat: 'Bill Pay', item: 'DWP', amt: '$100', class: 'row-bill' },
            { id: 6, cat: 'Bill Pay', item: 'Jeff\'s Credit Cards', amt: '$500', class: 'row-bill' },
            { id: 7, cat: 'Bill Pay', item: 'Jennifer\'s Student Loans', amt: '$150', class: 'row-bill' },
            { id: 8, cat: 'Bill Pay', item: 'Schools First Loan', amt: '$142', class: 'row-bill' },
            { id: 9, cat: 'Cash', item: 'Cleaning Lady', amt: '$320', class: 'row-cash' },
            { id: 10, cat: 'Cash', item: 'Gas', amt: '$600', class: 'row-cash' },
            { id: 11, cat: 'Cash', item: 'Laundry', amt: '$80', class: 'row-cash' },
            { id: 12, cat: 'Credit Card', item: 'ADT', amt: '$53', class: 'row-cc' },
            { id: 13, cat: 'Credit Card', item: 'Amazon', amt: '$100', class: 'row-cc' },
            { id: 14, cat: 'Credit Card', item: 'Groceries', amt: '$600', class: 'row-cc' },
            { id: 15, cat: 'Credit Card', item: 'Pest Control', amt: '$110', class: 'row-cc' },
            { id: 16, cat: 'Credit Card', item: 'Ring', amt: '$10', class: 'row-cc' },
            { id: 17, cat: 'Credit Card', item: 'Spectrum', amt: '$90', class: 'row-cc' },
            { id: 18, cat: 'Credit Card', item: 'The Athletic', amt: '$2', class: 'row-cc' },
            { id: 19, cat: 'Credit Card', item: 'Waste Management', amt: '$68', class: 'row-cc' },
            { id: 20, cat: 'Housing', item: 'Escrow (Tax & Ins)', amt: '$840', class: 'row-housing' },
            { id: 21, cat: 'Housing', item: 'HOA Fees', amt: '$440', class: 'row-housing' },
            { id: 22, cat: 'Housing', item: 'Mortgage', amt: '$1480', class: 'row-housing' },
            { id: 23, cat: 'Savings', item: 'Capital One Savings', amt: '$500', class: 'row-savings' }
        ];

        let currentSection = 'work';
        let currentCategory = 'CSEA';
        const entriesList = document.getElementById('entries-list');
        const newNoteContent = document.getElementById('new-note-content');
        const saveStatus = document.getElementById('save-status');
        const pageTitle = document.getElementById('page-title');
        const pageMeta = document.getElementById('page-meta');
        const categoryLinks = document.getElementById('category-links');
        let saveTimeout = null;

        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const displayDate = dateParam ? new Date(dateParam) : new Date();
        const currentYear = displayDate.getFullYear();
        const fiscalYear = displayDate.getMonth() < 6 ? displayDate.getFullYear() - 1 : displayDate.getFullYear();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            pageMeta.innerText = displayDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const catParam = urlParams.get('category');
            if (catParam) {
                // Find which section this category belongs to
                for (const sectionId in sections) {
                    if (sections[sectionId].pages.find(p => p.id === catParam) || 
                       (catParam.startsWith('ICAAP-') && sectionId === 'work')) {
                        currentCategory = catParam;
                        switchSection(sectionId);
                        return;
                    }
                }
            }
            switchSection('work');
        });

        function switchSection(sectionId) {
            currentSection = sectionId;
            
            // Update sidebar icons
            document.querySelectorAll('.section-icon').forEach(icon => {
                icon.classList.toggle('active', icon.title.toLowerCase() === sectionId);
            });

            // Update pages list
            const section = sections[sectionId];
            document.getElementById('sidebar-title').innerText = section.title;
            const pagesList = document.getElementById('pages-list');
            pagesList.innerHTML = '';
            
            section.pages.forEach(page => {
                const div = document.createElement('div');
                div.className = `page-tab ${currentCategory === page.id ? 'active' : ''}`;
                div.dataset.id = page.id;
                div.innerHTML = `<span>${page.icon}</span> ${page.name}`;
                div.onclick = () => switchTab(page.id);
                pagesList.appendChild(div);
            });

            // Switch to first page if current category is not in this section
            if (!section.pages.find(p => p.id === currentCategory) && 
                !(currentCategory.startsWith('ICAAP-') && sectionId === 'work')) {
                switchTab(section.pages[0].id);
            } else {
                switchTab(currentCategory);
            }
        }

        async function switchTab(category) {
            currentCategory = category;
            
            // Apply width constraint for specific categories
            const content = document.querySelector('.notepaper-content');
            if (category === 'Work-Planner') {
                content.classList.add('width-80');
            } else {
                content.classList.remove('width-80');
            }
            
            // Update page tabs - handle sub-pages by checking parent
            document.querySelectorAll('.page-tab').forEach(tab => {
                const isMatch = tab.dataset.id === category || 
                               (category.startsWith('ICAAP-') && tab.dataset.id === 'iCAAP');
                tab.classList.toggle('active', isMatch);
            });

            // Find page name
            let pageName = category;
            for (const s in sections) {
                const p = sections[s].pages.find(pg => pg.id === category);
                if (p) {
                    pageName = p.name;
                    break;
                }
            }

            // Fallback for sub-pages not in sidebar
            if (category === 'ICAAP-Tracking') pageName = 'iCAAP Tracking Log';
            if (category === 'ICAAP-Attendance') pageName = 'Attendance Tracking';

            const yearStr = (category.toLowerCase().includes('icaap')) ? `${fiscalYear}-${fiscalYear + 1}` : currentYear;
            pageTitle.innerText = `${pageName} ${yearStr}`;

            // Handle Hybrid Rendering
            const isSpecial = ['Work-Planner', 'Personal-Planner', 'ICAAP-Tracking', 'ICAAP-Attendance', 'Budget', 'Monthly-Review', 'Check-Breakdown', 'Intentions', 'Mantra', 'Goals'].includes(category);
            document.getElementById('standard-notes-view').style.display = isSpecial ? 'none' : 'block';
            document.getElementById('special-content-view').style.display = isSpecial ? 'block' : 'none';

            // Show contextual links for iCAAP family
            if (category === 'iCAAP' || category.startsWith('ICAAP-')) {
                renderIcaapLinks();
            } else {
                categoryLinks.style.display = 'none';
            }

            if (category === 'Work-Planner') {
                await renderWorkPlanner();
            } else if (category === 'Personal-Planner') {
                await renderPersonalPlanner();
            } else if (category === 'ICAAP-Tracking') {
                await renderIcaapTracking();
            } else if (category === 'ICAAP-Attendance') {
                await renderIcaapAttendance();
            } else if (category === 'Budget') {
                await renderBudget();
            } else if (category === 'Check-Breakdown') {
                await renderCheckBreakdown();
            } else if (category === 'Intentions') {
                await renderIntentions();
            } else if (category === 'Mantra') {
                await renderMantra();
            } else if (category === 'Goals') {
                await renderGoals();
            } else if (category === 'Monthly-Review') {
                await renderMonthlyReview();
            } else {
                await loadEntries();
                if (category === 'CSEA') {
                    await renderCseaLog();
                } else {
                    const existingLog = document.getElementById('csea-log-container');
                    if (existingLog) existingLog.remove();
                }
            }
        }

        function renderIcaapLinks() {
            categoryLinks.style.display = 'flex';
            const dateStr = displayDate.toISOString().split('T')[0];
            categoryLinks.innerHTML = `
                <a href="notebook.html?category=iCAAP&date=${dateStr}" class="tracking-link ${currentCategory === 'iCAAP' ? 'active' : ''}">üìù iCAAP Notes</a>
                <a href="notebook.html?category=ICAAP-Attendance&date=${dateStr}" class="tracking-link ${currentCategory === 'ICAAP-Attendance' ? 'active' : ''}">üë§ Attendance Tracking</a>
                <a href="notebook.html?category=ICAAP-Tracking&date=${dateStr}" class="tracking-link ${currentCategory === 'ICAAP-Tracking' ? 'active' : ''}">üìà iCAAP Tracking Log</a>
            `;
        }

        async function renderCseaLog() {
            categoryLinks.style.display = 'none';
            let logContainer = document.getElementById('csea-log-container');
            if (!logContainer) {
                logContainer = document.createElement('div');
                logContainer.id = 'csea-log-container';
                logContainer.className = 'log-section';
                document.getElementById('standard-notes-view').appendChild(logContainer);
            }

            logContainer.innerHTML = `
                <h2 class="page-title" style="font-size: 1.5rem; margin-top: 40px;">Member Interaction Log</h2>
                <div class="special-table-container">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Member</th>
                                <th>Location</th>
                                <th>Discussion</th>
                                <th>Action/Rep</th>
                                <th>Outcome</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="interaction-log-body"></tbody>
                        <tfoot>
                            <tr class="log-input-row">
                                <td><input type="date" id="log-date" class="log-input"></td>
                                <td><input type="text" id="log-member" class="log-input" placeholder="Name" list="members-list"><datalist id="members-list"></datalist></td>
                                <td><input type="text" id="log-location" class="log-input" placeholder="Location" list="schools-list"><datalist id="schools-list"></datalist></td>
                                <td><input type="text" id="log-discussion" class="log-input" placeholder="Discussion" list="issues-list"><datalist id="issues-list"></datalist></td>
                                <td><input type="text" id="log-contact" class="log-input" placeholder="Rep" list="stewards-list"><datalist id="stewards-list"></datalist></td>
                                <td><input type="text" id="log-outcome" class="log-input" placeholder="Outcome"></td>
                                <td><button class="add-log-btn" onclick="handleAddInteraction()">Add</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            // Load interactions
            const interactions = await fetchInteractions(getCategory('CSEA'));
            const tbody = document.getElementById('interaction-log-body');
            interactions.forEach(inter => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDateMMM(inter.date_spoke)}</td>
                    <td>${inter.member_name}</td>
                    <td>${inter.work_location}</td>
                    <td>${inter.discussion}</td>
                    <td>${inter.contact_person || ''}</td>
                    <td>${inter.outcome || ''}</td>
                    <td><span class="delete-btn" onclick="handleDeleteInteraction(${inter.id})">Delete</span></td>
                `;
                tbody.appendChild(tr);
            });

            // Populate datalists
            const [members, stewards, issues, schools] = await Promise.all([
                fetchCseaMembers(),
                fetchCseaStewards(),
                fetchCseaIssues(),
                fetchSchoolDirectory()
            ]);
            
            document.getElementById('members-list').innerHTML = members.map(m => `<option value="${m.name}">`).join('');
            document.getElementById('stewards-list').innerHTML = stewards.map(s => `<option value="${s.name}">`).join('');
            document.getElementById('issues-list').innerHTML = issues.map(i => `<option value="${i.issue_name}">`).join('');
            document.getElementById('schools-list').innerHTML = schools.map(s => `<option value="${s.site_name}">`).join('');

            document.getElementById('log-member').oninput = (e) => {
                const member = members.find(m => m.name === e.target.value);
                if (member) document.getElementById('log-location').value = member.work_location;
            };
        }

        async function handleAddInteraction() {
            const interaction = {
                date_spoke: document.getElementById('log-date').value,
                member_name: document.getElementById('log-member').value,
                work_location: document.getElementById('log-location').value,
                discussion: document.getElementById('log-discussion').value,
                contact_person: document.getElementById('log-contact').value,
                outcome: document.getElementById('log-outcome').value
            };

            if (!interaction.date_spoke || !interaction.member_name) {
                alert('Date and Member Name are required');
                return;
            }

            saveStatus.innerText = 'Saving...';
            const result = await saveInteraction(getCategory('CSEA'), interaction);
            if (result) {
                saveStatus.innerText = 'All changes saved';
                await renderCseaLog();
            } else {
                saveStatus.innerText = 'Error saving';
            }
        }

        async function handleDeleteInteraction(id) {
            if (confirm('Delete this interaction?')) {
                const success = await deleteInteraction(id);
                if (success) await renderCseaLog();
            }
        }

        const billAmounts = {
            "Auto Maintenance": "$100.00",
            "Mercury Auto Insurance": "$388.00",
            "Tahoe Registration": "$15.00",
            "Trailblazer Registration": "$28.00",
            "DWP": "$100.00",
            "Jeff's Credit Cards": "$500.00",
            "Jennifer's Student Loans - Sallie Mae": "$500.00",
            "Sallie Mae": "$500.00",
            "Schools First Loan": "$142.00",
            "Jennifer's Student Loans - NelNet": "$600.00",
            "NelNet": "$600.00",
            "Ana": "$320.00",
            "Gas": "$600.00",
            "Laundry": "$80.00",
            "Groceries": "$600.00",
            "ADT": "$53.00",
            "Amazon - Necessities": "$100.00",
            "Amazon": "$100.00",
            "Hair (Expensive)": "$110.00",
            "Orkin": "$50.00",
            "Hair (Cheap)": "$50.00",
            "HELOC": "$357.00",
            "Hoa": "$520.00",
            "Mortgage": "$2,025.00",
            "Spectrum": "$197.00",
            "Verizon": "$283.00",
            "Blow": "$200.00",
            "HSA": "$200.00",
            "Summer Saver": "$400.00",
            "Tahoe's Major Repairs": "$200.00",
            "Vacation": "$125.00",
            "Schools First Credit Card": "$100.00",
            "Paramount+": "$12.99",
            "Taxes": "$TBD"
        };

        async function renderWorkPlanner() {
            const container = document.getElementById('special-content-view');
            const weekEnd = new Date(displayDate);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            container.innerHTML = `
                <div class="planner-container">
                    <div class="planner-header">
                        <div style="font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">
                            ${formatDateMMM(displayDate.toISOString().split('T')[0])} - ${formatDateMMM(weekEnd.toISOString().split('T')[0])}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 5px 0;">
                            <button class="save-btn" onclick="changePlannerWeek(-7)">Prev Week</button>
                            <h2 style="margin: 0; color: var(--header-blue); font-family: 'Plus Jakarta Sans', sans-serif;">WORK PLANNER</h2>
                            <button class="save-btn" onclick="changePlannerWeek(7)">Next Week</button>
                        </div>
                    </div>
                    <div class="top-grid">
                        <div class="top-section">
                            <div class="section-title">Priority #1</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="priority-1" data-field="priority-1"></div>
                        </div>
                        <div class="top-section">
                            <div class="section-title">Priority #2</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="priority-2" data-field="priority-2"></div>
                        </div>
                        <div class="top-section">
                            <div class="section-title">Priority #3</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="priority-3" data-field="priority-3"></div>
                        </div>
                        <div class="top-section">
                            <div class="section-title">One thing I'm looking forward to</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="looking-forward" data-field="looking-forward"></div>
                        </div>
                        <div class="top-section">
                            <div class="section-title">Someone I can encourage</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="encourage" data-field="encourage"></div>
                        </div>
                        <div class="top-section">
                            <div class="section-title">Something I'd like to read/listen to</div>
                            <div class="editable-area planner-edit" contenteditable="true" id="read-listen" data-field="read-listen"></div>
                        </div>
                    </div>
                    <div id="planner-columns" class="daily-columns"></div>
                </div>
            `;

            const columnsContainer = document.getElementById('planner-columns');
            const timeSlots = [];
            for (let h = 6; h <= 21; h++) { timeSlots.push(`${h}:00`, `${h}:30`); }
            timeSlots.push('22:00');

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

            const [events, plannerData] = await Promise.all([
                fetchCalendarEvents(displayDate),
                fetchPlannerData(displayDate)
            ]);

            // Top Priorities
            const startStr = displayDate.toISOString().split('T')[0];
            plannerData.forEach(item => {
                if (item.date === startStr) {
                    const el = container.querySelector(`#${item.field_id}`);
                    if (el && !item.field_id.startsWith('slot-')) el.innerText = item.content;
                }
            });

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(displayDate);
                dayDate.setDate(dayDate.getDate() + i);
                const dayStr = dayDate.toISOString().split('T')[0];
                const dayEvents = events.filter(e => e.date === dayStr);
                
                const dayCol = document.createElement('div');
                dayCol.className = 'day-col';
                dayCol.innerHTML = `<div class="day-header ${dayClasses[i]}-header">${dayNames[i].substring(0,3).toUpperCase()}<br>${formatDateMMM(dayStr).toUpperCase()}</div>`;
                
                timeSlots.forEach(slot => {
                    const isChecked = plannerData.some(d => d.date === dayStr && d.field_id === `check-slot-${slot}` && d.content === 'true');
                    const saved = plannerData.find(d => d.date === dayStr && d.field_id === `slot-${slot}`);
                    const eventTitle = getEventForSlot(dayEvents, slot, i);

                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.innerHTML = `
                        <div class="time-label">${formatTime(slot, true)}</div>
                        <div class="check-box${isChecked ? ' checked' : ''}" onclick="togglePlannerCheck(this, '${dayStr}', 'check-slot-${slot}')"></div>
                        <div class="slot-content ${eventTitle ? '' : 'planner-edit'}" 
                             ${eventTitle ? '' : 'contenteditable="true"'} 
                             data-field="slot-${slot}" data-date="${dayStr}">
                            ${eventTitle ? `<div class="${getEventClass(eventTitle)}">${eventTitle}</div>` : (saved ? saved.content : '')}
                        </div>
                    `;
                    dayCol.appendChild(slotDiv);
                });
                columnsContainer.appendChild(dayCol);
            }

            container.querySelectorAll('.planner-edit').forEach(el => {
                el.oninput = (e) => handlePlannerInput(e.target);
            });
        }

        async function renderPersonalPlanner() {
            const container = document.getElementById('special-content-view');
            const weekEnd = new Date(displayDate);
            weekEnd.setDate(weekEnd.getDate() + 6);

            container.innerHTML = `
                <div class="planner-container">
                    <div class="planner-header">
                        <div style="font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">
                            ${formatDateMMM(displayDate.toISOString().split('T')[0])} - ${formatDateMMM(weekEnd.toISOString().split('T')[0])}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 5px 0;">
                            <button class="save-btn" onclick="changePlannerWeek(-7)">Prev Week</button>
                            <h2 style="margin: 0; color: var(--header-blue); font-family: 'Plus Jakarta Sans', sans-serif;">PERSONAL PLANNER</h2>
                            <button class="save-btn" onclick="changePlannerWeek(7)">Next Week</button>
                        </div>
                    </div>
                    <div class="habit-grid">
                        ${renderHabitSection('Home Care', ['Make beds', 'Ana - Cleaning', 'Recycling'])}
                        ${renderHabitSection('Self Care', ['Shower', 'Read', 'Bring lunch to work'])}
                        ${renderHabitSection('Week days', ['Get up at 5:00 am', 'Leave work at 3:30 pm', 'Take train to work', 'Listen to Bible app'])}
                        ${renderHabitSection('Weekends', ['Get up at 7:00 am', 'Plan/prep meals for the week', 'Laundry'])}
                    </div>
                    <div class="enjoy-banner">üè† ‚ù§ ENJOY YOUR FAMILY ‚ù§ üè†</div>
                    <div id="personal-days-container"></div>
                </div>
            `;

            const daysContainer = document.getElementById('personal-days-container');
            const [events, plannerData] = await Promise.all([
                fetchCalendarEvents(displayDate),
                fetchPlannerData(displayDate)
            ]);

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayClasses = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

            // Habit Checks
            container.querySelectorAll('.mini-day-box').forEach(box => {
                const { field, date } = box.dataset;
                const isChecked = plannerData.some(d => d.date === date && d.field_id === field && d.content === 'true');
                if (isChecked) box.classList.add('checked');
            });

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(displayDate);
                dayDate.setDate(dayDate.getDate() + i);
                const dayStr = dayDate.toISOString().split('T')[0];
                const dayEvents = events.filter(e => e.date === dayStr);

                const dayDiv = document.createElement('div');
                dayDiv.style.marginBottom = '20px';
                dayDiv.innerHTML = `
                    <div class="day-header ${dayClasses[i]}" style="margin-bottom: 10px;">
                        ${dayNames[i].toUpperCase()} - ${formatDateMMM(dayStr).toUpperCase()}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                        <div style="border-right: 1px solid #eee; padding-right: 15px;">
                            <div class="section-title">Focus</div>
                            <div class="sidebar-line planner-edit" contenteditable="true" data-field="focus" data-date="${dayStr}">
                                ${plannerData.find(d => d.date === dayStr && d.field_id === 'focus')?.content || ''}
                            </div>
                            <div class="sidebar-icon-row">
                                <div class="sidebar-icon">üè†</div>
                                <div class="sidebar-line planner-edit" contenteditable="true" data-field="home" data-date="${dayStr}">
                                    ${plannerData.find(d => d.date === dayStr && d.field_id === 'home')?.content || ''}
                                </div>
                            </div>
                            <div class="sidebar-icon-row">
                                <div class="sidebar-icon">üë§</div>
                                <div class="sidebar-line planner-edit" contenteditable="true" data-field="self" data-date="${dayStr}">
                                    ${plannerData.find(d => d.date === dayStr && d.field_id === 'self')?.content || ''}
                                </div>
                            </div>
                            <div class="sidebar-icon-row">
                                <div class="sidebar-icon">üõí</div>
                                <div class="sidebar-line planner-edit" contenteditable="true" data-field="shop" data-date="${dayStr}">
                                    ${plannerData.find(d => d.date === dayStr && d.field_id === 'shop')?.content || ''}
                                </div>
                            </div>
                            <div class="sidebar-icon-row">
                                <div class="sidebar-icon">üçΩÔ∏è</div>
                                <div class="sidebar-line planner-edit" contenteditable="true" data-field="meal" data-date="${dayStr}">
                                    ${plannerData.find(d => d.date === dayStr && d.field_id === 'meal')?.content || ''}
                                </div>
                            </div>
                            <div class="section-title" style="margin-top:10px;">Events</div>
                            <div style="font-size: 0.8rem;">
                                ${dayEvents.map(e => `<div class="${getEventClass(e.title)}">${e.title}</div>`).join('')}
                            </div>
                        </div>
                        <div>
                            <div class="section-title">Tasks</div>
                            ${[1,2,3,4,5,6].map(num => {
                                const fieldId = `task-${num}`;
                                const isChecked = plannerData.some(d => d.date === dayStr && d.field_id === `check-${fieldId}` && d.content === 'true');
                                const saved = plannerData.find(d => d.date === dayStr && d.field_id === fieldId);
                                return `
                                    <div class="mini-week-row">
                                        <div class="check-box${isChecked ? ' checked' : ''}" onclick="togglePlannerCheck(this, '${dayStr}', 'check-${fieldId}')"></div>
                                        <div class="editable-task planner-edit" contenteditable="true" data-field="${fieldId}" data-date="${dayStr}">
                                            ${saved ? saved.content : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                daysContainer.appendChild(dayDiv);
            }

            container.querySelectorAll('.planner-edit').forEach(el => {
                el.oninput = (e) => handlePlannerInput(e.target);
            });
        }

        function renderHabitSection(title, habits) {
            return `
                <div class="habit-section">
                    <div class="habit-title">${title}</div>
                    ${habits.map(habit => {
                        const habitId = habit.toLowerCase().replace(/\s+/g, '-');
                        return `
                            <div class="mini-week-row">
                                <div class="mini-week-days">
                                    ${[0,1,2,3,4,5,6].map(i => {
                                        const d = new Date(displayDate);
                                        d.setDate(d.getDate() + i);
                                        const dStr = d.toISOString().split('T')[0];
                                        const classes = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                                        return `<div class="mini-day-box ${classes[i]}" data-field="habit-${habitId}" data-date="${dStr}" onclick="togglePlannerCheck(this, '${dStr}', 'habit-${habitId}')"></div>`;
                                    }).join('')}
                                </div>
                                <span class="habit-label">${habit}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function getEventForSlot(dayEvents, timeSlot, dayIndex) {
            const [h, m] = timeSlot.split(':').map(Number);
            const slotTotalMinutes = h * 60 + m;
            const exactMatch = dayEvents.find(e => {
                if (!e.time) return false;
                const [eh, em] = e.time.split(':').map(Number);
                return (eh * 60 + em) === slotTotalMinutes;
            });
            if (exactMatch) return exactMatch.title;
            const chapterEvent = dayEvents.find(e => e.title.toUpperCase().includes('CHAPTER'));
            if (chapterEvent && slotTotalMinutes >= (17 * 60 + 30) && slotTotalMinutes < (19 * 60 + 30)) return chapterEvent.title;
            const stewardEvent = dayEvents.find(e => e.title.toUpperCase().includes('STEWARD'));
            if (stewardEvent && slotTotalMinutes >= (16 * 60) && slotTotalMinutes < (17 * 60)) return stewardEvent.title;
            const laFedEvent = dayEvents.find(e => e.title.toUpperCase().includes('LA FED'));
            if (laFedEvent && slotTotalMinutes >= (19 * 60) && slotTotalMinutes < (20 * 60)) return laFedEvent.title;
            return null;
        }

        async function handlePlannerInput(el) {
            const fieldId = el.dataset.field;
            const date = el.dataset.date || displayDate.toISOString().split('T')[0];
            const content = el.innerText;
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await savePlannerData(date, fieldId, content);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        async function togglePlannerCheck(el, date, fieldId) {
            el.classList.toggle('checked');
            const content = el.classList.contains('checked') ? 'true' : 'false';
            saveStatus.innerText = 'Saving...';
            const success = await savePlannerData(date, fieldId, content);
            saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
        }

        function changePlannerWeek(delta) {
            displayDate.setDate(displayDate.getDate() + delta);
            const dateStr = displayDate.toISOString().split('T')[0];
            const newUrl = `notebook.html?category=${currentCategory}&date=${dateStr}`;
            window.history.pushState({ category: currentCategory, date: dateStr }, '', newUrl);
            switchTab(currentCategory);
        }

        // iCAAP Tracking Implementation
        async function renderIcaapTracking() {
            const container = document.getElementById('special-content-view');
            const PERSISTENCE_KEY = `icaap-tracking-data-${fiscalYear}`;
            
            container.innerHTML = `
                <div class="special-table-container">
                    <table class="special-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="sticky-col">Employee Name</th>
                                ${monthNames.map(m => `<th colspan="3">${m} ${m === 'July' || m === 'August' || m === 'September' || m === 'October' || m === 'November' || m === 'December' ? fiscalYear : fiscalYear + 1}</th>`).join('')}
                                <th rowspan="2">Total Hours</th>
                            </tr>
                            <tr>
                                ${monthNames.map(() => `<th>Paylog</th><th>Hours</th><th>Appr.</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="tracking-table-body"></tbody>
                    </table>
                </div>
            `;

            const tbody = document.getElementById('tracking-table-body');
            employees.forEach((emp, eIdx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="sticky-col text-left">${emp}</td>`;
                monthNames.forEach((month, mIdx) => {
                    ['paylog', 'hours', 'approval'].forEach(type => {
                        const fieldId = `icaap-${mIdx}-${eIdx}-${type}`;
                        tr.innerHTML += `<td contenteditable="true" class="tracking-cell" data-field="${fieldId}" data-type="${type}" data-emp="${emp}" data-month="${month}"></td>`;
                    });
                });
                tr.innerHTML += `<td class="total-hours-cell" id="total-${eIdx}"></td>`;
                tbody.appendChild(tr);
            });

            // Data Loading
            const [hoursData, approvalData, paylogData] = await Promise.all([
                fetchHoursWorked(fiscalYear),
                fetchApprovalDates(fiscalYear),
                fetchPaylogSubmissions(fiscalYear)
            ]);

            const hoursMap = {}; hoursData.forEach(r => hoursMap[r.name.toLowerCase()] = r);
            const approvalMap = {}; approvalData.forEach(r => approvalMap[r.Name.toLowerCase()] = r);
            const paylogMap = {}; paylogData.forEach(r => paylogMap[r.name.toLowerCase()] = r);

            document.querySelectorAll('.tracking-cell').forEach(cell => {
                const { type, emp, month } = cell.dataset;
                const lowerEmp = emp.toLowerCase();
                const mKey = month.toLowerCase().substring(0, 3);
                
                if (type === 'hours') {
                    if (hoursMap[lowerEmp] && hoursMap[lowerEmp][mKey]) cell.innerText = hoursMap[lowerEmp][mKey];
                } else if (type === 'approval') {
                    if (approvalMap[lowerEmp] && approvalMap[lowerEmp][month.substring(0,3)]) cell.innerText = approvalMap[lowerEmp][month.substring(0,3)];
                } else if (type === 'paylog') {
                    if (paylogMap[lowerEmp] && paylogMap[lowerEmp][mKey]) cell.innerText = paylogMap[lowerEmp][mKey];
                }

                cell.oninput = (e) => handleTrackingSave(e.target);
            });

            // Calculate Totals
            employees.forEach((emp, eIdx) => calculateEmployeeTotal(eIdx));
        }

        async function handleTrackingSave(cell) {
            const { type, emp, month } = cell.dataset;
            const content = cell.innerText;
            saveStatus.innerText = 'Saving...';
            
            let table = '';
            if (type === 'hours') table = 'hours_worked';
            else if (type === 'approval') table = 'approval_dates';
            else if (type === 'paylog') table = 'paylog_submission';

            const success = await saveTrackingData(table, emp, month, content, fiscalYear);
            if (success && type === 'hours') {
                const eIdx = employees.indexOf(emp);
                calculateEmployeeTotal(eIdx);
            }
            saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
        }

        function calculateEmployeeTotal(eIdx) {
            let total = 0;
            document.querySelectorAll(`[data-field$="-${eIdx}-hours"]`).forEach(cell => {
                total += parseFloat(cell.innerText) || 0;
            });
            document.getElementById(`total-${eIdx}`).innerText = total || '';
        }

        // iCAAP Attendance Implementation
        let attendanceStartDate = new Date(displayDate);
        // Adjust to Monday
        const day = attendanceStartDate.getDay();
        const diff = attendanceStartDate.getDate() - day + (day === 0 ? -6 : 1);
        attendanceStartDate.setDate(diff);

        async function renderIcaapAttendance() {
            const container = document.getElementById('special-content-view');
            const weekdays = [];
            const tempDate = new Date(attendanceStartDate);
            for (let i = 0; i < 5; i++) {
                weekdays.push(new Date(tempDate));
                tempDate.setDate(tempDate.getDate() + 1);
            }

            const startStr = weekdays[0].toISOString().split('T')[0];
            const endStr = weekdays[4].toISOString().split('T')[0];

            container.innerHTML = `
                <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 15px; justify-content: center;">
                    <button class="save-btn" onclick="changeAttendanceWeek(-1)">Prev Week</button>
                    <span style="font-weight: 600;">${formatDateMMM(startStr)} - ${formatDateMMM(endStr)}</span>
                    <button class="save-btn" onclick="changeAttendanceWeek(1)">Next Week</button>
                </div>
                <div class="special-table-container">
                    <table class="special-table">
                        <thead>
                            <tr>
                                <th class="sticky-col">Employee Name</th>
                                ${weekdays.map(d => `<th>${d.toLocaleDateString('en-US', { weekday: 'short' })}<br>${formatDateMMM(d.toISOString().split('T')[0])}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body"></tbody>
                    </table>
                </div>
            `;

            const tbody = document.getElementById('attendance-table-body');
            const attnEmployees = ["Bonnie Ratner", "Eberardo Rodriguez", "Maikai Finnell", "Patricia Pernin", "Rene Gaudet", "Steve Maccarone", "Zina Dixon"];
            
            attnEmployees.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="sticky-col text-left">${emp}</td>`;
                weekdays.forEach(d => {
                    const dateKey = d.toISOString().split('T')[0];
                    const fieldId = `attn-${emp}-${dateKey}`;
                    tr.innerHTML += `<td>
                        <select class="attendance-select" data-field="${fieldId}" onchange="handleAttendanceSave(this)">
                            ${attnOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </td>`;
                });
                tbody.appendChild(tr);
            });

            // Load Attendance Data
            const persistenceKey = `icaap-attendance-data-${fiscalYear}`;
            const data = await fetchPlannerData(persistenceKey, 366);
            data.forEach(item => {
                const el = container.querySelector(`[data-field="${item.field_id}"]`);
                if (el) el.value = item.content;
            });
        }

        async function handleAttendanceSave(select) {
            const fieldId = select.dataset.field;
            const content = select.value;
            saveStatus.innerText = 'Saving...';
            const persistenceKey = `icaap-attendance-data-${fiscalYear}`;
            const success = await savePlannerData(persistenceKey, fieldId, content);
            saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
        }

        async function changeAttendanceWeek(delta) {
            attendanceStartDate.setDate(attendanceStartDate.getDate() + (delta * 7));
            await renderIcaapAttendance();
        }

        // Financial Budget Implementation
        async function renderBudget() {
            const container = document.getElementById('special-content-view');
            const fiscalMonths = ['J','F','M','A','M','J','J','A','S','O','N','D'];
            
            container.innerHTML = `
                <div class="special-table-container">
                    <table class="special-table bill-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Category</th>
                                <th style="width: 200px;">Item</th>
                                <th style="width: 80px;">Amount</th>
                                ${fiscalMonths.map(m => `<th style="width: 30px;">${m}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="budget-table-body"></tbody>
                    </table>
                </div>
            `;

            const tbody = document.getElementById('budget-table-body');
            financialBills.forEach(bill => {
                const tr = document.createElement('tr');
                tr.className = bill.class;
                let rowHtml = `
                    <td contenteditable="true" data-field="cat-${bill.id}" class="budget-edit">${bill.cat}</td>
                    <td contenteditable="true" data-field="item-${bill.id}" class="budget-edit text-left">${bill.item}</td>
                    <td contenteditable="true" data-field="amt-${bill.id}" class="budget-edit">${bill.amt}</td>
                `;
                for (let i = 1; i <= 12; i++) {
                    const fieldId = `chk-${bill.id}-${i}`;
                    rowHtml += `<td><div class="checkbox" data-field="${fieldId}" onclick="handleBudgetCheckbox(this)"></div></td>`;
                }
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });

            // Load Data
            const persistenceKey = `financial-data-${currentYear}`;
            const data = await fetchPlannerData(persistenceKey, 366);
            data.forEach(item => {
                const el = container.querySelector(`[data-field="${item.field_id}"]`);
                if (el) {
                    if (el.classList.contains('checkbox')) {
                        if (item.content === 'true') el.classList.add('checked');
                    } else {
                        el.innerText = item.content;
                    }
                }
            });

            // Add edit listeners
            container.querySelectorAll('.budget-edit').forEach(el => {
                el.oninput = (e) => handleBudgetEdit(e.target);
            });
        }

        async function handleBudgetCheckbox(el) {
            el.classList.toggle('checked');
            const fieldId = el.dataset.field;
            const content = el.classList.contains('checked') ? 'true' : 'false';
            saveStatus.innerText = 'Saving...';
            const persistenceKey = `financial-data-${currentYear}`;
            const success = await savePlannerData(persistenceKey, fieldId, content);
            saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
        }

        async function handleBudgetEdit(el) {
            const fieldId = el.dataset.field;
            const content = el.innerText;
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const persistenceKey = `financial-data-${currentYear}`;
                const success = await savePlannerData(persistenceKey, fieldId, content);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        // Monthly Review Implementation
        let selectedReviewMonth = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}`;

        async function renderMonthlyReview() {
            const container = document.getElementById('special-content-view');
            container.innerHTML = `
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <input type="month" id="review-month-picker" class="month-selector" value="${selectedReviewMonth}" onchange="handleReviewMonthChange(this)">
                </div>
                <div class="review-grid">
                    <div class="review-box">
                        <div class="box-title">What was your biggest win this month?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-win" data-field="review-win"></div>
                    </div>
                    <div class="review-box">
                        <div class="box-title">What do you wish you'd done differently?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-different" data-field="review-different"></div>
                    </div>
                    <div class="review-box wide">
                        <div class="box-title">What did you do that was fun?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-fun" data-field="review-fun"></div>
                    </div>
                    <div class="review-box">
                        <div class="box-title">What change did you make that you want to continue?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-change" data-field="review-change"></div>
                    </div>
                    <div class="review-box">
                        <div class="box-title">What did you manage well?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-manage" data-field="review-manage"></div>
                    </div>
                    <div class="review-box">
                        <div class="box-title">What's your biggest goal for next month?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-goal" data-field="review-goal"></div>
                    </div>
                    <div class="review-box">
                        <div class="box-title">What are you looking forward to?</div>
                        <div class="editable-area review-edit" contenteditable="true" id="review-forward" data-field="review-forward"></div>
                    </div>
                </div>
            `;

            const dateKey = `${selectedReviewMonth}-01`;
            const data = await fetchPlannerData(dateKey, 31);
            data.forEach(item => {
                if (item.date === dateKey) {
                    const el = container.querySelector(`#${item.field_id}`);
                    if (el) el.innerText = item.content;
                }
            });

            container.querySelectorAll('.review-edit').forEach(el => {
                el.oninput = (e) => handleReviewEdit(e.target);
            });
        }

        async function handleReviewMonthChange(picker) {
            selectedReviewMonth = picker.value;
            await renderMonthlyReview();
        }

        async function handleReviewEdit(el) {
            const fieldId = el.id;
            const content = el.innerText;
            const dateKey = `${selectedReviewMonth}-01`;
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await savePlannerData(dateKey, fieldId, content);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        function getPersistenceKey(cat) {
            const year = cat.toLowerCase().includes('icaap') ? fiscalYear : currentYear;
            return `draft-note-${cat.toLowerCase()}-${year}`;
        }

        function getCategory(cat) {
            const year = cat.toLowerCase().includes('icaap') ? fiscalYear : currentYear;
            return `${cat}-${year}`;
        }

        function createEntryElement(entry) {
            const div = document.createElement('div');
            div.className = 'note-entry';
            div.id = `entry-${entry.id}`;
            const datePart = entry.created_at.split('T')[0];
            const timePart = new Date(entry.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            div.innerHTML = `
                <div class="entry-header">
                    <span>${formatDateMMM(datePart)} ${timePart}</span>
                    <span class="delete-btn" onclick="handleDeleteNote(${entry.id})">Delete</span>
                </div>
                <div class="entry-content" contenteditable="true" oninput="handleEditNote(event, ${entry.id})">${entry.content}</div>
            `;
            return div;
        }

        async function loadEntries() {
            saveStatus.innerText = 'Loading...';
            const entries = await fetchCategoryEntries(getCategory(currentCategory));
            entriesList.innerHTML = '';
            entries.forEach(entry => {
                entriesList.appendChild(createEntryElement(entry));
            });

            // Load draft
            const draft = await fetchPlannerData(getPersistenceKey(currentCategory), 1);
            if (draft && draft.length > 0) {
                newNoteContent.value = draft[0].content;
            } else {
                newNoteContent.value = '';
            }
            saveStatus.innerText = 'All changes saved';
        }

        function handleDraftInput() {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await savePlannerData(getPersistenceKey(currentCategory), 'draft', newNoteContent.value);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        async function handleAddNote() {
            const content = newNoteContent.value.trim();
            if (!content) return;

            saveStatus.innerText = 'Saving...';
            const entry = await saveCategoryEntry(getCategory(currentCategory), content);
            if (entry) {
                newNoteContent.value = '';
                // Clear draft
                await savePlannerData(getPersistenceKey(currentCategory), 'draft', '');
                await loadEntries();
                saveStatus.innerText = 'Note added';
            }
        }

        async function handleEditNote(e, id) {
            saveStatus.innerText = 'Unsaved changes';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveStatus.innerText = 'Saving...';
                const success = await updateCategoryEntry(id, e.target.innerText);
                saveStatus.innerText = success ? 'All changes saved' : 'Error saving';
            }, 1000);
        }

        async function handleDeleteNote(id) {
            if (!confirm('Delete this note?')) return;
            const success = await deleteCategoryEntry(id);
            if (success) {
                document.getElementById(`entry-${id}`).remove();
                saveStatus.innerText = 'Note deleted';
            }
        }
    </script>
</body>
</html>
